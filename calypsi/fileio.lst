###############################################################################
#                                                                             #
# Calypsi ISO C compiler for 6502                                version 5.12 #
#                                                       07/Nov/2025  20:26:21 #
# Command line:                                                               #
#               --list-file=F:\Entwicklungsprojekte\github-nobru\midnightmega\calypsi\fileio.lst #
#               -D asm=__asm -I calypsi.h -D VERSION="v0.6.6-beta" -I         #
#               ..\mega65-libc\include -O 2 --core 45gs02 --target MEGA65     #
#               -D FULLFEATURES -o                                            #
#               F:\Entwicklungsprojekte\github-nobru\midnightmega\calypsi\fileio.o #
#               fileio.c                                                      #
#                                                                             #
###############################################################################

    \ 0000                      .rtmodel version,"1"
    \ 0000                      .rtmodel codeModel,"plain"
    \ 0000                      .rtmodel core,"45gs02"
    \ 0000                      .rtmodel target,"mega65"
    \ 0000                      .extern _AllocStackSave
    \ 0000                      .extern _DeallocStackRestore
    \ 0000                      .extern _DecVsp
    \ 0000                      .extern _DivMod16
    \ 0000                      .extern _FillQ
    \ 0000                      .extern _FillZP
    \ 0000                      .extern _IncVsp
    \ 0000                      .extern _LoadVspEA
    \ 0000                      .extern _MoveLong16X
    \ 0000                      .extern _RestoreRegisters
    \ 0000                      .extern _SpillZP
    \ 0000                      .extern _UDivMod16
    \ 0000                      .extern _Vfp
    \ 0000                      .extern _Vsp
    \ 0000                      .extern _Zp
    \ 0000                      .extern bordercolor
    \ 0000                      .extern cgetcd
    \ 0000                      .extern clrhomed
    \ 0000                      .extern cputc
    \ 0000                      .extern cputlnd
    \ 0000                      .extern csputdec
    \ 0000                      .extern hline
    \ 0000                      .extern lcopy
    \ 0000                      .extern lfill
    \ 0000                      .extern mcputsxy
    \ 0000                      .extern messagebox
    \ 0000                      .extern mh4printfd
    \ 0000                      .extern mhprintfd
    \ 0000                      .extern mprintfd
    \ 0000                      .extern msprintfd
    \ 0000                      .extern progress
    \ 0000                      .extern readdir_dirent
    \ 0000                      .extern revers
    \ 0000                      .extern s
    \ 0000                      .extern strcopy
    \ 0000                      .extern textcolor
0001                #include <string.h>
0002                #include <stdint.h>
0003                #include <mega65/conio.h>  // llvm instead of <printf.h>
0004                #include <mega65/memory.h>  // mega65-libc
0005                #include <mega65/hal.h>  // mega65-libc
0006                #include "regions.h"
0007                #include "hyppo.h"
0008                #include "fileio.h"
0009                #include "conioextensions.h"
0010
0011                // static unsigned char __attribute__((used)) retval;
0012
0013                // unsigned char ptrMiniOffs = $DE;
0014                // #pragma bss-name (push, "ZEROPAGE")
0015                // /* volatile __zp */ unsigned long ptrMiniOffs;
0016                // #pragma bss-name (pop)
0017                // unsigned char * ptrMiniOffs = 0xFFD6C00; the address region is given
0018                #define SECTBUF      0xFFD6C00
0019                #define SECTBUFUPPER 0xFFD6D00
0020
0021                // unsigned char __attribute__((used)) offsCurrIdx = 0;
0022                // unsigned char __attribute__((used)) flagCurrSec = 0;
0023                // #pragma bss-name (push, "ZEROPAGE")
0024                // for zp global vars use: unsigned char var = 0;
0025                // #pragma bss-name (pop)
0026
0027                // All to point into the disk buffer.
0028                // to access as data:
0029                BAM * BAMsector[2] = { (BAM*) BLOCKBAMLOW, (BAM*) BLOCKBAMHIGH };
    \ 0000                      .section data,data
    \ 0000                      .public BAMsector
    \ 0000 00170018 BAMsector:  .word   0x1700,0x1800
0030                // to transfer as fake BAM struct:
0031                DATABLOCK * worksector[2] = { (DATABLOCK*) BLOCKDATALOW, (DATABLOCK*) BLOCKDATAHIGH };
    \ 0000                      .section data,data
    \ 0000                      .public worksector
    \ 0000 0019001a worksector: .word   0x1900,0x1a00
0032                // eight entries per single block:
0033                BAM * worksectorasBAM[2] = { (BAM*) BLOCKDATALOW, (BAM*) BLOCKDATAHIGH };
    \ 0000                      .section data,data
    \ 0000                      .public worksectorasBAM
    \ 0000          worksectorasBAM:
    \ 0000 0019001a             .word   0x1900,0x1a00
0034
0035                // eight entries per single block:
0036                // /* SECT */ DIRENT * direntryblock[2] = {
0037                //  ( /* SECT */ DIRENT*) DIRENTPAGELOW,
0038                //  ( /* SECT */ DIRENT*) (DIRENTPAGELOW + DIRENTSIZE) }; // HIGH };
0039
0040                DIRFLAGS direntflags[2][NBRENTRIES];
0041
0042                // unsigned char workside;
0043                unsigned char BAMside;
    \ 0000                      .section zdata,bss
    \ 0000                      .public BAMside
    \ 0000          BAMside:    .space  1
0044                unsigned char direntside;
    \ 0000                      .section zdata,bss
    \ 0000                      .public direntside
    \ 0000          direntside: .space  1
0045                unsigned char dosfilename[DOSFILENAMELEN + 1]; // extra byte for nullterm
    \ 0000                      .section zdata,bss
    \ 0000                      .public dosfilename
    \ 0000          dosfilename:
    \ 0000                      .space  17
0046
0047                // Midnight Mega general setup options:
0048                // __attribute__((section(".data")))
0049                OPTION option;
0050
0051                #define READ 0
0052                #define WRITE 1
0053                #define OFF 2
0054                #define SHOWACCESSX 26
0055                #define SHOWACCESSY 22
0056                void ShowAccess(unsigned char drive,
0057                                char track, char sector, unsigned char rw)  {
    \ 0000                      .section code,text
    \ 0000                      .public ShowAccess
    \ 0000 a200     ShowAccess: ldx     #0
    \ 0002 a003                 ldy     #3
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+27
    \ 0009 20....               jsr     `?L1387`
    \ 000c 85..                 sta     zp:_Zp+25
    \ 000e a5..                 lda     zp:_Zp+2
    \ 0010 85..                 sta     zp:_Zp+24
0058                  if (rw == OFF)  {
    \ 0012 a302                 ldz     #2
    \ 0014 d4..                 cpz     zp:_Zp+24
    \ 0016 d019                 bne     `?L4`
0059                    textcolor(COLOUR_CYAN);
    \ 0018 a903                 lda     #3
    \ 001a 20....               jsr     textcolor
0060                    hline(SHOWACCESSX, SHOWACCESSY, 12, 32); // 64);  // 64 is the horizontal line
    \ 001d a920                 lda     #32
    \ 001f 85..                 sta     zp:_Zp+2
    \ 0021 a90c                 lda     #12
    \ 0023 85..                 sta     zp:_Zp+1
    \ 0025 a916                 lda     #22
    \ 0027 85..                 sta     zp:_Zp
    \ 0029 a91a                 lda     #26
    \ 002b 20....               jsr     hline
    \ 002e 4c....               jmp     `?L3`
    \ 0031          `?L4`:
0061                  } else if (option.option & OPTIONshowDRV) {
    \ 0031 a904                 lda     #4
    \ 0033 2c....               bit     option
    \ 0036 f39900               lbeq    `?L3`
0062                // #ifdef DISKDEBUG
0063                    revers(1);
    \ 0039 a901                 lda     #1
    \ 003b 20....               jsr     revers
0064                    if (drive)  textcolor(COLOUR_LIGHTGREEN);
    \ 003e a5..                 lda     zp:_Zp+27
    \ 0040 f004                 beq     `?L10`
    \ 0042 a90d                 lda     #13
    \ 0044 8002                 bra     `?L1247`
    \ 0046          `?L10`:
0065                    else        textcolor(COLOUR_LIGHTGREY);
    \ 0046 a90f                 lda     #15
    \ 0048          `?L1247`:
    \ 0048 20....               jsr     textcolor
0066                    mcputsxy(SHOWACCESSX, SHOWACCESSY, " D");
    \ 004b a9..                 lda     #.byte0 `_StringLiteral_ D`
    \ 004d 85..                 sta     zp:_Zp+2
    \ 004f a9..                 lda     #.byte1 `_StringLiteral_ D`
    \ 0051 85..                 sta     zp:_Zp+3
    \ 0053 a916                 lda     #22
    \ 0055 85..                 sta     zp:_Zp
    \ 0057 a91a                 lda     #26
    \ 0059 20....               jsr     mcputsxy
0067                    csputdec(drive, 1, 0);
    \ 005c 20....               jsr     `?L1416`
    \ 005f a6..                 ldx     zp:_Zp+27
    \ 0061 86..                 stx     zp:_Zp
    \ 0063 20....               jsr     `?L1389`
    \ 0066 a901                 lda     #1
    \ 0068 20....               jsr     csputdec
0068                    textcolor(COLOUR_ORANGE);
    \ 006b a908                 lda     #8
    \ 006d 20....               jsr     textcolor
0069                    cputc('T');
    \ 0070 a954                 lda     #84
    \ 0072 20....               jsr     cputc
0070                    csputdec(track, 2, 0);
    \ 0075 20....               jsr     `?L1416`
    \ 0078 a6..                 ldx     zp:_Zp+26
    \ 007a 86..                 stx     zp:_Zp
    \ 007c 20....               jsr     `?L1389`
    \ 007f a902                 lda     #2
    \ 0081 20....               jsr     csputdec
0071                    textcolor(COLOUR_LIGHTBLUE);
    \ 0084 a90e                 lda     #14
    \ 0086 20....               jsr     textcolor
0072                    cputc('S');
    \ 0089 a953                 lda     #83
    \ 008b 20....               jsr     cputc
0073                    csputdec(sector, 2, 0);
    \ 008e 20....               jsr     `?L1416`
    \ 0091 a6..                 ldx     zp:_Zp+25
    \ 0093 86..                 stx     zp:_Zp
    \ 0095 20....               jsr     `?L1389`
    \ 0098 a902                 lda     #2
    \ 009a 20....               jsr     csputdec
0074                /*
0075                    cputc('H');
0076                    cputc((sector >= 20) ? '1' : '0');
0077                */
0078                    cputc(' ');
    \ 009d 20....               jsr     `?L1449`
0079                    if (rw == WRITE)  {
    \ 00a0 ab....               ldz     _Zp+24
    \ 00a3 3b                   dez
    \ 00a4 d009                 bne     `?L13`
0080                      textcolor(COLOUR_RED);
    \ 00a6 a902                 lda     #2
    \ 00a8 20....               jsr     textcolor
0081                      cputc('W');
    \ 00ab a957                 lda     #87
    \ 00ad 8007                 bra     `?L1245`
    \ 00af          `?L13`:
0082                    } else {
0083                      textcolor(COLOUR_ORANGE);
    \ 00af a908                 lda     #8
    \ 00b1 20....               jsr     textcolor
0084                      cputc('R');
    \ 00b4 a952                 lda     #82
    \ 00b6          `?L1245`:
    \ 00b6 20....               jsr     cputc
0085                    }
0086                    if (drive)  textcolor(COLOUR_LIGHTGREEN);
    \ 00b9 a5..                 lda     zp:_Zp+27
    \ 00bb f004                 beq     `?L16`
    \ 00bd a90d                 lda     #13
    \ 00bf 8002                 bra     `?L1243`
    \ 00c1          `?L16`:
0087                    else        textcolor(COLOUR_LIGHTGREY);
    \ 00c1 a90f                 lda     #15
    \ 00c3          `?L1243`:
    \ 00c3 20....               jsr     textcolor
0088                    cputc(' ');
    \ 00c6 20....               jsr     `?L1449`
0089                    revers(0);
    \ 00c9 a900                 lda     #0
    \ 00cb 20....               jsr     revers
0090                    cputc(' ');
    \ 00ce 20....               jsr     `?L1449`
    \ 00d1          `?L3`:
0091                /*
0092                #ifdef DELAYDEBUG
0093                  usleep(800000); // microseconds
0094                #endif
0095                  textcolor(COLOUR_CYAN);
0096                  mcputsxy(SHOWACCESSX, SHOWACCESSY, " D");
0097                  hline(SHOWACCESSX, SHOWACCESSY, 12, 32); // 64);  // 64 is the horizontal line
0098                #ifdef DELAYDEBUG
0099                  usleep(20000); // microseconds
0100                #endif
0101                #endif
0102                */
0103                  }
0104                }
    \ 00d1 a003                 ldy     #3
    \ 00d3 4c....               jmp     _RestoreRegisters
0105
0106                // __attribute__((section(".data")))
0107                char lastdrive = 0;
    \ 0000                      .section zdata,bss
    \ 0000                      .public lastdrive
    \ 0000          lastdrive:  .space  1
0108                // __attribute__((section(".data")))
0109                char prevtrack = 0;
    \ 0000                      .section zdata,bss
    \ 0000                      .public prevtrack
    \ 0000          prevtrack:  .space  1
0110                // __attribute__((section(".data")))
0111                char lastdoublesector = 0;
    \ 0000                      .section zdata,bss
    \ 0000                      .public lastdoublesector
    \ 0000          lastdoublesector:
    \ 0000                      .space  1
0112                void _miniInit()  {
    \ 0000                      .section code,text
    \ 0000                      .public _miniInit
    \ 0000          _miniInit:
0113                  // clear F011 Floppy Controller Registers
0114                  if (PEEK(0xd080U) != 0x40)  POKE(0xd080U, 0);
    \ 0000 ad80d0               lda     0xd080
    \ 0003 c940                 cmp     #64
    \ 0005 f005                 beq     `?L23`
    \ 0007 a900                 lda     #0
    \ 0009 8d80d0               sta     0xd080
    \ 000c          `?L23`:
0115                  prevtrack = 0;
    \ 000c a900                 lda     #0
    \ 000e 8d....               sta     prevtrack
0116
0117                  mh4printfd("_miniinit SECTBUF 32addr is: ", SECTBUF >> 16);
    \ 0011 a9fd                 lda     #253
    \ 0013 a20f                 ldx     #15
    \ 0015 a000                 ldy     #0
    \ 0017 a300                 ldz     #0
    \ 0019 424285..             stq     zp:_Zp+4
    \ 001d a9..                 lda     #.byte0 `_StringLiteral__miniinit SECTBUF 32addr is: `
    \ 001f 85..                 sta     zp:_Zp
    \ 0021 a9..                 lda     #.byte1 `_StringLiteral__miniinit SECTBUF 32addr is: `
    \ 0023 85..                 sta     zp:_Zp+1
    \ 0025 20....               jsr     mh4printfd
0118                  mh4printfd(" ", SECTBUF & 0xffff);
    \ 0028 a900                 lda     #0
    \ 002a a26c                 ldx     #108
    \ 002c a8                   tay
    \ 002d 4b                   taz
    \ 002e 424285..             stq     zp:_Zp+4
    \ 0032 a9..                 lda     #.byte0 `_StringLiteral_ `
    \ 0034 85..                 sta     zp:_Zp
    \ 0036 a9..                 lda     #.byte1 `_StringLiteral_ `
    \ 0038 85..                 sta     zp:_Zp+1
    \ 003a 20....               jsr     mh4printfd
0119                  cputlnd();
    \ 003d 20....               jsr     cputlnd
0120                }
    \ 0040 60                   rts
0121
0122                unsigned char driveled(unsigned char errorcode)  {
    \ 0000                      .section code,text
    \ 0000                      .public driveled
    \ 0000 a200     driveled:   ldx     #0
    \ 0002 a000                 ldy     #0
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+24
0123                    // Turn on just the LED, this causes it to blink:
0124                    POKE(0xd080U, 0x40);
    \ 0009 a940                 lda     #64
    \ 000b 8d80d0               sta     0xd080
0125                    bordercolor (COLOUR_RED);
    \ 000e a902                 lda     #2
    \ 0010 20....               jsr     bordercolor
0126                    return errorcode;
    \ 0013 a5..                 lda     zp:_Zp+24
0127                }
    \ 0015 a000                 ldy     #0
    \ 0017 4c....               jmp     _RestoreRegisters
0128
0129                // returns 1 for odd numbered sectors, 0 for even:
0130                unsigned char ReadSector(unsigned char legacyHDOSstate,
0131                                         unsigned char drive, char track,
0132                                                              char sector) {
    \ 0000                      .section code,text
    \ 0000                      .public ReadSector
    \ 0000          ReadSector:
    \ 0000 20....               jsr     `?L1372`
    \ 0003 20....               jsr     `?L1387`
    \ 0006 85..                 sta     zp:_Zp+24
    \ 0008 a5..                 lda     zp:_Zp+2
    \ 000a 85..                 sta     zp:_Zp+25
0133                  unsigned char retval;
0134                  unsigned char s;
0135
0136                  ShowAccess(drive, track, sector, READ);
    \ 000c 8a                   txa
    \ 000d 85..                 sta     zp:_Zp+2
    \ 000f 20....               jsr     `?L1354`
    \ 0012 a5..                 lda     zp:_Zp+26
    \ 0014 20....               jsr     ShowAccess
0137
0138                  if (track == 0)  return 0xFC;
    \ 0017 a5..                 lda     zp:_Zp+24
    \ 0019 d005                 bne     `?L33`
    \ 001b a9fc                 lda     #-4
    \ 001d 4c....               jmp     `?L31`
    \ 0020          `?L33`:
0139                  drive += 0x20;   // #$60 drive 0
0140                  if (sector < 20)  {
    \ 0020 20....               jsr     `?L1411`
    \ 0023 b007                 bcs     `?L37`
0141                     drive += 0x08; // second side of disk
    \ 0025 a908                 lda     #8
    \ 0027 18                   clc
    \ 0028 65..                 adc     zp:_Zp+4
    \ 002a 85..                 sta     zp:_Zp+4
    \ 002c          `?L37`:
0142                  }
0143
0144                  // Flag which side we need:
0145                  retval = sector % 2;
    \ 002c a901                 lda     #1
    \ 002e 25..                 and     zp:_Zp+25
    \ 0030 85..                 sta     zp:_Zp+26
0146                  
0147                  if (lastdrive != drive ||
0148                      prevtrack != track || lastdoublesector != (sector / 2))  {
    \ 0032 ab....               ldz     _Zp+4
    \ 0035 dc....               cpz     lastdrive
    \ 0038 d015                 bne     `?L41`
    \ 003a ab....               ldz     _Zp+24
    \ 003d dc....               cpz     prevtrack
    \ 0040 d00d                 bne     `?L41`
    \ 0042 ae....               ldx     lastdoublesector
    \ 0045 a5..                 lda     zp:_Zp+25
    \ 0047 85..                 sta     zp:_Zp
    \ 0049 46..                 lsr     zp:_Zp
    \ 004b e4..                 cpx     zp:_Zp
    \ 004d f061                 beq     `?L40`
    \ 004f          `?L41`:
0149                //    mcputsxy(3, SHOWACCESSY, " reading ");
0150                //    csputdec(sector, 2, 0);
0151                    // Turn on motor + led (which causes led to light solid):
0152                    POKE(0xd080U, drive);
0153                    // @@@@ legacy timing:
0154                //    if (legacyHDOSstate)  {
0155                    if (lastdrive != drive)  {
    \ 004f 20....               jsr     `?L1422`
    \ 0052 f00a                 beq     `?L43`
0156                      // Spinup for ready:
0157                      POKE(0xd081U, 0x20);
    \ 0054 a920                 lda     #32
    \ 0056 8d81d0               sta     0xd081
    \ 0059          `?L45`:
0158                      // Wait while busy:
0159                      while (PEEK(0xd082U) & 0x80) {}
    \ 0059 2c82d0               bit     0xd082
    \ 005c 30fb                 bmi     `?L45`
    \ 005e          `?L43`:
0160                    }
0161                    // Track (start at 0):
0162                    POKE(0xd084U, track - 1);
0163                    // Sector (only side 0 ones):
0164                //    POKE(0xd085U, sector / 2 + 1);
0165                    POKE(0xd085U, (((sector) % 20) / 2) + 1);
    \ 005e 20....               jsr     `?L1335`
0166                //    if (sector < 20)  s = (sector / 2) + 1;
0167                //    else              s = ((sector - 20) / 2) + 1;
0168                //    POKE(0xd085U, s);
0169                    // Side:
0170                //    POKE(0xd086U, 0);
0171                    POKE(0xd086U, ((sector >= 20) ? 1 : 0)); // side
    \ 0061 b004                 bcs     `?L604`
    \ 0063 a900                 lda     #0
    \ 0065 8002                 bra     `?L1248`
    \ 0067 a901     `?L604`:    lda     #1
    \ 0069          `?L1248`:
    \ 0069 85..                 sta     zp:_Zp
    \ 006b a900                 lda     #0
    \ 006d a5..                 lda     zp:_Zp
    \ 006f 8d86d0               sta     0xd086
0172                    // Read:
0173                    POKE(0xd081U, 0x41);
    \ 0072 a941                 lda     #65
    \ 0074 8d81d0               sta     0xd081
    \ 0077          `?L48`:
0174                    // Wait while busy:
0175                    while (PEEK(0xd082U) & 0x80) {}
    \ 0077 2c82d0               bit     0xd082
    \ 007a 30fb                 bmi     `?L48`
0176                    // Check for error:
0177                    if (PEEK(0xd082U) & 0x18) {
    \ 007c ad82d0               lda     0xd082
    \ 007f 8918                 bit     #24
    \ 0081 f01a                 beq     `?L52`
0178                      // Turn on just the LED, this causes to blink:
0179                //      POKE(0xd080U, 0x40);
0180                //      bordercolor(COLOUR_RED);
0181                      prevtrack = 0;
    \ 0083 a900                 lda     #0
    \ 0085 8d....               sta     prevtrack
0182                  mprintfd("ReadSector. Track=", track);
    \ 0088 a6..                 ldx     zp:_Zp+24
    \ 008a 86..                 stx     zp:_Zp+4
    \ 008c 85..                 sta     zp:_Zp+5
    \ 008e 85..                 sta     zp:_Zp+6
    \ 0090 85..                 sta     zp:_Zp+7
    \ 0092 a9..                 lda     #.byte0 `_StringLiteral_ReadSector. Track=`
    \ 0094 85..                 sta     zp:_Zp
    \ 0096 a9..                 lda     #.byte1 `_StringLiteral_ReadSector. Track=`
    \ 0098 20....               jsr     `?L1325`
    \ 009b 8021                 bra     `?L31`
    \ 009d          `?L52`:
0183                  mprintfd(" Sector=", sector);
0184                  mhprintfd(" $d082U=", PEEK(0xd082U));
0185                  cputlnd();
0186                  cgetcd();
0187                      return driveled(0xff);
0188                    }    // Make sure we can see the data, clear bit 7:
0189                    POKE(0xd689U, PEEK(0xd689U) & ~0x80);
0190                    lastdrive = drive;
0191                    prevtrack = track;
0192                    lastdoublesector = (sector / 2);
    \ 009d 20....               jsr     `?L1424`
    \ 00a0 a5..                 lda     zp:_Zp+24
    \ 00a2 8d....               sta     prevtrack
    \ 00a5 a5..                 lda     zp:_Zp+25
    \ 00a7 85..                 sta     zp:_Zp
    \ 00a9 46..                 lsr     zp:_Zp
    \ 00ab a5..                 lda     zp:_Zp
    \ 00ad 8d....               sta     lastdoublesector
    \ 00b0          `?L40`:
0193                  } /*
0194                  else {
0195                    mcputsxy(3, SHOWACCESSY, " cached ");
0196                    csputdec(sector, 2, 0);
0197                  }  */
0198                  ShowAccess(drive, track, sector, OFF);
    \ 00b0 a902                 lda     #2
    \ 00b2 85..                 sta     zp:_Zp+2
    \ 00b4 20....               jsr     `?L1354`
    \ 00b7 a5..                 lda     zp:_Zp+4
    \ 00b9 20....               jsr     ShowAccess
0199                  return retval;
    \ 00bc a5..                 lda     zp:_Zp+26
    \ 00be          `?L31`:
0200                }
    \ 00be 4c....               jmp     `?L58`
0201
0202                // both physical sectors are written:
0203                unsigned char WriteSector(unsigned char legacyHDOSstate,
0204                                          unsigned char drive, char track,
0205                                                               char sector) {
    \ 0000                      .section code,text
    \ 0000                      .public WriteSector
    \ 0000          WriteSector:
    \ 0000 20....               jsr     `?L1372`
    \ 0003 20....               jsr     `?L1387`
    \ 0006 85..                 sta     zp:_Zp+24
    \ 0008 a5..                 lda     zp:_Zp+2
    \ 000a 85..                 sta     zp:_Zp+25
0206                    unsigned char retval;
0207
0208                  ShowAccess(drive, track, sector, WRITE);
    \ 000c a901                 lda     #1
    \ 000e 85..                 sta     zp:_Zp+2
    \ 0010 20....               jsr     `?L1354`
    \ 0013 a5..                 lda     zp:_Zp+26
    \ 0015 20....               jsr     ShowAccess
0209                  prevtrack = 0; // @@@@@
    \ 0018 a900                 lda     #0
    \ 001a 8d....               sta     prevtrack
0210
0211                    if (track == 0)  return 0xFC;
    \ 001d a5..                 lda     zp:_Zp+24
    \ 001f d004                 bne     `?L60`
    \ 0021 a9fc                 lda     #-4
    \ 0023 8075                 bra     `?L58`
    \ 0025          `?L60`:
0212                    drive += 0x20;   // #$60 drive 0
0213                    if (sector < 20)  {
    \ 0025 20....               jsr     `?L1411`
    \ 0028 b007                 bcs     `?L64`
0214                        drive += 0x08; // second side of disk
    \ 002a a908                 lda     #8
    \ 002c 18                   clc
    \ 002d 65..                 adc     zp:_Zp+4
    \ 002f 85..                 sta     zp:_Zp+4
    \ 0031          `?L64`:
0215                    }
0216
0217                    // Flag which side we need:
0218                    retval = sector % 2;
    \ 0031 a901                 lda     #1
    \ 0033 25..                 and     zp:_Zp+25
    \ 0035 85..                 sta     zp:_Zp+26
0219
0220                    // Turn on motor + led (which causes led to light solid):
0221                    POKE(0xd080U, drive);
0222                    // @@@@ legacy timing:
0223                //    if (legacyHDOSstate)  {
0224                    if (lastdrive != drive)  {
    \ 0037 20....               jsr     `?L1422`
    \ 003a f00a                 beq     `?L67`
0225                      // Spinup for ready:
0226                      POKE(0xd081U, 0x20);
    \ 003c a920                 lda     #32
    \ 003e 8d81d0               sta     0xd081
    \ 0041          `?L69`:
0227                      // Wait while busy:
0228                      while (PEEK(0xd082U) & 0x80) {}
    \ 0041 2c82d0               bit     0xd082
    \ 0044 30fb                 bmi     `?L69`
    \ 0046          `?L67`:
0229                    }
0230                    // Track (start at 0):
0231                    POKE(0xd084U, track - 1);
0232                    // Sector (only side 0 ones):
0233                    // Sectors start at 1   mega65-book.pdf#3f0
0234                //    POKE(0xd085U, sector / 2 + 1);
0235                    POKE(0xd085U, (((sector) % 20) / 2) + 1);
    \ 0046 20....               jsr     `?L1335`
0236                    // Side:
0237                    POKE(0xd086U, (sector >= 20 ? 1 : 0));
    \ 0049 b004                 bcs     `?L607`
    \ 004b a900                 lda     #0
    \ 004d 8002                 bra     `?L1249`
    \ 004f a901     `?L607`:    lda     #1
    \ 0051          `?L1249`:
    \ 0051 85..                 sta     zp:_Zp
    \ 0053 a900                 lda     #0
    \ 0055 a5..                 lda     zp:_Zp
    \ 0057 8d86d0               sta     0xd086
0238                    // Write:
0239                    POKE(0xd081U, 0x84);
    \ 005a a984                 lda     #-124
    \ 005c 8d81d0               sta     0xd081
    \ 005f          `?L72`:
0240                    // Wait while busy and writing:
0241                    while ((PEEK(0xd082U) & 0x80) ||
0242                           (PEEK(0xd083U) & 0x10))  {}
    \ 005f 2c82d0               bit     0xd082
    \ 0062 30fb                 bmi     `?L72`
    \ 0064 ad83d0               lda     0xd083
    \ 0067 8910                 bit     #16
    \ 0069 d0f4                 bne     `?L72`
0243                    // Check for error:
0244                    if (PEEK(0xd082U) & 0x18) {
    \ 006b ad82d0               lda     0xd082
    \ 006e 8918                 bit     #24
    \ 0070 f017                 beq     `?L76`
0245                      // Turn on just the LED, this causes to blink:
0246                //      POKE(0xd080U, 0x40);
0247                //      bordercolor(COLOUR_RED);
0248                  mprintfd("WriteSector. Track=", track);
    \ 0072 a6..                 ldx     zp:_Zp+24
    \ 0074 86..                 stx     zp:_Zp+4
    \ 0076 a900                 lda     #0
    \ 0078 85..                 sta     zp:_Zp+5
    \ 007a 85..                 sta     zp:_Zp+6
    \ 007c 85..                 sta     zp:_Zp+7
    \ 007e a9..                 lda     #.byte0 `_StringLiteral_WriteSector. Track=`
    \ 0080 85..                 sta     zp:_Zp
    \ 0082 a9..                 lda     #.byte1 `_StringLiteral_WriteSector. Track=`
    \ 0084 20....               jsr     `?L1325`
    \ 0087 8011                 bra     `?L58`
    \ 0089          `?L76`:
0249                  mprintfd(" Sector=", sector);
0250                  mhprintfd(" $d082U=", PEEK(0xd082U));
0251                  cputlnd();
0252                  cgetcd();
0253                      return driveled(0xff);
0254                    }
0255                    // Make sure we can see the data, clear bit 7:
0256                    POKE(0xd689U, PEEK(0xd689U) & ~0x80);
0257                    lastdrive = drive;
0258
0259                  ShowAccess(drive, track, sector, OFF);
    \ 0089 20....               jsr     `?L1424`
    \ 008c a902                 lda     #2
    \ 008e 85..                 sta     zp:_Zp+2
    \ 0090 20....               jsr     `?L1354`
    \ 0093 a5..                 lda     zp:_Zp+4
    \ 0095 20....               jsr     ShowAccess
0260                    return retval;
    \ 0098 a5..                 lda     zp:_Zp+26
    \ 009a          `?L58`:
0261                }
    \ 009a a002                 ldy     #2
    \ 009c 4c....               jmp     _RestoreRegisters
0262
0263                // depending on the sector's side this returns the wanted
0264                // sector in the regular or upper 256 bytes of the 512
0265                // bytes buffer:
0266                unsigned char GetWholeSector(unsigned char legacyHDOSstate,
0267                                             BAM* entry, unsigned char drive,
0268                                             char track, char sector)  {
    \ 0000                      .section code,text
    \ 0000                      .public GetWholeSector
    \ 0000          GetWholeSector:
    \ 0000 a200                 ldx     #0
    \ 0002 a007                 ldy     #7
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 a6..                 ldx     zp:_Zp+2
    \ 0009 86..                 stx     zp:_Zp+5
0269                  BAM* ws = entry;   // later to be DATABLOCK*
0270                  unsigned char side;
0271                #ifdef DEBUG
0272                  mprintf("GetWholeSector before ReadSector. Track=", track);
0273                  mprintf(" Sector=", sector);
0274                  mh4printf(" p=", (long) p);
0275                  cputln();
0276                  cgetc();
0277                #endif
0278                  side = ReadSector(legacyHDOSstate, drive, track, sector);
    \ 000b 20....               jsr     `?L1370`
0279
0280                  if (side > 1)  return side;
    \ 000e 902e                 bcc     `?L85`
0281                  lcopy(SECTBUF,      (uint32_t) ws,             BLOCKSIZE);
    \ 0010 20....               jsr     `?L1303`
    \ 0013 20....               jsr     `?L1324`
    \ 0016 a26c                 ldx     #108
    \ 0018 20....               jsr     `?L1368`
0282                  lcopy(SECTBUFUPPER, (uint32_t) ws + BLOCKSIZE, BLOCKSIZE);
    \ 001b 20....               jsr     `?L1303`
    \ 001e a5..                 lda     zp:_Zp+25
    \ 0020 85..                 sta     zp:_Zp+29
    \ 0022 a5..                 lda     zp:_Zp+24
    \ 0024 85..                 sta     zp:_Zp+28
    \ 0026 98                   tya
    \ 0027 85..                 sta     zp:_Zp+30
    \ 0029 85..                 sta     zp:_Zp+31
    \ 002b a201                 ldx     #1
    \ 002d 4b                   taz
    \ 002e 18                   clc
    \ 002f 424265..             adcq    zp:_Zp+28
    \ 0033 424285..             stq     zp:_Zp+4
    \ 0037 a900                 lda     #0
    \ 0039 a26d                 ldx     #109
    \ 003b 20....               jsr     `?L1368`
    \ 003e          `?L85`:
    \ 003e a5..                 lda     zp:_Zp+26
0283                #ifdef DEBUG
0284                  mprintf("GetWholeSector done. side=", side);
0285                  cputln();
0286                  cgetc();
0287                #endif
0288                  return side;
0289                }
    \ 0040 a007                 ldy     #7
    \ 0042 4c....               jmp     _RestoreRegisters
0290                unsigned char GetOneSector(unsigned char legacyHDOSstate,
0291                                           BAM* entry, unsigned char drive,
0292                                             char track, char sector)  {
    \ 0000                      .section code,text
    \ 0000                      .public GetOneSector
    \ 0000          GetOneSector:
    \ 0000 20....               jsr     `?L1372`
    \ 0003 a6..                 ldx     zp:_Zp+2
    \ 0005 86..                 stx     zp:_Zp+5
0293                  BAM* ws = entry;   // later to be DATABLOCK*
0294                  unsigned char side;
0295                #ifdef DEBUG
0296                  mprintf("GetOneSector before ReadSector. Track=", track);
0297                  mprintf(" Sector=", sector);
0298                  // mh4printf(" p=", (long) p);
0299                  cputln();
0300                  cgetc();
0301                #endif
0302                  side = ReadSector(legacyHDOSstate, drive, track, sector);
    \ 0007 20....               jsr     `?L1370`
0303
0304                  if (side > 1)  return side;
    \ 000a 9019                 bcc     `?L96`
0305                  if (side == 0)  lcopy(SECTBUF,      (uint32_t) ws, BLOCKSIZE);
    \ 000c a5..                 lda     zp:_Zp+26
    \ 000e d00a                 bne     `?L95`
    \ 0010 20....               jsr     `?L1303`
    \ 0013 20....               jsr     `?L1324`
    \ 0016 a26c                 ldx     #108
    \ 0018 8008                 bra     `?L1253`
    \ 001a          `?L95`:
0306                  else            lcopy(SECTBUFUPPER, (uint32_t) ws, BLOCKSIZE);
    \ 001a 20....               jsr     `?L1303`
    \ 001d 20....               jsr     `?L1324`
    \ 0020 a26d                 ldx     #109
    \ 0022          `?L1253`:
    \ 0022 20....               jsr     `?L1368`
    \ 0025          `?L96`:
0307                #ifdef DEBUG
0308                  mprintf("GetOneSector done. side=", side);
0309                  cputln();
0310                  cgetc();
0311                #endif
0312
0313                  return side;
    \ 0025 a5..                 lda     zp:_Zp+26
0314                }
    \ 0027 a002                 ldy     #2
    \ 0029 4c....               jmp     _RestoreRegisters
0315                unsigned char PutWholeSector(unsigned char legacyHDOSstate,
0316                                             BAM* entry, unsigned char drive,
0317                                             char track, char sector)  {
    \ 0000                      .section code,text
    \ 0000                      .public PutWholeSector
    \ 0000          PutWholeSector:
    \ 0000 20....               jsr     `?L1376`
0318                  BAM* ws = entry;   // later to be DATABLOCK*
0319
0320                //  if (side > 1)  return side;
0321                  unsigned char side = sector % 2;
    \ 0003 20....               jsr     `?L1394`
0322
0323                  if (side == 0)  {
    \ 0006 d021                 bne     `?L102`
0324                    clrhomed();
    \ 0008 20....               jsr     `?L1348`
0325                    mprintfd("PutWholeSector before lower buffer. Track=", track);
    \ 000b a9..                 lda     #.byte0 `_StringLiteral_PutWholeSector before lower buffer. Track=`
    \ 000d 85..                 sta     zp:_Zp
    \ 000f a9..                 lda     #.byte1 `_StringLiteral_PutWholeSector before lower buffer. Track=`
    \ 0011 20....               jsr     `?L1318`
0326                    mprintfd(" Sector=", sector);
0327                    cputlnd();
0328                    cgetcd();
    \ 0014 20....               jsr     cgetcd
0329                    lcopy((uint32_t) ws, SECTBUF, BLOCKSIZE * 2); // <-- take both sectors
    \ 0017 20....               jsr     `?L1332`
    \ 001a a26c                 ldx     #108
    \ 001c a0fd                 ldy     #253
    \ 001e a30f                 ldz     #15
    \ 0020 424285..             stq     zp:_Zp+4
    \ 0024 20....               jsr     `?L1323`
    \ 0027 8024                 bra     `?L1256`
    \ 0029          `?L102`:
0330                  } else {  // @@@@ probably no longer needed:
0331                    // Now first read the state from the disk, because only one of
0332                    // the two logical sectors will be overwritten:
0333                    ReadSector(legacyHDOSstate, drive, track, sector);
    \ 0029 a5..                 lda     zp:_Zp+26
    \ 002b 20....               jsr     `?L1343`
    \ 002e 20....               jsr     ReadSector
0334                  
0335                    clrhomed();
    \ 0031 20....               jsr     `?L1348`
0336                    mprintfd("PutWholeSector before upper buffer. Track=", track);
    \ 0034 a9..                 lda     #.byte0 `_StringLiteral_PutWholeSector before upper buffer. Track=`
    \ 0036 85..                 sta     zp:_Zp
    \ 0038 a9..                 lda     #.byte1 `_StringLiteral_PutWholeSector before upper buffer. Track=`
    \ 003a 20....               jsr     `?L1318`
0337                    mprintfd(" Sector=", sector);
0338                    cputlnd();
0339                    lcopy((uint32_t) ws, SECTBUFUPPER, BLOCKSIZE);
    \ 003d 20....               jsr     `?L1303`
    \ 0040 a26d                 ldx     #109
    \ 0042 a0fd                 ldy     #253
    \ 0044 a30f                 ldz     #15
    \ 0046 424285..             stq     zp:_Zp+4
    \ 004a 20....               jsr     `?L1354`
    \ 004d          `?L1256`:
    \ 004d 20....               jsr     `?L1314`
0340                  }
0341                  msprintfd("PutWholeSector done. Returning while WriteSector.");
    \ 0050 a9..                 lda     #.byte0 `_StringLiteral_PutWholeSector done. Returning while WriteSector.`
    \ 0052 85..                 sta     zp:_Zp
    \ 0054 a9..                 lda     #.byte1 `_StringLiteral_PutWholeSector done. Returning while WriteSector.`
    \ 0056 4c....               jmp     `?L1292`
0342                  cgetcd();
0343                  return WriteSector(legacyHDOSstate, drive, track, sector - side);
0344                }
0345                unsigned char PutOneSector(unsigned char legacyHDOSstate,
0346                                           BAM* entry, unsigned char drive,
0347                                           char track, char sector)  {
    \ 0000                      .section code,text
    \ 0000                      .public PutOneSector
    \ 0000          PutOneSector:
    \ 0000 20....               jsr     `?L1376`
0348                  BAM* ws = entry;   // later to be DATABLOCK*
0349
0350                  unsigned char side = sector % 2;
0351                  
0352                  // Now first read the state from the disk, because only one of
0353                  // the two logical sectors will be overwritten:
0354                  ReadSector(legacyHDOSstate, drive, track, sector);
    \ 0003 20....               jsr     `?L1394`
    \ 0006 a5..                 lda     zp:_Zp+26
    \ 0008 20....               jsr     `?L1343`
    \ 000b 20....               jsr     ReadSector
0355                  
0356                  if (side == 0)  {
    \ 000e a5..                 lda     zp:_Zp+30
    \ 0010 d021                 bne     `?L109`
0357                    clrhomed();
    \ 0012 20....               jsr     `?L1348`
0358                    mprintfd("PutOneSector before lower buffer. Track=", track);
    \ 0015 a9..                 lda     #.byte0 `_StringLiteral_PutOneSector before lower buffer. Track=`
    \ 0017 85..                 sta     zp:_Zp
    \ 0019 a9..                 lda     #.byte1 `_StringLiteral_PutOneSector before lower buffer. Track=`
    \ 001b 20....               jsr     `?L1318`
0359                    mprintfd(" Sector=", sector);
0360                    cputlnd();
0361                    cgetcd();
    \ 001e 20....               jsr     cgetcd
0362                    lcopy((uint32_t) ws, SECTBUF, BLOCKSIZE);
    \ 0021 20....               jsr     `?L1303`
    \ 0024 a26c                 ldx     #108
    \ 0026 a0fd                 ldy     #253
    \ 0028 a30f                 ldz     #15
    \ 002a 424285..             stq     zp:_Zp+4
    \ 002e 20....               jsr     `?L1323`
    \ 0031 801c                 bra     `?L1259`
    \ 0033          `?L109`:
0363                  } else {
0364                    clrhomed();
    \ 0033 20....               jsr     `?L1348`
0365                    mprintfd("PutOneSector before upper buffer. Track=", track);
    \ 0036 a9..                 lda     #.byte0 `_StringLiteral_PutOneSector before upper buffer. Track=`
    \ 0038 85..                 sta     zp:_Zp
    \ 003a a9..                 lda     #.byte1 `_StringLiteral_PutOneSector before upper buffer. Track=`
    \ 003c 20....               jsr     `?L1318`
0366                    mprintfd(" Sector=", sector);
0367                    cputlnd();
0368                    lcopy((uint32_t) ws, SECTBUFUPPER, BLOCKSIZE);
    \ 003f 20....               jsr     `?L1303`
    \ 0042 a26d                 ldx     #109
    \ 0044 a0fd                 ldy     #253
    \ 0046 a30f                 ldz     #15
    \ 0048 424285..             stq     zp:_Zp+4
    \ 004c 20....               jsr     `?L1354`
    \ 004f          `?L1259`:
    \ 004f 20....               jsr     `?L1314`
0369                  }
0370                  msprintfd("PutOneSector done. Returning while WriteSector.");
    \ 0052 a9..                 lda     #.byte0 `_StringLiteral_PutOneSector done. Returning while WriteSector.`
    \ 0054 85..                 sta     zp:_Zp
    \ 0056 a9..                 lda     #.byte1 `_StringLiteral_PutOneSector done. Returning while WriteSector.`
    \ 0058          `?L1292`:
    \ 0058 85..                 sta     zp:_Zp+1
    \ 005a 20....               jsr     msprintfd
0371                  cgetcd();
0372
0373                  return WriteSector(legacyHDOSstate, drive, track, sector - side);
    \ 005d 20....               jsr     `?L1402`
    \ 0060 20....               jsr     `?L1343`
    \ 0063 20....               jsr     WriteSector
0374                }
    \ 0066 a006                 ldy     #6
    \ 0068 4c....               jmp     _RestoreRegisters
0375
0376                void GetBAM(unsigned char legacyHDOSstate, unsigned char side)  {
    \ 0000                      .section code,text
    \ 0000                      .public GetBAM
    \ 0000          GetBAM:
    \ 0000 a5..                 lda     zp:_Zp
0377                  BAM* bs;
0378
0379                  bs = BAMsector[0];
    \ 0002 ae....               ldx     BAMsector
    \ 0005 86..                 stx     zp:_Zp+4
    \ 0007 ae....               ldx     BAMsector+1
    \ 000a 86..                 stx     zp:_Zp+5
0380                  lcopy(ATTICBAMBUFFER + side * ATTICBAMBUFFERSIZE,
    \ 000c 85..                 sta     zp:_Zp
    \ 000e a900                 lda     #0
    \ 0010 20....               jsr     `?L1389`
    \ 0013 a909                 lda     #9
    \ 0015 aa                   tax
    \ 0016 f007                 beq     `?L746`
    \ 0018          `?L747`:
    \ 0018 424206..             aslq    zp:_Zp
    \ 001c ca                   dex
    \ 001d d0f9                 bne     `?L747`
    \ 001f          `?L746`:
    \ 001f 20....               jsr     `?L1332`
    \ 0022 85..                 sta     zp:_Zp+6
    \ 0024 85..                 sta     zp:_Zp+7
    \ 0026 a266                 ldx     #102
    \ 0028 20....               jsr     `?L1341`
    \ 002b 424285..             stq     zp:_Zp
    \ 002f 20....               jsr     lcopy
    \ 0032 a001                 ldy     #1
    \ 0034 4c....               jmp     `?L1288`
0381                        (uint32_t) bs, ATTICBAMBUFFERSIZE);
0382                }
0383                void PutBAM(unsigned char legacyHDOSstate,
0384                            unsigned char drive, unsigned char side, unsigned char dirtrack)  {
    \ 0000                      .section code,text
    \ 0000                      .public PutBAM
    \ 0000 a200     PutBAM:     ldx     #0
    \ 0002 a004                 ldy     #4
    \ 0004 20....               jsr     `?L1395`
0385                  BAM* bs;
0386
0387                  PutOneSector(legacyHDOSstate, BAMsector[0], drive, dirtrack, BAMSECT);
    \ 0007 a901                 lda     #1
    \ 0009 85..                 sta     zp:_Zp+4
    \ 000b a5..                 lda     zp:_Zp+2
    \ 000d 20....               jsr     `?L1361`
    \ 0010 20....               jsr     PutOneSector
0388                  bs = BAMsector[0];
0389                  PutOneSector(legacyHDOSstate,
    \ 0013 20....               jsr     `?L1423`
    \ 0016 a001                 ldy     #1
    \ 0018 b1..                 lda     (_Zp+24),y
    \ 001a 85..                 sta     zp:_Zp+4
    \ 001c 88                   dey
    \ 001d b1..                 lda     (_Zp+24),y
    \ 001f 20....               jsr     `?L1362`
    \ 0022 20....               jsr     PutOneSector
0390                               BAMsector[1], drive, bs->chntrack, bs->chnsector);
0391                  lcopy((uint32_t) bs,
    \ 0025 a6..                 ldx     zp:_Zp+26
    \ 0027 86..                 stx     zp:_Zp
    \ 0029 a900                 lda     #0
    \ 002b 20....               jsr     `?L1389`
    \ 002e a909                 lda     #9
    \ 0030 aa                   tax
    \ 0031 f007                 beq     `?L755`
    \ 0033          `?L756`:
    \ 0033 424206..             aslq    zp:_Zp
    \ 0037 ca                   dex
    \ 0038 d0f9                 bne     `?L756`
    \ 003a          `?L755`:
    \ 003a 20....               jsr     `?L1332`
    \ 003d a266                 ldx     #102
    \ 003f 20....               jsr     `?L1341`
    \ 0042 424285..             stq     zp:_Zp+4
    \ 0046 20....               jsr     `?L1354`
    \ 0049 20....               jsr     `?L1314`
0392                        ATTICBAMBUFFER + side * ATTICBAMBUFFERSIZE, ATTICBAMBUFFERSIZE);
0393                }
    \ 004c a004                 ldy     #4
    \ 004e 4c....               jmp     _RestoreRegisters
0394
0395                unsigned char BAM2Attic(unsigned char legacyHDOSstate, unsigned char drive,
0396                                        unsigned char side, unsigned char dirtrack) {
    \ 0000                      .section code,text
    \ 0000                      .public BAM2Attic
    \ 0000          BAM2Attic:
    \ 0000 85..                 sta     zp:_Zp+12
0397                  // _miniInit();
0398
0399                  return readblockchain(legacyHDOSstate, side?ATTICBAM2BUFFER:ATTICBAMBUFFER,
0400                                        BAMBLOCKS, drive, dirtrack, BAMSECT);
    \ 0002 a5..                 lda     zp:_Zp+1
    \ 0004 d006                 bne     `?L611`
    \ 0006 a900                 lda     #0
    \ 0008 a266                 ldx     #102
    \ 000a 8004                 bra     `?L1260`
    \ 000c a900     `?L611`:    lda     #0
    \ 000e a268                 ldx     #104
    \ 0010 a8       `?L1260`:   tay
    \ 0011 a308                 ldz     #8
    \ 0013 424285..             stq     zp:_Zp+8
    \ 0017 20....               jsr     `?L1414`
    \ 001a a5..                 lda     zp:_Zp+2
    \ 001c 85..                 sta     zp:_Zp+7
    \ 001e a5..                 lda     zp:_Zp
    \ 0020 85..                 sta     zp:_Zp+6
    \ 0022 20....               jsr     `?L1448`
    \ 0025 4242a5..             ldq     zp:_Zp+8
    \ 0029 424285..             stq     zp:_Zp
    \ 002d a5..                 lda     zp:_Zp+12
    \ 002f 20....               jsr     readblockchain
    \ 0032 a000                 ldy     #0
    \ 0034          `?L1288`:
0401                }
0402
0403                // this expects data in sector buffer:
0404                void BAMSectorUpdate(BAM* BAMsector, BAM* BAMsector2, char track, char sector, char set) {
0405                  unsigned char bitshifter = 1;
0406
0407                //  BAMsector += $100;  // @@@@@ dirty test
0408                //  mprintf("BAMSectorUpdate BAMsector is:", (unsigned long) BAMsector);
0409
0410                  // next BAM sector of two in total:
0411                  if (track > 40)  {
0412                    track -= 40;
0413                    BAMsector = BAMsector2;
0414                  }
0415                #ifdef DEBUG
0416                        gotoxy(42, 20);
0417                        mh4printf("BAMsector ", (long) BAMsector);
0418                        cputln();
0419                        cgetc();
0420                #endif
0421                  
0422                  track--;  // access array zero based
0423                  if (set)  {  // if set clear alloc bit below to allocate:
0424                    if (sector < 8)  {
0425                      BAMsector->entry[track].alloc1 &= ~(bitshifter << sector);
0426                    }
0427                    else if (sector < 16)  {
0428                      BAMsector->entry[track].alloc2 &= ~(bitshifter << (sector - 8));
0429                    }
0430                    else if (sector < 24)  {
0431                      BAMsector->entry[track].alloc3 &= ~(bitshifter << (sector - 16));
0432                    }
0433                    else if (sector < 32)  {
0434                      BAMsector->entry[track].alloc4 &= ~(bitshifter << (sector - 24));
0435                    }
0436                    else  {
0437                      BAMsector->entry[track].alloc5 &= ~(bitshifter << (sector - 32));
0438                    }
0439                    BAMsector->entry[track].free--;
0440                  }
0441                  else  {
0442                    if (sector < 8)  {
0443                      BAMsector->entry[track].alloc1 |= (bitshifter << sector);
0444                    }
0445                    else if (sector < 16)  {
0446                      BAMsector->entry[track].alloc2 |= (bitshifter << (sector - 8));
0447                    }
0448                    else if (sector < 24)  {
0449                      BAMsector->entry[track].alloc3 |= (bitshifter << (sector - 16));
0450                    }
0451                    else if (sector < 32)  {
0452                      BAMsector->entry[track].alloc4 |= (bitshifter << (sector - 24));
0453                    }
0454                    else  {
0455                      BAMsector->entry[track].alloc5 |= (bitshifter << (sector - 32));
0456                    }
0457                    BAMsector->entry[track].free++;
0458                  }
0459                }
0460
0461                unsigned int BAMSectorsFreeBlocks(BAM* BAMsector, BAM* BAMsector2,
0462                                     unsigned char dirtrack,
0463                                     unsigned char firsttrack, unsigned char lasttrack) {
0464                  unsigned char track80;
0465                  unsigned char track;
0466                  unsigned int free = 0;
0467
0468                  // access track array zero based
0469                  for (track80 = (firsttrack - 1); track80 < lasttrack; track80++)  {
0470                    // next BAM sector of two in total:
0471                    if (track80 < 40)  {
0472                      track = track80;
0473                    } else {
0474                      track = track80 - 40;
0475                      BAMsector = BAMsector2;
0476                    }
0477
0478                    if (track80 != (dirtrack - 1))  {
0479                      free += BAMsector->entry[track].free;
0480                    }
0481                  }
0482
0483                  return free;
0484                }
0485
0486                unsigned int FreeBlocks(unsigned char legacyHDOSstate,
0487                                        unsigned char side, unsigned char dirtrack,
0488                                        unsigned char firsttrack, unsigned char lasttrack) {
0489                  GetBAM(legacyHDOSstate, side);
0490                  return BAMSectorsFreeBlocks(BAMsector[0], BAMsector[1], dirtrack,
0491                                              firsttrack, lasttrack);
0492                }
0493
0494                unsigned int BAMCheckSizeinFilebuffer(unsigned char legacyHDOSstate,
0495                                                      unsigned char drive, unsigned char side,
0496                                                      unsigned char dirtrack,
0497                                                      unsigned char firsttrack,
0498                                                      unsigned char lasttrack) {
0499                  BAM* bs;
0500
0501                  readblockchain(legacyHDOSstate, ATTICFILEBUFFER, BAMBLOCKS,
0502                                 drive, dirtrack, BAMSECT);
0503                  bs = BAMsector[0];
0504                  lcopy(ATTICFILEBUFFER, (uint32_t) bs, ATTICBAMBUFFERSIZE);
0505                  return BAMSectorsFreeBlocks(BAMsector[0], BAMsector[1], dirtrack,
0506                                              firsttrack, lasttrack);
0507                }
0508
0509                // @@@@ debug
0510                // unsigned char* const basepage = (unsigned char*) BASEPAGERESERVED;
0511                unsigned char BAMFreeTracksinaRow(BAM* BAMsector, BAM* BAMsector2,
0512                                     unsigned char firsttrack, unsigned char lasttrack,
0513                                     unsigned char * starttrack, unsigned char * endtrack,
0514                                     unsigned char nboftracks) {
0515                  unsigned char track80;
0516                  unsigned char track;
0517                  unsigned char number = 0;
0518                  unsigned char numberprev = 0;
0519                  unsigned char starttrackprev = 0;
0520                  unsigned char endtrackprev = 0;
0521
0522                  *starttrack = 0; // to return the range matching the number of requested
0523                  *endtrack = 0;   // tracks
0524
0525                  // access track array zero based
0526                  for (track80 = (firsttrack - 1); track80 < lasttrack; track80++)  {
0527                    // next BAM sector of two in total:
0528                    if (track80 < 40)  {
0529                      track = track80;
0530                    } else {
0531                      track = track80 - 40;
0532                      BAMsector = BAMsector2;
0533                    }
0534
0535                    if (BAMsector->entry[track].free >= 40)  {
0536                      if (*starttrack == 0)  *starttrack = track80 + 1;
0537                      number ++;
0538                    } else {
0539                      if (number)  {
0540                        *endtrack = track80;
0541                        if ((*endtrack - *starttrack) >= (nboftracks - 1))  {
0542                          // weak strategy to find lowest track count in a row:
0543                          if ((*endtrack - *starttrack) >= (endtrackprev - starttrackprev)) {
0544                            endtrackprev = *endtrack;
0545                            starttrackprev = *starttrack;
0546                          } else {
0547                            *endtrack = endtrackprev;
0548                            *starttrack = starttrackprev;
0549                          }
0550                        } else {  // requested number of tracks not met:
0551                          *endtrack = 0;
0552                          *starttrack = 0;
0553                        }
0554                      }
0555                      number = 0; // re-begin finding biggest consecutive number
0556                    }
0557                  }
0558
0559                  // determine last track being unallocated:
0560                  if ((*starttrack + number) > lasttrack)  *endtrack = lasttrack;
0561
0562                //  basepage[0] = number;      // @@@@ debug
0563                //  basepage[1] = *starttrack; // @@@@ debug
0564                //  basepage[2] = *endtrack;   // @@@@ debug
0565
0566                  return number;
0567                }
0568
0569                unsigned char FreeTracks(unsigned char legacyHDOSstate,
0570                                         unsigned char side,
0571                                         unsigned char firsttrack, unsigned char lasttrack,
0572                                         unsigned char * starttrack, unsigned char * endtrack,
0573                                         unsigned char nboftracks) {
0574                  GetBAM(legacyHDOSstate, side);
0575                  return BAMFreeTracksinaRow(BAMsector[0], BAMsector[1],
0576                                             firsttrack, lasttrack,
0577                                             starttrack, endtrack, nboftracks);
0578                }
0579
0580                #define ID_i 'I'
0581                #define ID_d 'D'
0582                void FormatPartition(unsigned char legacyHDOSstate,
0583                                     unsigned char drive, unsigned char side,
0584                                     unsigned char dirtrack,
0585                                     unsigned char firsttrack, unsigned char lasttrack,
0586                                     char* name)  {
0587                  BAM* bs;
0588                  BAM* bs1;
0589                  HEADER* hs;
0590                  unsigned char track;
0591
0592                  bs = BAMsector[0];
0593                  bs1 = BAMsector[1];
0594                  hs = (HEADER *) BAMsector[0];
0595
0596                  // do it all backwards to profit from BAM similarities.
0597
0598                  // create first empty dirent sector:
0599                  lfill((uint32_t) bs1, 0, BLOCKSIZE);
0600                  bs1->chnsector = 0xff;
0601
0602                  // now BAM sectors:
0603                  bs->chntrack = 0;   // second BAM sector first
0604                  bs->chnsector = 0xff;  // next sector of BAM
0605                  bs->version = 0x44;
0606                  bs->versioninvert = 0xbb;
0607                  bs->diskid1 = ID_i;  // @@@@@
0608                  bs->diskid2 = ID_d;
0609                  bs->io = 0x40;
0610                  // for (i = 0x07; i <= 0x0f; i++)  bs[i] = 0;
0611                  lfill((uint32_t) bs + 0x07, 0, 0x0f - 0x07 + 1); // clear bytes 07..0f
0612                  for (track = 0; track < 40; track++)  {
0613                    if ((track + 41) == dirtrack)  {
0614                      bs->entry[track].free = 0x24;  // occupy header, BAM and dirent
0615                      bs->entry[track].alloc1 = 0xf0;
0616                    } else {
0617                      bs->entry[track].free = 0x28;
0618                      bs->entry[track].alloc1 = 0xff;
0619                    }
0620                    bs->entry[track].alloc2 = 0xff;
0621                    bs->entry[track].alloc3 = 0xff;
0622                    bs->entry[track].alloc4 = 0xff;
0623                    bs->entry[track].alloc5 = 0xff;
0624                  }
0625                  progress("Writing...", "directory/BAM", 30);
0626                  PutWholeSector(legacyHDOSstate, (BAM *) bs, drive, dirtrack, BAMSECT + 1);
0627
0628                  // both BAM sectors look almost the same:
0629                  lcopy((uint32_t) bs, (uint32_t) bs1, BLOCKSIZE);
0630
0631                  bs1->chntrack = dirtrack;  // first BAM sector points to second one
0632                  bs1->chnsector = BAMSECT + 1;  // next sector of BAM
0633                  if (dirtrack > 40)  {  // reset eventual dirtrack in upper BAM
0634                    bs1->entry[dirtrack - 41].free = 0x28;
0635                    bs1->entry[dirtrack - 41].alloc1 = 0xff;
0636                  }
0637                  if (dirtrack <= 40)  {
0638                    bs1->entry[dirtrack - 1].free = 0x24;  // occupy header, BAM and dirent
0639                    bs1->entry[dirtrack - 1].alloc1 = 0xf0;
0640                  }
0641
0642                  // create first empty header sector:
0643                  lfill((uint32_t) bs, 0, BLOCKSIZE);
0644                  hs->chntrack = dirtrack;  // first BAM sector points to second one
0645                  hs->chnsector = DIRENTSECT;
0646                  hs->diskdosversion = 0x44;
0647                  strcopy(name, (char *) hs->diskname, 16);
0648                  hs->unused1 = 0xa0;
0649                  hs->unused2 = 0xa0;
0650                  hs->diskid1 = ID_i;  // @@@@
0651                  hs->diskid2 = ID_d;
0652                  hs->unused3 = 0xa0;
0653                  hs->dosversion = 0x33;
0654                  hs->diskversion = 0x44;
0655                  hs->unused4 = 0xa0;
0656                  hs->unused5 = 0xa0;
0657
0658                  progress("Writing...", "BAM/header", 60);
0659                  PutWholeSector(legacyHDOSstate, (BAM *) bs, drive, dirtrack, HEADERSECT);
0660                }
0661
0662                void BAMAllocateTracks(unsigned char legacyHDOSstate, unsigned char side,
0663                                       unsigned char starttrack, unsigned char endtrack) {
0664                  unsigned char track80;
0665                  unsigned char sector;
0666
0667                  GetBAM(legacyHDOSstate, side);
0668                  for (track80 = starttrack; track80 <= endtrack; track80++)  {
0669                    for (sector = 0; sector < 40; sector++)  {
0670                      BAMSectorUpdate(BAMsector[0], BAMsector[1], track80, sector, 1); // 1=allocate
0671                    }
0672                  }
0673                }
0674
0675                // @@@@ this has old filename handling and uses a BAM sector instead
0676                // @@@@ of passing a pointer:
0677                void getDiskname(unsigned char legacyHDOSstate,
0678                                 unsigned char drive, unsigned char dirtrack, char* diskname) {
0679                  HEADER* hs;
0680                  unsigned char i;
0681
0682                  // _miniInit();
0683
0684                  if (GetOneSector(legacyHDOSstate,
0685                                   BAMsector[0], drive, dirtrack, HEADERSECT) < 2)  {
0686                    hs = (HEADER*) BAMsector[0];
0687
0688                    i = 0;
0689                    while (hs->diskname[i] != 0xa0 && i < DOSFILENAMELEN)  {
0690                      diskname[i] = hs->diskname[i];
0691                      i++;
0692                    }
0693                    diskname[i] = 0;
0694                  } else {
0695                    strcopy("read error", (char *) diskname, 16);
0696                  }
0697                }
0698
0699                unsigned char readblockchain(unsigned char legacyHDOSstate,
0700                                             uint32_t destination_address,
0701                                             unsigned int maxblocks, unsigned char drive,
0702                                             unsigned char track, unsigned char sector)  {
0703                  unsigned int i;
0704                  unsigned char nexttrack;
0705                  unsigned char nextsector;
0706
0707                  // _miniInit();
0708                  nexttrack = track;
0709                  nextsector = sector;
0710                #ifdef DEBUG
0711                        mprintf("readblockchain first nexttrack ", nexttrack);
0712                        mprintf(" nextsector ", nextsector);
0713                        cputln();
0714                #endif
0715
0716                  for (i = 0; i < maxblocks; i++)  {
0717                    if (GetOneSector(legacyHDOSstate,
0718                                     worksectorasBAM[0], drive, nexttrack, nextsector) > 1)  {
0719                      return(0xff);
0720                    }
0721                    DATABLOCK* ws = worksector[0];
0722                    nexttrack = ws->chntrack;
0723                    nextsector = ws->chnsector;
0724                #ifdef DEBUG
0725                        mprintf("nexttrack ", nexttrack);
0726                        mprintf(" nextsector ", nextsector);
0727                //        mprintf(" workside ", workside);
0728                        cputln();
0729                        mprintf(" block ", i);
0730                        mh4printf(" is: ", (long) &ws);
0731                        cputln();
0732                        mh4printf(" worksector[0]: ", (long) worksector[0]);
0733                        mh4printf(" worksectorasBAM[0]: ", (long) worksectorasBAM[0]);
0734                        cputln();
0735                        cgetc();
0736                #endif
0737                    // lcopy(uint32_t source_address, uint32_t destination_address, uint16_t count);
0738                    lcopy((uint32_t) ws, destination_address + i * BLOCKSIZE, BLOCKSIZE);
0739                    
0740                    if (nexttrack == 0)  break;
0741                  }
0742                  
0743                  if (nexttrack > 0)  {
0744                    return(0xfe);
0745                  }
0746                  return 0;
0747                }
0748
0749                unsigned char isallocatedBAMtracksector(unsigned char track,
0750                                                        unsigned char sector)  {
0751                  unsigned char bitshifter = 1;
0752                  BAM* bs;
0753
0754                  track--;  // zero based array access
0755                  if (track < 40)  {
0756                    bs = BAMsector[0];
0757                  } else {
0758                    track = track - 40;
0759                    bs = BAMsector[1];
0760                  }
0761                  if (sector < 8)  {
0762                    if (!(bs->entry[track].alloc1 & (bitshifter << sector)))  {
0763                #ifdef DEBUG
0764                        gotoxy(42, 7);
0765                        mprintf("t=", track);
0766                        mprintf(" s=", sector);
0767                        mprintf(" nt=", bs->chntrack);
0768                        mprintf(" ns=", bs->chnsector);
0769                        mprintf(" a1=", bs->entry[track].alloc1);
0770                        cgetc();
0771                #endif
0772                      return TRUE;
0773                    }
0774                  }
0775                  else if (sector < 16)  {
0776                    if (!(bs->entry[track].alloc2 & (bitshifter << (sector - 8))))  {
0777                #ifdef DEBUG
0778                        gotoxy(42, 8);
0779                        mprintf("t=", track);
0780                        mprintf(" s=", sector);
0781                        mprintf(" nt=", bs->chntrack);
0782                        mprintf(" ns=", bs->chnsector);
0783                        cgetc();
0784                #endif
0785                      return TRUE;
0786                    }
0787                  }
0788                  else if (sector < 24)  {
0789                    if (!(bs->entry[track].alloc3 & (bitshifter << (sector - 16))))  {
0790                #ifdef DEBUG
0791                        gotoxy(42, 9);
0792                        mprintf("t=", track);
0793                        mprintf(" s=", sector);
0794                        mprintf(" nt=", bs->chntrack);
0795                        mprintf(" ns=", bs->chnsector);
0796                        cgetc();
0797                #endif
0798                      return TRUE;
0799                    }
0800                  }
0801                  else if (sector < 32)  {
0802                    if (!(bs->entry[track].alloc4 & (bitshifter << (sector - 24))))  {
0803                #ifdef DEBUG
0804                        gotoxy(42, 10);
0805                        mprintf("t=", track);
0806                        mprintf(" s=", sector);
0807                        mprintf(" nt=", bs->chntrack);
0808                        mprintf(" ns=", bs->chnsector);
0809                        cgetc();
0810                #endif
0811                      return TRUE;
0812                    }
0813                  }
0814                  else  {
0815                    if (!(bs->entry[track].alloc5 & (bitshifter << (sector - 32))))  {
0816                #ifdef DEBUG
0817                        gotoxy(42, 11);
0818                        mprintf("t=", track);
0819                        mprintf(" s=", sector);
0820                        mprintf(" nt=", bs->chntrack);
0821                        mprintf(" ns=", bs->chnsector);
0822                        cgetc();
0823                #endif
0824                      return TRUE;
0825                    }
0826                  }
0827                  return FALSE;
0828                }
0829
0830                // track40 = TRUE lets search for an empty sector in dirtrack:
0831                void findnextBAMtracksector(unsigned char * nexttrack, unsigned char * nextsector,
0832                                        unsigned char track40, unsigned char dirtrack,
0833                                        unsigned char firsttrack, unsigned char lasttrack)  {
0834                  unsigned char bitshifter = 1;
0835                  unsigned char track80;
0836                  unsigned char track;
0837                  unsigned char i;
0838                  unsigned char sector;
0839                  unsigned char done = 0; //      0   1   2   3   4   5   6   7   8   9
0840                  unsigned char strategy[80] = { 38, 41, 40, 42, 37, 43, 36, 44, 35, 45,
0841                                                 34, 46, 33, 47, 32, 48, 31, 49, 30, 50,
0842                                                 29, 51, 28, 52, 27, 53, 26, 54, 25, 55,
0843                                                 24, 56, 23, 57, 22, 58, 21, 59, 20, 60,
0844                                                 19, 61, 18, 62, 17, 63, 16, 64, 15, 65,
0845                                                 14, 66, 13, 67, 12, 68, 11, 69, 10, 70,
0846                                                  9, 71,  8, 72,  7, 73,  6, 74,  5, 75,
0847                                                  4, 76,  3, 77,  2, 78,  1, 79,  0, 39 };
0848                  BAM* bs;
0849
0850                  // access track array zero based
0851                  // track strategy on track 40 is overridden by leaping to the following
0852                  // track of element [0] := 38 + 1 ==> track 39, physical 40
0853                  for (i = (firsttrack - 1); i < lasttrack; i++)  {
0854                    if (dirtrack != HEADERTRACK)  {
0855                      if (!track40 && i == (firsttrack - 1))  i++; // BAM strategy is different
0856                      track80 = i;  // no strategy for subpartitions
0857                    } else {
0858                      track80 = strategy[i];
0859                      if (track40)       track80++;    // BAM strategy is different
0860                      if (track80 > 79)  track80 = 0;
0861                      // next BAM sector of two in total:
0862                    }
0863                    if (track80 < 40)  {
0864                      track = track80;
0865                      bs = BAMsector[0];
0866                    } else {
0867                      track = track80 - 40;
0868                      bs = BAMsector[1];
0869                    }
0870                    for (sector = 0; sector <= 39; sector++)  {
0871                      if (sector < 8)  {
0872                        if (bs->entry[track].alloc1 & (bitshifter << sector))  {
0873                          done = 1;
0874                #ifdef DEBUG
0875                        gotoxy(42, 7);
0876                        mprintf("t=", track);
0877                        mprintf(" s=", sector);
0878                        mprintf(" nt=", bs->chntrack);
0879                        mprintf(" ns=", bs->chnsector);
0880                        mprintf(" a1=", bs->entry[track].alloc1);
0881                        cgetc();
0882                #endif
0883                          break;
0884                        }
0885                      }
0886                      else if (sector < 16)  {
0887                        if (bs->entry[track].alloc2 & (bitshifter << (sector - 8)))  {
0888                          done = 1;
0889                #ifdef DEBUG
0890                        gotoxy(42, 8);
0891                        mprintf("t=", track);
0892                        mprintf(" s=", sector);
0893                        mprintf(" nt=", bs->chntrack);
0894                        mprintf(" ns=", bs->chnsector);
0895                        cgetc();
0896                #endif
0897                          break;
0898                        }
0899                      }
0900                      else if (sector < 24)  {
0901                        if (bs->entry[track].alloc3 & (bitshifter << (sector - 16)))  {
0902                          done = 1;
0903                #ifdef DEBUG
0904                        gotoxy(42, 9);
0905                        mprintf("t=", track);
0906                        mprintf(" s=", sector);
0907                        mprintf(" nt=", bs->chntrack);
0908                        mprintf(" ns=", bs->chnsector);
0909                        cgetc();
0910                #endif
0911                          break;
0912                        }
0913                      }
0914                      else if (sector < 32)  {
0915                        if (bs->entry[track].alloc4 & (bitshifter << (sector - 24)))  {
0916                          done = 1;
0917                #ifdef DEBUG
0918                        gotoxy(42, 10);
0919                        mprintf("t=", track);
0920                        mprintf(" s=", sector);
0921                        mprintf(" nt=", bs->chntrack);
0922                        mprintf(" ns=", bs->chnsector);
0923                        cgetc();
0924                #endif
0925                          break;
0926                        }
0927                      }
0928                      else  {
0929                        if (bs->entry[track].alloc5 & (bitshifter << (sector - 32)))  {
0930                          done = 1;
0931                #ifdef DEBUG
0932                        gotoxy(42, 11);
0933                        mprintf("t=", track);
0934                        mprintf(" s=", sector);
0935                        mprintf(" nt=", bs->chntrack);
0936                        mprintf(" ns=", bs->chnsector);
0937                        cgetc();
0938                #endif
0939                          break;
0940                        }
0941                      }
0942                      if (done)  break;
0943                    }
0944                    if (done)  break;
0945                  }
0946                  track80++;  // access array zero based, but tracks are 1..80
0947
0948                  if (done)  {
0949                    BAMSectorUpdate(BAMsector[0], BAMsector[1], track80, sector, 1); // 1=allocate
0950                  
0951                    // return values:
0952                    *nexttrack  = track80;
0953                    *nextsector = sector;
0954                  } else {
0955                    *nexttrack  = 0xff;
0956                    *nextsector = 0;
0957                  }
0958                }
0959
0960                // ignores start track and sector upon call but gives them back:
0961                void writeblockchain(unsigned char legacyHDOSstate,
0962                                     uint32_t source_address,
0963                                     unsigned int maxblocks, unsigned char drive,
0964                                     unsigned char * starttrack, unsigned char * startsector,
0965                                     unsigned char dirtrack, unsigned char dirtrackflag,
0966                                     unsigned char firsttrack, unsigned char lasttrack)  {
0967                  unsigned int i;
0968                  unsigned char nexttrack = 0;
0969                  unsigned char nextsector = 0xff;
0970                  unsigned char track;
0971                  unsigned char sector;
0972
0973                  // _miniInit();
0974                  DATABLOCK* ws = worksector[0];
0975                  DATABLOCK* ws1 = worksector[1];
0976
0977                  // get a first sector anyway:
0978                  findnextBAMtracksector(&track, &sector, dirtrackflag, dirtrack,
0979                                         firsttrack, lasttrack);
0980                  *starttrack = track;  // to later write dirent
0981                  *startsector = sector;
0982                  
0983                  for (i = 0; i < maxblocks; i++)  {
0984                    lcopy(source_address + i * BLOCKSIZE, (uint32_t) ws, BLOCKSIZE);
0985
0986                #ifdef DEBUG
0987                        mprintf("nexttrack ", nexttrack);
0988                        mprintf(" nextsector ", nextsector);
0989                        mprintf(" block ", i);
0990                        mh4printf(" is: ", (long) &ws);
0991                        mh4printf(" worksector[0]: ", (long) worksector[0]);
0992                        cputln();
0993                        cgetc();
0994                #endif
0995
0996                    // replace chain with available ones or leave 0 if last datablock:
0997                    if (ws->chntrack > 0)  {
0998                      findnextBAMtracksector(&nexttrack, &nextsector, dirtrackflag, dirtrack,
0999                                             firsttrack, lasttrack);
1000                      ws->chntrack = nexttrack;
1001                      ws->chnsector = nextsector;
1002                    }
1003                    // is there a second sector to combine write a physical sector?
1004                    if (ws->chntrack > 0 && track == ws->chntrack &&
1005                        (sector / 2) == (ws->chnsector / 2))  {
1006                      i++;
1007                      lcopy(source_address + i * BLOCKSIZE, (uint32_t) ws1, BLOCKSIZE);
1008                      if (ws1->chntrack > 0)  {
1009                        findnextBAMtracksector(&nexttrack, &nextsector, dirtrackflag, dirtrack,
1010                                               firsttrack, lasttrack);
1011                        ws1->chntrack = nexttrack;
1012                        ws1->chnsector = nextsector;
1013                      }
1014                #ifdef DEBUG
1015                        mprintf("double sectors, track=", track);
1016                        mprintf(" sector=", sector);
1017                        cputln();
1018                        cgetc();
1019                #endif
1020                      PutWholeSector(legacyHDOSstate, (BAM *) ws, drive, track, sector);
1021                      ws->chntrack = ws1->chntrack; // fake to abort below if zero
1022                    } else {
1023                #ifdef DEBUG
1024                        mprintf("single sectors, track=", track);
1025                        mprintf(" sector=", sector);
1026                        cputln();
1027                        cgetc();
1028                #endif
1029                      PutOneSector(legacyHDOSstate, (BAM *) ws, drive, track, sector);
1030                    }
1031
1032                    if (ws->chntrack == 0)  break;
1033                    track = nexttrack;
1034                    sector = nextsector;
1035                  }
1036                  
1037                  if (nexttrack > 0 && i >= maxblocks)  {
1038                    messagebox(MBOXNUMBER, "Writing file,", "number of sectors too big",
1039                                           "max", (long) maxblocks);
1040                  }
1041                }
1042
1043                // not physically deleting but BAM deallocating:
1044                unsigned char deleteblockchain(unsigned char legacyHDOSstate,
1045                                               unsigned char drive, unsigned char dirtrack,
1046                                               unsigned char track, unsigned char sector)  {
1047                  unsigned char nexttrack;
1048                  unsigned char nextsector;
1049                  BAM* bs;
1050
1051                  // _miniInit();
1052                  if (GetOneSector(legacyHDOSstate,
1053                                   BAMsector[0], drive, dirtrack, BAMSECT) > 1)  {
1054                    return 0xff;
1055                  }
1056                  bs = BAMsector[0];
1057                  if (GetOneSector(legacyHDOSstate,
1058                                   BAMsector[1], drive, bs->chntrack, bs->chnsector) > 1)  {
1059                    return 0xfe;
1060                  }
1061
1062                  nexttrack = track;
1063                  nextsector = sector;
1064                #ifdef DEBUG
1065                        mprintf("nexttrack ", nexttrack);
1066                        mprintf(" nextsector ", nextsector);
1067                        cputln();
1068                #endif
1069                  while (nexttrack > 0)  {
1070                    /* workside = */ GetOneSector(legacyHDOSstate,
1071                                          worksectorasBAM[0], drive, nexttrack, nextsector);
1072                    DATABLOCK* ws = worksector[0];
1073                    BAMSectorUpdate(BAMsector[0], BAMsector[1], nexttrack, nextsector, 0); // 0=free up
1074                #ifdef DEBUG
1075                        gotoxy(42, 0);
1076                        mprintf("nexttrack ", nexttrack);
1077                        mprintf(" nextsector ", nextsector);
1078                //        mprintf(" workside ", workside);
1079                        cputln();
1080                        gotoxy(42, 1);
1081                        mh4printf(" block is: ", (long) &ws);
1082                        cputln();
1083                        gotoxy(42, 2);
1084                        mh4printf(" worksector[0]: ", (long) worksector[0]);
1085                        cputln();
1086                        cgetc();
1087                #endif
1088                    nexttrack = ws->chntrack;
1089                    nextsector = ws->chnsector;
1090                  }
1091                  PutOneSector(legacyHDOSstate, BAMsector[0], drive, dirtrack, BAMSECT);
1092                  PutOneSector(legacyHDOSstate,
1093                               BAMsector[1], drive, bs->chntrack, bs->chnsector);
1094                  return 0;
1095                }
1096
1097                extern unsigned char s[]; // @@@@
1098                char * tracksectorstring(unsigned char track, unsigned char sector)  {
1099                  unsigned int  i;
1100
1101                  i = 0;
1102                  s[i++] = 'T'; // @@ is this now how I want things to be?
1103                  s[i++] = 'r';
1104                  s[i++] = 'a';
1105                  s[i++] = 'c';
1106                  s[i++] = 'k';
1107                  s[i++] = ':';
1108                  s[i++] = ' ';
1109                  s[i++] = track / 10 + 48; // digit screen codes
1110                  s[i++] = track % 10 + 48;
1111                  s[i++] = ' ';
1112                  s[i++] = 'S';
1113                  s[i++] = 'e';
1114                  s[i++] = 'c';
1115                  s[i++] = 't';
1116                  s[i++] = 'o';
1117                  s[i++] = 'r';
1118                  s[i++] = ':';
1119                  s[i++] = ' ';
1120                  s[i++] = sector / 10 + 48;
1121                  s[i++] = sector % 10 + 48;
1122                  s[i++] = 0;
1123                  return (char*) s;
1124                }
    \ 0034 20....               jsr     _IncVsp
    \ 0037 60                   rts
    \ 0000                      .section code,text
    \ 0000                      .public BAMSectorUpdate
    \ 0000          BAMSectorUpdate:
    \ 0000 85..                 sta     zp:_Zp+6
    \ 0002 a5..                 lda     zp:_Zp+5
    \ 0004 85..                 sta     zp:_Zp+7
    \ 0006 20....               jsr     `?L1447`
    \ 0009 a328                 ldz     #40
    \ 000b d4..                 cpz     zp:_Zp+6
    \ 000d b009                 bcs     `?L126`
    \ 000f a5..                 lda     zp:_Zp+6
    \ 0011 38                   sec
    \ 0012 e928                 sbc     #40
    \ 0014 85..                 sta     zp:_Zp+6
    \ 0016 8005                 bra     `?L127`
    \ 0018          `?L126`:
    \ 0018 20....               jsr     `?L1436`
    \ 001b 85..                 sta     zp:_Zp+3
    \ 001d          `?L127`:
    \ 001d c6..                 dec     zp:_Zp+6
    \ 001f a5..                 lda     zp:_Zp+6
    \ 0021 85..                 sta     zp:_Zp+8
    \ 0023 a5..                 lda     zp:_Zp+7
    \ 0025 f3c200               lbeq    `?L129`
    \ 0028 ab....               ldz     _Zp+4
    \ 002b c208                 cpz     #8
    \ 002d b017                 bcs     `?L132`
    \ 002f 20....               jsr     `?L1295`
    \ 0032 9002                 bcc     `?L764`
    \ 0034 e6..                 inc     zp:_Zp+7
    \ 0036          `?L764`:
    \ 0036 e3..                 inw     zp:_Zp+6
    \ 0038 a6..                 ldx     zp:_Zp+4
    \ 003a f005                 beq     `?L766`
    \ 003c          `?L767`:
    \ 003c 06..                 asl     zp:_Zp+5
    \ 003e ca                   dex
    \ 003f d0fb                 bne     `?L767`
    \ 0041          `?L766`:
    \ 0041 a5..                 lda     zp:_Zp+5
    \ 0043 4c....               jmp     `?L1262`
    \ 0046          `?L132`:
    \ 0046 ab....               ldz     _Zp+4
    \ 0049 c210                 cpz     #16
    \ 004b b017                 bcs     `?L135`
    \ 004d 20....               jsr     `?L1295`
    \ 0050 9002                 bcc     `?L769`
    \ 0052 e6..                 inc     zp:_Zp+7
    \ 0054          `?L769`:
    \ 0054 20....               jsr     `?L1356`
    \ 0057 38                   sec
    \ 0058 e908                 sbc     #8
    \ 005a aa                   tax
    \ 005b f069                 beq     `?L788`
    \ 005d          `?L772`:
    \ 005d 06..                 asl     zp:_Zp
    \ 005f ca                   dex
    \ 0060 d0fb                 bne     `?L772`
    \ 0062 8062                 bra     `?L788`
    \ 0064          `?L135`:
    \ 0064 ab....               ldz     _Zp+4
    \ 0067 c218                 cpz     #24
    \ 0069 b019                 bcs     `?L138`
    \ 006b 20....               jsr     `?L1295`
    \ 006e 9002                 bcc     `?L774`
    \ 0070 e6..                 inc     zp:_Zp+7
    \ 0072          `?L774`:
    \ 0072 e3..                 inw     zp:_Zp+6
    \ 0074 20....               jsr     `?L1356`
    \ 0077 38                   sec
    \ 0078 e910                 sbc     #16
    \ 007a aa                   tax
    \ 007b f049                 beq     `?L788`
    \ 007d          `?L777`:
    \ 007d 06..                 asl     zp:_Zp
    \ 007f ca                   dex
    \ 0080 d0fb                 bne     `?L777`
    \ 0082 8042                 bra     `?L788`
    \ 0084          `?L138`:
    \ 0084 ab....               ldz     _Zp+4
    \ 0087 c220                 cpz     #32
    \ 0089 b01b                 bcs     `?L141`
    \ 008b 20....               jsr     `?L1295`
    \ 008e 9002                 bcc     `?L779`
    \ 0090 e6..                 inc     zp:_Zp+7
    \ 0092          `?L779`:
    \ 0092 e3..                 inw     zp:_Zp+6
    \ 0094 e3..                 inw     zp:_Zp+6
    \ 0096 20....               jsr     `?L1356`
    \ 0099 38                   sec
    \ 009a e918                 sbc     #24
    \ 009c aa                   tax
    \ 009d f027                 beq     `?L788`
    \ 009f          `?L782`:
    \ 009f 06..                 asl     zp:_Zp
    \ 00a1 ca                   dex
    \ 00a2 d0fb                 bne     `?L782`
    \ 00a4 8020                 bra     `?L788`
    \ 00a6          `?L141`:
    \ 00a6 20....               jsr     `?L1295`
    \ 00a9 9002                 bcc     `?L784`
    \ 00ab e6..                 inc     zp:_Zp+7
    \ 00ad 18       `?L784`:    clc
    \ 00ae a5..                 lda     zp:_Zp+6
    \ 00b0 6905                 adc     #5
    \ 00b2 85..                 sta     zp:_Zp+6
    \ 00b4 9002                 bcc     `?L786`
    \ 00b6 e6..                 inc     zp:_Zp+7
    \ 00b8          `?L786`:
    \ 00b8 20....               jsr     `?L1357`
    \ 00bb 38                   sec
    \ 00bc e920                 sbc     #32
    \ 00be aa                   tax
    \ 00bf f005                 beq     `?L788`
    \ 00c1          `?L789`:
    \ 00c1 06..                 asl     zp:_Zp
    \ 00c3 ca                   dex
    \ 00c4 d0fb                 bne     `?L789`
    \ 00c6          `?L788`:
    \ 00c6 a5..                 lda     zp:_Zp
    \ 00c8 49ff     `?L1262`:   eor     #-1
    \ 00ca a300                 ldz     #0
    \ 00cc 32..                 and     (_Zp+6),z
    \ 00ce 92..                 sta     (_Zp+6),z
    \ 00d0 20....               jsr     `?L1363`
    \ 00d3 20....               jsr     `?L1322`
    \ 00d6 18                   clc
    \ 00d7 a5..                 lda     zp:_Zp+2
    \ 00d9 65..                 adc     zp:_Zp
    \ 00db 85..                 sta     zp:_Zp+2
    \ 00dd 9002                 bcc     `?L791`
    \ 00df e6..                 inc     zp:_Zp+3
    \ 00e1 a000     `?L791`:    ldy     #0
    \ 00e3 b1..                 lda     (_Zp+2),y
    \ 00e5 3a                   dec     a
    \ 00e6 91..                 sta     (_Zp+2),y
    \ 00e8 60                   rts
    \ 00e9          `?L129`:
    \ 00e9 ab....               ldz     _Zp+4
    \ 00ec c208                 cpz     #8
    \ 00ee b017                 bcs     `?L144`
    \ 00f0 20....               jsr     `?L1295`
    \ 00f3 9002                 bcc     `?L793`
    \ 00f5 e6..                 inc     zp:_Zp+7
    \ 00f7          `?L793`:
    \ 00f7 e3..                 inw     zp:_Zp+6
    \ 00f9 a6..                 ldx     zp:_Zp+4
    \ 00fb f005                 beq     `?L795`
    \ 00fd          `?L796`:
    \ 00fd 06..                 asl     zp:_Zp+5
    \ 00ff ca                   dex
    \ 0100 d0fb                 bne     `?L796`
    \ 0102          `?L795`:
    \ 0102 a5..                 lda     zp:_Zp+5
    \ 0104 4c....               jmp     `?L1261`
    \ 0107          `?L144`:
    \ 0107 ab....               ldz     _Zp+4
    \ 010a c210                 cpz     #16
    \ 010c b017                 bcs     `?L147`
    \ 010e 20....               jsr     `?L1295`
    \ 0111 9002                 bcc     `?L798`
    \ 0113 e6..                 inc     zp:_Zp+7
    \ 0115          `?L798`:
    \ 0115 20....               jsr     `?L1356`
    \ 0118 38                   sec
    \ 0119 e908                 sbc     #8
    \ 011b aa                   tax
    \ 011c f047                 beq     `?L810`
    \ 011e          `?L801`:
    \ 011e 06..                 asl     zp:_Zp
    \ 0120 ca                   dex
    \ 0121 d0fb                 bne     `?L801`
    \ 0123 8040                 bra     `?L810`
    \ 0125          `?L147`:
    \ 0125 ab....               ldz     _Zp+4
    \ 0128 c218                 cpz     #24
    \ 012a b019                 bcs     `?L150`
    \ 012c 20....               jsr     `?L1295`
    \ 012f 9002                 bcc     `?L803`
    \ 0131 e6..                 inc     zp:_Zp+7
    \ 0133          `?L803`:
    \ 0133 e3..                 inw     zp:_Zp+6
    \ 0135 20....               jsr     `?L1356`
    \ 0138 38                   sec
    \ 0139 e910                 sbc     #16
    \ 013b aa                   tax
    \ 013c f027                 beq     `?L810`
    \ 013e          `?L806`:
    \ 013e 06..                 asl     zp:_Zp
    \ 0140 ca                   dex
    \ 0141 d0fb                 bne     `?L806`
    \ 0143 8020                 bra     `?L810`
    \ 0145          `?L150`:
    \ 0145 ab....               ldz     _Zp+4
    \ 0148 c220                 cpz     #32
    \ 014a b01d                 bcs     `?L153`
    \ 014c 20....               jsr     `?L1295`
    \ 014f 9002                 bcc     `?L808`
    \ 0151 e6..                 inc     zp:_Zp+7
    \ 0153          `?L808`:
    \ 0153 e3..                 inw     zp:_Zp+6
    \ 0155 e3..                 inw     zp:_Zp+6
    \ 0157 20....               jsr     `?L1356`
    \ 015a 38                   sec
    \ 015b e918                 sbc     #24
    \ 015d aa                   tax
    \ 015e f005                 beq     `?L810`
    \ 0160          `?L811`:
    \ 0160 06..                 asl     zp:_Zp
    \ 0162 ca                   dex
    \ 0163 d0fb                 bne     `?L811`
    \ 0165          `?L810`:
    \ 0165 a5..                 lda     zp:_Zp
    \ 0167 8021                 bra     `?L1261`
    \ 0169          `?L153`:
    \ 0169 20....               jsr     `?L1295`
    \ 016c 9002                 bcc     `?L813`
    \ 016e e6..                 inc     zp:_Zp+7
    \ 0170 18       `?L813`:    clc
    \ 0171 a5..                 lda     zp:_Zp+6
    \ 0173 6905                 adc     #5
    \ 0175 85..                 sta     zp:_Zp+6
    \ 0177 9002                 bcc     `?L815`
    \ 0179 e6..                 inc     zp:_Zp+7
    \ 017b          `?L815`:
    \ 017b a5..                 lda     zp:_Zp+4
    \ 017d 38                   sec
    \ 017e e920                 sbc     #32
    \ 0180 aa                   tax
    \ 0181 f005                 beq     `?L817`
    \ 0183          `?L818`:
    \ 0183 06..                 asl     zp:_Zp+5
    \ 0185 ca                   dex
    \ 0186 d0fb                 bne     `?L818`
    \ 0188          `?L817`:
    \ 0188 a5..                 lda     zp:_Zp+5
    \ 018a a300     `?L1261`:   ldz     #0
    \ 018c 12..                 ora     (_Zp+6),z
    \ 018e 92..                 sta     (_Zp+6),z
    \ 0190 20....               jsr     `?L1363`
    \ 0193 20....               jsr     `?L1322`
    \ 0196 18                   clc
    \ 0197 a5..                 lda     zp:_Zp+2
    \ 0199 65..                 adc     zp:_Zp
    \ 019b 85..                 sta     zp:_Zp+2
    \ 019d 9002                 bcc     `?L820`
    \ 019f e6..                 inc     zp:_Zp+3
    \ 01a1 a901     `?L820`:    lda     #1
    \ 01a3 18                   clc
    \ 01a4 72..                 adc     (_Zp+2),z
    \ 01a6 92..                 sta     (_Zp+2),z
    \ 01a8 60                   rts
    \ 0000                      .section code,text
    \ 0000                      .public BAMSectorsFreeBlocks
    \ 0000          BAMSectorsFreeBlocks:
    \ 0000 85..                 sta     zp:_Zp+12
    \ 0002 a5..                 lda     zp:_Zp
    \ 0004 85..                 sta     zp:_Zp+10
    \ 0006 a5..                 lda     zp:_Zp+1
    \ 0008 85..                 sta     zp:_Zp+11
    \ 000a a900                 lda     #0
    \ 000c 85..                 sta     zp:_Zp
    \ 000e 85..                 sta     zp:_Zp+1
    \ 0010 c6..                 dec     zp:_Zp+4
    \ 0012          `?L160`:
    \ 0012 ab....               ldz     _Zp+4
    \ 0015 d4..                 cpz     zp:_Zp+5
    \ 0017 9001                 bcc     `?L159`
    \ 0019 60                   rts
    \ 001a          `?L159`:
    \ 001a ab....               ldz     _Zp+4
    \ 001d c228                 cpz     #40
    \ 001f b006                 bcs     `?L163`
    \ 0021 a5..                 lda     zp:_Zp+4
    \ 0023 85..                 sta     zp:_Zp+6
    \ 0025 800f                 bra     `?L164`
    \ 0027          `?L163`:
    \ 0027 a5..                 lda     zp:_Zp+4
    \ 0029 38                   sec
    \ 002a e928                 sbc     #40
    \ 002c 85..                 sta     zp:_Zp+6
    \ 002e a5..                 lda     zp:_Zp+2
    \ 0030 85..                 sta     zp:_Zp+10
    \ 0032 a5..                 lda     zp:_Zp+3
    \ 0034 85..                 sta     zp:_Zp+11
    \ 0036          `?L164`:
    \ 0036 a5..                 lda     zp:_Zp+4
    \ 0038 a6..                 ldx     zp:_Zp+12
    \ 003a 86..                 stx     zp:_Zp+8
    \ 003c a200                 ldx     #0
    \ 003e 86..                 stx     zp:_Zp+9
    \ 0040 c3..                 dew     zp:_Zp+8
    \ 0042 38                   sec
    \ 0043 e5..                 sbc     zp:_Zp+8
    \ 0045 05..                 ora     zp:_Zp+9
    \ 0047 f03c                 beq     `?L161`
    \ 0049 a6..                 ldx     zp:_Zp+6
    \ 004b 20....               jsr     `?L1441`
    \ 004e cb....               asw     _Zp+8
    \ 0051 a5..                 lda     zp:_Zp+8
    \ 0053 85..                 sta     zp:_Zp+6
    \ 0055 cb....               asw     _Zp+8
    \ 0058 a5..                 lda     zp:_Zp+8
    \ 005a 18                   clc
    \ 005b 65..                 adc     zp:_Zp+6
    \ 005d 85..                 sta     zp:_Zp+6
    \ 005f a5..                 lda     zp:_Zp+10
    \ 0061 18                   clc
    \ 0062 6910                 adc     #16
    \ 0064 85..                 sta     zp:_Zp+8
    \ 0066 a5..                 lda     zp:_Zp+11
    \ 0068 6900                 adc     #0
    \ 006a 85..                 sta     zp:_Zp+9
    \ 006c 18                   clc
    \ 006d a5..                 lda     zp:_Zp+8
    \ 006f 65..                 adc     zp:_Zp+6
    \ 0071 85..                 sta     zp:_Zp+8
    \ 0073 9002                 bcc     `?L822`
    \ 0075 e6..                 inc     zp:_Zp+9
    \ 0077 a000     `?L822`:    ldy     #0
    \ 0079 b1..                 lda     (_Zp+8),y
    \ 007b 18                   clc
    \ 007c 65..                 adc     zp:_Zp
    \ 007e 85..                 sta     zp:_Zp
    \ 0080 98                   tya
    \ 0081 65..                 adc     zp:_Zp+1
    \ 0083 85..                 sta     zp:_Zp+1
    \ 0085          `?L161`:
    \ 0085 e6..                 inc     zp:_Zp+4
    \ 0087 8089                 bra     `?L160`
    \ 0000                      .section code,text
    \ 0000                      .public FreeBlocks
    \ 0000          FreeBlocks:
    \ 0000 20....               jsr     `?L1372`
    \ 0003 a6..                 ldx     zp:_Zp+1
    \ 0005 86..                 stx     zp:_Zp+26
    \ 0007 a6..                 ldx     zp:_Zp+2
    \ 0009 86..                 stx     zp:_Zp+25
    \ 000b a6..                 ldx     zp:_Zp+3
    \ 000d 86..                 stx     zp:_Zp+24
    \ 000f 20....               jsr     GetBAM
    \ 0012 a5..                 lda     zp:_Zp+24
    \ 0014 85..                 sta     zp:_Zp+5
    \ 0016 a5..                 lda     zp:_Zp+25
    \ 0018 20....               jsr     `?L1313`
    \ 001b a5..                 lda     zp:_Zp+26
    \ 001d 4c....               jmp     `?L1294`
    \ 0000                      .section code,text
    \ 0000                      .public BAMCheckSizeinFilebuffer
    \ 0000          BAMCheckSizeinFilebuffer:
    \ 0000 20....               jsr     `?L1372`
    \ 0003 85..                 sta     zp:_Zp+8
    \ 0005 a5..                 lda     zp:_Zp
    \ 0007 85..                 sta     zp:_Zp+6
    \ 0009 20....               jsr     `?L1380`
    \ 000c a5..                 lda     zp:_Zp+4
    \ 000e 85..                 sta     zp:_Zp+26
    \ 0010 20....               jsr     `?L1414`
    \ 0013 a5..                 lda     zp:_Zp+24
    \ 0015 85..                 sta     zp:_Zp+7
    \ 0017 20....               jsr     `?L1448`
    \ 001a a26a                 ldx     #106
    \ 001c a308                 ldz     #8
    \ 001e 424285..             stq     zp:_Zp
    \ 0022 a5..                 lda     zp:_Zp+8
    \ 0024 20....               jsr     `?L1429`
    \ 0027 ad....               lda     BAMsector
    \ 002a 85..                 sta     zp:_Zp+4
    \ 002c ad....               lda     BAMsector+1
    \ 002f 85..                 sta     zp:_Zp+5
    \ 0031 20....               jsr     `?L1332`
    \ 0034 85..                 sta     zp:_Zp+6
    \ 0036 85..                 sta     zp:_Zp+7
    \ 0038 a26a                 ldx     #106
    \ 003a a308                 ldz     #8
    \ 003c 424285..             stq     zp:_Zp
    \ 0040 20....               jsr     lcopy
    \ 0043 a001                 ldy     #1
    \ 0045 20....               jsr     _IncVsp
    \ 0048 a5..                 lda     zp:_Zp+26
    \ 004a 85..                 sta     zp:_Zp+5
    \ 004c a5..                 lda     zp:_Zp+25
    \ 004e 20....               jsr     `?L1313`
    \ 0051 a5..                 lda     zp:_Zp+24
    \ 0053          `?L1294`:
    \ 0053 20....               jsr     BAMSectorsFreeBlocks
    \ 0056 a002                 ldy     #2
    \ 0058 4c....               jmp     _RestoreRegisters
    \ 0000                      .section code,text
    \ 0000                      .public BAMFreeTracksinaRow
    \ 0000          BAMFreeTracksinaRow:
    \ 0000 85..                 sta     zp:_Zp+12
    \ 0002 a000                 ldy     #0
    \ 0004 b1..                 lda     (_Vsp),y
    \ 0006 85..                 sta     zp:_Zp+14
    \ 0008 c8                   iny
    \ 0009 b1..                 lda     (_Vsp),y
    \ 000b 85..                 sta     zp:_Zp+15
    \ 000d a900                 lda     #0
    \ 000f 85..                 sta     zp:_Zp+17
    \ 0011 85..                 sta     zp:_Zp+16
    \ 0013 85..                 sta     zp:_Zp+13
    \ 0015 88                   dey
    \ 0016 91..                 sta     (_Zp+6),y
    \ 0018 91..                 sta     (_Zp+14),y
    \ 001a c6..                 dec     zp:_Zp+12
    \ 001c          `?L182`:
    \ 001c ab....               ldz     _Zp+12
    \ 001f d4..                 cpz     zp:_Zp+4
    \ 0021 902e                 bcc     `?L181`
    \ 0023 a6..                 ldx     zp:_Zp+4
    \ 0025 86..                 stx     zp:_Zp
    \ 0027 98                   tya
    \ 0028 85..                 sta     zp:_Zp+1
    \ 002a b1..                 lda     (_Zp+6),y
    \ 002c 85..                 sta     zp:_Zp+2
    \ 002e 98                   tya
    \ 002f 85..                 sta     zp:_Zp+3
    \ 0031 18                   clc
    \ 0032 a5..                 lda     zp:_Zp+2
    \ 0034 65..                 adc     zp:_Zp+17
    \ 0036 85..                 sta     zp:_Zp+2
    \ 0038 9002                 bcc     `?L835`
    \ 003a e6..                 inc     zp:_Zp+3
    \ 003c          `?L835`:
    \ 003c a5..                 lda     zp:_Zp
    \ 003e c5..                 cmp     zp:_Zp+2
    \ 0040 a5..                 lda     zp:_Zp+1
    \ 0042 e5..                 sbc     zp:_Zp+3
    \ 0044 5002                 bvc     `?L837`
    \ 0046 4980                 eor     #-128
    \ 0048 1004     `?L837`:    bpl     `?L204`
    \ 004a a5..                 lda     zp:_Zp+4
    \ 004c 91..                 sta     (_Zp+14),y
    \ 004e          `?L204`:
    \ 004e a5..                 lda     zp:_Zp+17
    \ 0050 60                   rts
    \ 0051          `?L181`:
    \ 0051 ab....               ldz     _Zp+12
    \ 0054 c228                 cpz     #40
    \ 0056 b006                 bcs     `?L185`
    \ 0058 a5..                 lda     zp:_Zp+12
    \ 005a 85..                 sta     zp:_Zp+8
    \ 005c 800f                 bra     `?L186`
    \ 005e          `?L185`:
    \ 005e a5..                 lda     zp:_Zp+12
    \ 0060 38                   sec
    \ 0061 e928                 sbc     #40
    \ 0063 85..                 sta     zp:_Zp+8
    \ 0065 a5..                 lda     zp:_Zp+2
    \ 0067 85..                 sta     zp:_Zp
    \ 0069 a5..                 lda     zp:_Zp+3
    \ 006b 85..                 sta     zp:_Zp+1
    \ 006d          `?L186`:
    \ 006d a6..                 ldx     zp:_Zp+8
    \ 006f 86..                 stx     zp:_Zp+10
    \ 0071 98                   tya
    \ 0072 85..                 sta     zp:_Zp+11
    \ 0074 cb....               asw     _Zp+10
    \ 0077 a5..                 lda     zp:_Zp+10
    \ 0079 85..                 sta     zp:_Zp+8
    \ 007b cb....               asw     _Zp+10
    \ 007e a5..                 lda     zp:_Zp+10
    \ 0080 18                   clc
    \ 0081 65..                 adc     zp:_Zp+8
    \ 0083 85..                 sta     zp:_Zp+8
    \ 0085 a5..                 lda     zp:_Zp
    \ 0087 18                   clc
    \ 0088 6910                 adc     #16
    \ 008a 85..                 sta     zp:_Zp+10
    \ 008c a5..                 lda     zp:_Zp+1
    \ 008e 6900                 adc     #0
    \ 0090 85..                 sta     zp:_Zp+11
    \ 0092 18                   clc
    \ 0093 a5..                 lda     zp:_Zp+10
    \ 0095 65..                 adc     zp:_Zp+8
    \ 0097 85..                 sta     zp:_Zp+10
    \ 0099 9002                 bcc     `?L839`
    \ 009b e6..                 inc     zp:_Zp+11
    \ 009d          `?L839`:
    \ 009d b1..                 lda     (_Zp+10),y
    \ 009f c928                 cmp     #40
    \ 00a1 9012                 bcc     `?L188`
    \ 00a3 b1..                 lda     (_Zp+6),y
    \ 00a5 d00a                 bne     `?L192`
    \ 00a7 a5..                 lda     zp:_Zp+12
    \ 00a9 85..                 sta     zp:_Zp+8
    \ 00ab e6..                 inc     zp:_Zp+8
    \ 00ad a5..                 lda     zp:_Zp+8
    \ 00af 91..                 sta     (_Zp+6),y
    \ 00b1          `?L192`:
    \ 00b1 e6..                 inc     zp:_Zp+17
    \ 00b3 8063                 bra     `?L183`
    \ 00b5          `?L188`:
    \ 00b5 a5..                 lda     zp:_Zp+17
    \ 00b7 f05c                 beq     `?L195`
    \ 00b9 a5..                 lda     zp:_Zp+12
    \ 00bb 91..                 sta     (_Zp+14),y
    \ 00bd 85..                 sta     zp:_Zp+8
    \ 00bf 20....               jsr     `?L1393`
    \ 00c2 b002                 bcs     `?L841`
    \ 00c4 c6..                 dec     zp:_Zp+9
    \ 00c6          `?L841`:
    \ 00c6 a6..                 ldx     zp:_Zp+5
    \ 00c8 86..                 stx     zp:_Zp+10
    \ 00ca 98                   tya
    \ 00cb 85..                 sta     zp:_Zp+11
    \ 00cd c3..                 dew     zp:_Zp+10
    \ 00cf 20....               jsr     `?L1446`
    \ 00d2 5002                 bvc     `?L843`
    \ 00d4 4980                 eor     #-128
    \ 00d6 3038     `?L843`:    bmi     `?L197`
    \ 00d8 b1..                 lda     (_Zp+14),y
    \ 00da 85..                 sta     zp:_Zp+8
    \ 00dc 20....               jsr     `?L1393`
    \ 00df b002                 bcs     `?L845`
    \ 00e1 c6..                 dec     zp:_Zp+9
    \ 00e3          `?L845`:
    \ 00e3 a6..                 ldx     zp:_Zp+13
    \ 00e5 86..                 stx     zp:_Zp+10
    \ 00e7 98                   tya
    \ 00e8 85..                 sta     zp:_Zp+11
    \ 00ea 38                   sec
    \ 00eb a5..                 lda     zp:_Zp+10
    \ 00ed e5..                 sbc     zp:_Zp+16
    \ 00ef 85..                 sta     zp:_Zp+10
    \ 00f1 b002                 bcs     `?L847`
    \ 00f3 c6..                 dec     zp:_Zp+11
    \ 00f5          `?L847`:
    \ 00f5 20....               jsr     `?L1446`
    \ 00f8 5002                 bvc     `?L849`
    \ 00fa 4980                 eor     #-128
    \ 00fc 300a     `?L849`:    bmi     `?L200`
    \ 00fe b1..                 lda     (_Zp+14),y
    \ 0100 85..                 sta     zp:_Zp+13
    \ 0102 b1..                 lda     (_Zp+6),y
    \ 0104 85..                 sta     zp:_Zp+16
    \ 0106 800d                 bra     `?L195`
    \ 0108          `?L200`:
    \ 0108 a5..                 lda     zp:_Zp+13
    \ 010a 91..                 sta     (_Zp+14),y
    \ 010c a5..                 lda     zp:_Zp+16
    \ 010e 8003                 bra     `?L1263`
    \ 0110 98       `?L197`:    tya
    \ 0111 91..                 sta     (_Zp+14),y
    \ 0113          `?L1263`:
    \ 0113 91..                 sta     (_Zp+6),y
    \ 0115 98       `?L195`:    tya
    \ 0116 85..                 sta     zp:_Zp+17
    \ 0118          `?L183`:
    \ 0118 e6..                 inc     zp:_Zp+12
    \ 011a 4c....               jmp     `?L182`
    \ 0000                      .section code,text
    \ 0000                      .public FreeTracks
    \ 0000 a200     FreeTracks: ldx     #0
    \ 0002 a006                 ldy     #6
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 a6..                 ldx     zp:_Zp+1
    \ 0009 86..                 stx     zp:_Zp+30
    \ 000b a6..                 ldx     zp:_Zp+2
    \ 000d 86..                 stx     zp:_Zp+29
    \ 000f a6..                 ldx     zp:_Zp+3
    \ 0011 86..                 stx     zp:_Zp+28
    \ 0013 a6..                 ldx     zp:_Zp+4
    \ 0015 86..                 stx     zp:_Zp+26
    \ 0017 a6..                 ldx     zp:_Zp+5
    \ 0019 86..                 stx     zp:_Zp+27
    \ 001b a6..                 ldx     zp:_Zp+6
    \ 001d 86..                 stx     zp:_Zp+24
    \ 001f a6..                 ldx     zp:_Zp+7
    \ 0021 86..                 stx     zp:_Zp+25
    \ 0023 20....               jsr     GetBAM
    \ 0026 a9fe                 lda     #-2
    \ 0028 20....               jsr     _DecVsp
    \ 002b a001                 ldy     #1
    \ 002d a5..                 lda     zp:_Zp+25
    \ 002f 91..                 sta     (_Vsp),y
    \ 0031 88                   dey
    \ 0032 a5..                 lda     zp:_Zp+24
    \ 0034 91..                 sta     (_Vsp),y
    \ 0036 a5..                 lda     zp:_Zp+26
    \ 0038 85..                 sta     zp:_Zp+6
    \ 003a a5..                 lda     zp:_Zp+27
    \ 003c 85..                 sta     zp:_Zp+7
    \ 003e a5..                 lda     zp:_Zp+28
    \ 0040 85..                 sta     zp:_Zp+5
    \ 0042 a5..                 lda     zp:_Zp+29
    \ 0044 20....               jsr     `?L1313`
    \ 0047 a5..                 lda     zp:_Zp+30
    \ 0049 20....               jsr     BAMFreeTracksinaRow
    \ 004c a001                 ldy     #1
    \ 004e 20....               jsr     _IncVsp
    \ 0051 a006                 ldy     #6
    \ 0053 4c....               jmp     _RestoreRegisters
    \ 0000                      .section code,text
    \ 0000                      .public FormatPartition
    \ 0000          FormatPartition:
    \ 0000 a200                 ldx     #0
    \ 0002 a00b                 ldy     #11
    \ 0004 20....               jsr     `?L1427`
    \ 0007 a5..                 lda     zp:_Zp+2
    \ 0009 85..                 sta     zp:_Zp+30
    \ 000b a5..                 lda     zp:_Zp+6
    \ 000d 85..                 sta     zp:_Zp+28
    \ 000f a5..                 lda     zp:_Zp+7
    \ 0011 85..                 sta     zp:_Zp+29
    \ 0013 20....               jsr     `?L1423`
    \ 0016 ad....               lda     BAMsector+2
    \ 0019 85..                 sta     zp:_Zp+26
    \ 001b ad....               lda     BAMsector+3
    \ 001e 85..                 sta     zp:_Zp+27
    \ 0020 ad....               lda     BAMsector
    \ 0023 85..                 sta     zp:_Zp+34
    \ 0025 ad....               lda     BAMsector+1
    \ 0028 85..                 sta     zp:_Zp+35
    \ 002a 8a                   txa
    \ 002b 85..                 sta     zp:_Zp+4
    \ 002d 20....               jsr     `?L1447`
    \ 0030 20....               jsr     `?L1399`
    \ 0033 8a                   txa
    \ 0034 20....               jsr     `?L1450`
    \ 0037 a9ff                 lda     #-1
    \ 0039 a001                 ldy     #1
    \ 003b 91..                 sta     (_Zp+26),y
    \ 003d a900                 lda     #0
    \ 003f 88                   dey
    \ 0040 91..                 sta     (_Zp+24),y
    \ 0042 a9ff                 lda     #-1
    \ 0044 c8                   iny
    \ 0045 91..                 sta     (_Zp+24),y
    \ 0047 a944                 lda     #68
    \ 0049 c8                   iny
    \ 004a 91..                 sta     (_Zp+24),y
    \ 004c a9bb                 lda     #-69
    \ 004e c8                   iny
    \ 004f 91..                 sta     (_Zp+24),y
    \ 0051 a949                 lda     #73
    \ 0053 c8                   iny
    \ 0054 91..                 sta     (_Zp+24),y
    \ 0056 a944                 lda     #68
    \ 0058 c8                   iny
    \ 0059 91..                 sta     (_Zp+24),y
    \ 005b a940                 lda     #64
    \ 005d c8                   iny
    \ 005e 91..                 sta     (_Zp+24),y
    \ 0060 a909                 lda     #9
    \ 0062 85..                 sta     zp:_Zp+4
    \ 0064 a900                 lda     #0
    \ 0066 85..                 sta     zp:_Zp+5
    \ 0068 20....               jsr     `?L1323`
    \ 006b a900                 lda     #0
    \ 006d 85..                 sta     zp:_Zp+2
    \ 006f 85..                 sta     zp:_Zp+3
    \ 0071 a907                 lda     #7
    \ 0073 a200                 ldx     #0
    \ 0075 a000                 ldy     #0
    \ 0077 a300                 ldz     #0
    \ 0079 20....               jsr     `?L1342`
    \ 007c 424285..             stq     zp:_Zp
    \ 0080 a900                 lda     #0
    \ 0082 20....               jsr     lfill
    \ 0085 20....               jsr     `?L1416`
    \ 0088          `?L215`:
    \ 0088 ab....               ldz     _Zp+4
    \ 008b c228                 cpz     #40
    \ 008d 931901               lbcc    `?L214`
    \ 0090 a9..                 lda     #.byte0 `_StringLiteral_directory/BAM`
    \ 0092 85..                 sta     zp:_Zp+2
    \ 0094 a9..                 lda     #.byte1 `_StringLiteral_directory/BAM`
    \ 0096 20....               jsr     `?L1382`
    \ 0099 a91e                 lda     #30
    \ 009b 20....               jsr     progress
    \ 009e a902                 lda     #2
    \ 00a0 85..                 sta     zp:_Zp+4
    \ 00a2 a5..                 lda     zp:_Zp+30
    \ 00a4 85..                 sta     zp:_Zp+3
    \ 00a6 a5..                 lda     zp:_Zp+31
    \ 00a8 85..                 sta     zp:_Zp+2
    \ 00aa 20....               jsr     `?L1323`
    \ 00ad 20....               jsr     `?L1445`
    \ 00b0 20....               jsr     `?L1303`
    \ 00b3 20....               jsr     `?L1400`
    \ 00b6 20....               jsr     `?L1323`
    \ 00b9 98                   tya
    \ 00ba 85..                 sta     zp:_Zp+2
    \ 00bc 85..                 sta     zp:_Zp+3
    \ 00be 20....               jsr     lcopy
    \ 00c1 a001                 ldy     #1
    \ 00c3 20....               jsr     _IncVsp
    \ 00c6 a5..                 lda     zp:_Zp+30
    \ 00c8 88                   dey
    \ 00c9 91..                 sta     (_Zp+26),y
    \ 00cb a902                 lda     #2
    \ 00cd c8                   iny
    \ 00ce 91..                 sta     (_Zp+26),y
    \ 00d0 a328                 ldz     #40
    \ 00d2 d4..                 cpz     zp:_Zp+30
    \ 00d4 b025                 bcs     `?L222`
    \ 00d6 20....               jsr     `?L1407`
    \ 00d9 20....               jsr     `?L1321`
    \ 00dc ab....               ldz     _Zp
    \ 00df a928                 lda     #40
    \ 00e1 92..                 sta     (_Zp+2),z
    \ 00e3 20....               jsr     `?L1407`
    \ 00e6 20....               jsr     `?L1321`
    \ 00e9 18                   clc
    \ 00ea a5..                 lda     zp:_Zp+2
    \ 00ec 65..                 adc     zp:_Zp
    \ 00ee 85..                 sta     zp:_Zp+2
    \ 00f0 9002                 bcc     `?L864`
    \ 00f2 e6..                 inc     zp:_Zp+3
    \ 00f4          `?L864`:
    \ 00f4 e3..                 inw     zp:_Zp+2
    \ 00f6 a9ff                 lda     #-1
    \ 00f8 88                   dey
    \ 00f9 91..                 sta     (_Zp+2),y
    \ 00fb a328     `?L222`:    ldz     #40
    \ 00fd d4..                 cpz     zp:_Zp+30
    \ 00ff 902a                 bcc     `?L225`
    \ 0101 20....               jsr     `?L1451`
    \ 0104 c3..                 dew     zp:_Zp+2
    \ 0106 20....               jsr     `?L1321`
    \ 0109 ab....               ldz     _Zp
    \ 010c a924                 lda     #36
    \ 010e 92..                 sta     (_Zp+2),z
    \ 0110 20....               jsr     `?L1451`
    \ 0113 c3..                 dew     zp:_Zp+2
    \ 0115 20....               jsr     `?L1321`
    \ 0118 18                   clc
    \ 0119 a5..                 lda     zp:_Zp+2
    \ 011b 65..                 adc     zp:_Zp
    \ 011d 85..                 sta     zp:_Zp+2
    \ 011f 9002                 bcc     `?L866`
    \ 0121 e6..                 inc     zp:_Zp+3
    \ 0123          `?L866`:
    \ 0123 e3..                 inw     zp:_Zp+2
    \ 0125 a9f0                 lda     #-16
    \ 0127 a000                 ldy     #0
    \ 0129 91..                 sta     (_Zp+2),y
    \ 012b          `?L225`:
    \ 012b 20....               jsr     `?L1416`
    \ 012e 20....               jsr     `?L1447`
    \ 0131 20....               jsr     `?L1323`
    \ 0134 a900                 lda     #0
    \ 0136 20....               jsr     `?L1450`
    \ 0139 a5..                 lda     zp:_Zp+30
    \ 013b a000                 ldy     #0
    \ 013d 91..                 sta     (_Zp+34),y
    \ 013f a903                 lda     #3
    \ 0141 c8                   iny
    \ 0142 91..                 sta     (_Zp+34),y
    \ 0144 a944                 lda     #68
    \ 0146 c8                   iny
    \ 0147 91..                 sta     (_Zp+34),y
    \ 0149 a5..                 lda     zp:_Zp+34
    \ 014b 85..                 sta     zp:_Zp+2
    \ 014d a5..                 lda     zp:_Zp+35
    \ 014f 20....               jsr     `?L1425`
    \ 0152 20....               jsr     `?L1443`
    \ 0155 a910                 lda     #16
    \ 0157 20....               jsr     strcopy
    \ 015a a9a0                 lda     #-96
    \ 015c a014                 ldy     #20
    \ 015e 91..                 sta     (_Zp+34),y
    \ 0160 c8                   iny
    \ 0161 91..                 sta     (_Zp+34),y
    \ 0163 a949                 lda     #73
    \ 0165 c8                   iny
    \ 0166 91..                 sta     (_Zp+34),y
    \ 0168 a944                 lda     #68
    \ 016a c8                   iny
    \ 016b 91..                 sta     (_Zp+34),y
    \ 016d a9a0                 lda     #-96
    \ 016f c8                   iny
    \ 0170 91..                 sta     (_Zp+34),y
    \ 0172 a933                 lda     #51
    \ 0174 c8                   iny
    \ 0175 91..                 sta     (_Zp+34),y
    \ 0177 a944                 lda     #68
    \ 0179 c8                   iny
    \ 017a 91..                 sta     (_Zp+34),y
    \ 017c a9a0                 lda     #-96
    \ 017e c8                   iny
    \ 017f 91..                 sta     (_Zp+34),y
    \ 0181 c8                   iny
    \ 0182 91..                 sta     (_Zp+34),y
    \ 0184 a9..                 lda     #.byte0 `_StringLiteral_BAM/header`
    \ 0186 85..                 sta     zp:_Zp+2
    \ 0188 a9..                 lda     #.byte1 `_StringLiteral_BAM/header`
    \ 018a 20....               jsr     `?L1382`
    \ 018d a93c                 lda     #60
    \ 018f 20....               jsr     progress
    \ 0192 20....               jsr     `?L1416`
    \ 0195 a5..                 lda     zp:_Zp+30
    \ 0197 85..                 sta     zp:_Zp+3
    \ 0199 a5..                 lda     zp:_Zp+31
    \ 019b 85..                 sta     zp:_Zp+2
    \ 019d 20....               jsr     `?L1323`
    \ 01a0 20....               jsr     `?L1445`
    \ 01a3 a00b                 ldy     #11
    \ 01a5 4c....               jmp     _RestoreRegisters
    \ 01a8          `?L214`:
    \ 01a8 a5..                 lda     zp:_Zp+4
    \ 01aa 18                   clc
    \ 01ab 6929                 adc     #41
    \ 01ad 85..                 sta     zp:_Zp
    \ 01af a900                 lda     #0
    \ 01b1 6900                 adc     #0
    \ 01b3 85..                 sta     zp:_Zp+1
    \ 01b5 a5..                 lda     zp:_Zp+30
    \ 01b7 38                   sec
    \ 01b8 e5..                 sbc     zp:_Zp
    \ 01ba 05..                 ora     zp:_Zp+1
    \ 01bc d022                 bne     `?L218`
    \ 01be 20....               jsr     `?L1300`
    \ 01c1 85..                 sta     zp:_Zp+3
    \ 01c3 ab....               ldz     _Zp
    \ 01c6 a924                 lda     #36
    \ 01c8 92..                 sta     (_Zp+2),z
    \ 01ca 20....               jsr     `?L1300`
    \ 01cd 85..                 sta     zp:_Zp+3
    \ 01cf 18                   clc
    \ 01d0 a5..                 lda     zp:_Zp+2
    \ 01d2 65..                 adc     zp:_Zp
    \ 01d4 85..                 sta     zp:_Zp+2
    \ 01d6 9002                 bcc     `?L872`
    \ 01d8 e6..                 inc     zp:_Zp+3
    \ 01da          `?L872`:
    \ 01da e3..                 inw     zp:_Zp+2
    \ 01dc a9f0                 lda     #-16
    \ 01de 8020                 bra     `?L1264`
    \ 01e0          `?L218`:
    \ 01e0 20....               jsr     `?L1300`
    \ 01e3 85..                 sta     zp:_Zp+3
    \ 01e5 ab....               ldz     _Zp
    \ 01e8 a928                 lda     #40
    \ 01ea 92..                 sta     (_Zp+2),z
    \ 01ec 20....               jsr     `?L1300`
    \ 01ef 85..                 sta     zp:_Zp+3
    \ 01f1 18                   clc
    \ 01f2 a5..                 lda     zp:_Zp+2
    \ 01f4 65..                 adc     zp:_Zp
    \ 01f6 85..                 sta     zp:_Zp+2
    \ 01f8 9002                 bcc     `?L874`
    \ 01fa e6..                 inc     zp:_Zp+3
    \ 01fc          `?L874`:
    \ 01fc e3..                 inw     zp:_Zp+2
    \ 01fe a9ff                 lda     #-1
    \ 0200 a000     `?L1264`:   ldy     #0
    \ 0202 91..                 sta     (_Zp+2),y
    \ 0204 a6..                 ldx     zp:_Zp+4
    \ 0206 86..                 stx     zp:_Zp+2
    \ 0208 98                   tya
    \ 0209 20....               jsr     `?L1301`
    \ 020c 85..                 sta     zp:_Zp+3
    \ 020e 18                   clc
    \ 020f a5..                 lda     zp:_Zp+2
    \ 0211 65..                 adc     zp:_Zp
    \ 0213 85..                 sta     zp:_Zp+2
    \ 0215 9002                 bcc     `?L876`
    \ 0217 e6..                 inc     zp:_Zp+3
    \ 0219          `?L876`:
    \ 0219 20....               jsr     `?L1408`
    \ 021c 20....               jsr     `?L1300`
    \ 021f 85..                 sta     zp:_Zp+3
    \ 0221 18                   clc
    \ 0222 a5..                 lda     zp:_Zp+2
    \ 0224 65..                 adc     zp:_Zp
    \ 0226 85..                 sta     zp:_Zp+2
    \ 0228 9002                 bcc     `?L878`
    \ 022a e6..                 inc     zp:_Zp+3
    \ 022c          `?L878`:
    \ 022c e3..                 inw     zp:_Zp+2
    \ 022e 20....               jsr     `?L1408`
    \ 0231 20....               jsr     `?L1300`
    \ 0234 85..                 sta     zp:_Zp+3
    \ 0236 18                   clc
    \ 0237 a5..                 lda     zp:_Zp+2
    \ 0239 65..                 adc     zp:_Zp
    \ 023b 85..                 sta     zp:_Zp+2
    \ 023d 9002                 bcc     `?L880`
    \ 023f e6..                 inc     zp:_Zp+3
    \ 0241          `?L880`:
    \ 0241 e3..                 inw     zp:_Zp+2
    \ 0243 e3..                 inw     zp:_Zp+2
    \ 0245 20....               jsr     `?L1408`
    \ 0248 20....               jsr     `?L1300`
    \ 024b 85..                 sta     zp:_Zp+3
    \ 024d 18                   clc
    \ 024e a5..                 lda     zp:_Zp+2
    \ 0250 65..                 adc     zp:_Zp
    \ 0252 85..                 sta     zp:_Zp+2
    \ 0254 9002                 bcc     `?L882`
    \ 0256 e6..                 inc     zp:_Zp+3
    \ 0258 a9ff     `?L882`:    lda     #-1
    \ 025a a005                 ldy     #5
    \ 025c 91..                 sta     (_Zp+2),y
    \ 025e e6..                 inc     zp:_Zp+4
    \ 0260 4c....               jmp     `?L215`
    \ 0000                      .section code,text
    \ 0000                      .public BAMAllocateTracks
    \ 0000          BAMAllocateTracks:
    \ 0000 20....               jsr     `?L1372`
    \ 0003 a6..                 ldx     zp:_Zp+1
    \ 0005 86..                 stx     zp:_Zp+24
    \ 0007 a6..                 ldx     zp:_Zp+2
    \ 0009 86..                 stx     zp:_Zp+26
    \ 000b 20....               jsr     GetBAM
    \ 000e          `?L231`:
    \ 000e ab....               ldz     _Zp+26
    \ 0011 d4..                 cpz     zp:_Zp+24
    \ 0013 b005                 bcs     `?L230`
    \ 0015 a002                 ldy     #2
    \ 0017 4c....               jmp     _RestoreRegisters
    \ 001a a900     `?L230`:    lda     #0
    \ 001c 85..                 sta     zp:_Zp+25
    \ 001e          `?L235`:
    \ 001e ab....               ldz     _Zp+25
    \ 0021 c228                 cpz     #40
    \ 0023 9004                 bcc     `?L234`
    \ 0025 e6..                 inc     zp:_Zp+24
    \ 0027 80e5                 bra     `?L231`
    \ 0029          `?L234`:
    \ 0029 20....               jsr     `?L1447`
    \ 002c a5..                 lda     zp:_Zp+25
    \ 002e 20....               jsr     `?L1313`
    \ 0031 a5..                 lda     zp:_Zp+24
    \ 0033 20....               jsr     BAMSectorUpdate
    \ 0036 e6..                 inc     zp:_Zp+25
    \ 0038 80e4                 bra     `?L235`
    \ 0000                      .section code,text
    \ 0000                      .public getDiskname
    \ 0000          getDiskname:
    \ 0000 a200                 ldx     #0
    \ 0002 a001                 ldy     #1
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+5
    \ 0009 20....               jsr     `?L1380`
    \ 000c 8a                   txa
    \ 000d 85..                 sta     zp:_Zp+4
    \ 000f a5..                 lda     zp:_Zp+1
    \ 0011 85..                 sta     zp:_Zp+3
    \ 0013 a5..                 lda     zp:_Zp
    \ 0015 85..                 sta     zp:_Zp+2
    \ 0017 ad....               lda     BAMsector
    \ 001a 85..                 sta     zp:_Zp
    \ 001c ad....               lda     BAMsector+1
    \ 001f 85..                 sta     zp:_Zp+1
    \ 0021 a5..                 lda     zp:_Zp+5
    \ 0023 20....               jsr     GetOneSector
    \ 0026 c902                 cmp     #2
    \ 0028 b03d                 bcs     `?L241`
    \ 002a ad....               lda     BAMsector
    \ 002d 85..                 sta     zp:_Zp
    \ 002f ad....               lda     BAMsector+1
    \ 0032 85..                 sta     zp:_Zp+1
    \ 0034 a900                 lda     #0
    \ 0036 85..                 sta     zp:_Zp+2
    \ 0038          `?L244`:
    \ 0038 20....               jsr     `?L1375`
    \ 003b 9002                 bcc     `?L889`
    \ 003d e6..                 inc     zp:_Zp+5
    \ 003f          `?L889`:
    \ 003f 20....               jsr     `?L1406`
    \ 0042 c9a0                 cmp     #-96
    \ 0044 f019                 beq     `?L245`
    \ 0046 ab....               ldz     _Zp+2
    \ 0049 c210                 cpz     #16
    \ 004b b012                 bcs     `?L245`
    \ 004d 20....               jsr     `?L1375`
    \ 0050 9002                 bcc     `?L891`
    \ 0052 e6..                 inc     zp:_Zp+5
    \ 0054          `?L891`:
    \ 0054 b1..                 lda     (_Zp+4),y
    \ 0056 ab....               ldz     _Zp+2
    \ 0059 92..                 sta     (_Zp+24),z
    \ 005b e6..                 inc     zp:_Zp+2
    \ 005d 80d9                 bra     `?L244`
    \ 005f 98       `?L245`:    tya
    \ 0060 ab....               ldz     _Zp+2
    \ 0063 92..                 sta     (_Zp+24),z
    \ 0065 8015                 bra     `?L240`
    \ 0067          `?L241`:
    \ 0067 a5..                 lda     zp:_Zp+24
    \ 0069 85..                 sta     zp:_Zp+2
    \ 006b a5..                 lda     zp:_Zp+25
    \ 006d 85..                 sta     zp:_Zp+3
    \ 006f a9..                 lda     #.byte0 `_StringLiteral_read error`
    \ 0071 85..                 sta     zp:_Zp
    \ 0073 a9..                 lda     #.byte1 `_StringLiteral_read error`
    \ 0075 85..                 sta     zp:_Zp+1
    \ 0077 a910                 lda     #16
    \ 0079 20....               jsr     strcopy
    \ 007c a001     `?L240`:    ldy     #1
    \ 007e 4c....               jmp     _RestoreRegisters
    \ 0000                      .section code,text
    \ 0000                      .public readblockchain
    \ 0000          readblockchain:
    \ 0000 a200                 ldx     #0
    \ 0002 a00b                 ldy     #11
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+31
    \ 0009 4242a5..             ldq     zp:_Zp
    \ 000d 424285..             stq     zp:_Zp+24
    \ 0011 20....               jsr     `?L1421`
    \ 0014 85..                 sta     zp:_Zp+34
    \ 0016 a5..                 lda     zp:_Zp+1
    \ 0018 85..                 sta     zp:_Zp+35
    \ 001a a5..                 lda     zp:_Zp+6
    \ 001c 85..                 sta     zp:_Zp+30
    \ 001e a5..                 lda     zp:_Zp+7
    \ 0020 85..                 sta     zp:_Zp+3
    \ 0022 a00c                 ldy     #12
    \ 0024 b1..                 lda     (_Vsp),y
    \ 0026 85..                 sta     zp:_Zp+4
    \ 0028 a900                 lda     #0
    \ 002a 85..                 sta     zp:_Zp+32
    \ 002c 85..                 sta     zp:_Zp+33
    \ 002e          `?L251`:
    \ 002e a5..                 lda     zp:_Zp+3
    \ 0030 85..                 sta     zp:_Zp+29
    \ 0032 a5..                 lda     zp:_Zp+32
    \ 0034 c5..                 cmp     zp:_Zp+34
    \ 0036 a5..                 lda     zp:_Zp+33
    \ 0038 e5..                 sbc     zp:_Zp+35
    \ 003a b052                 bcs     `?L253`
    \ 003c a5..                 lda     zp:_Zp+30
    \ 003e 20....               jsr     `?L1344`
    \ 0041 a5..                 lda     zp:_Zp+31
    \ 0043 20....               jsr     `?L1385`
    \ 0046 b004                 bcs     `?L255`
    \ 0048 a9ff                 lda     #-1
    \ 004a 804c                 bra     `?L249`
    \ 004c          `?L255`:
    \ 004c ad....               lda     worksector
    \ 004f 85..                 sta     zp:_Zp
    \ 0051 ad....               lda     worksector+1
    \ 0054 85..                 sta     zp:_Zp+1
    \ 0056 a000                 ldy     #0
    \ 0058 b1..                 lda     (_Zp),y
    \ 005a 85..                 sta     zp:_Zp+29
    \ 005c c8                   iny
    \ 005d b1..                 lda     (_Zp),y
    \ 005f 85..                 sta     zp:_Zp+28
    \ 0061 20....               jsr     `?L1303`
    \ 0064 a5..                 lda     zp:_Zp+32
    \ 0066 85..                 sta     zp:_Zp+4
    \ 0068 a5..                 lda     zp:_Zp+33
    \ 006a 85..                 sta     zp:_Zp+5
    \ 006c 98                   tya
    \ 006d 85..                 sta     zp:_Zp+7
    \ 006f a5..                 lda     zp:_Zp+5
    \ 0071 85..                 sta     zp:_Zp+6
    \ 0073 a5..                 lda     zp:_Zp+4
    \ 0075 85..                 sta     zp:_Zp+5
    \ 0077 98                   tya
    \ 0078 85..                 sta     zp:_Zp+4
    \ 007a 4242a5..             ldq     zp:_Zp+4
    \ 007e 18                   clc
    \ 007f 424265..             adcq    zp:_Zp+24
    \ 0083 424285..             stq     zp:_Zp+4
    \ 0087 20....               jsr     `?L1314`
    \ 008a a5..                 lda     zp:_Zp+29
    \ 008c d00f                 bne     `?L252`
    \ 008e          `?L253`:
    \ 008e a5..                 lda     zp:_Zp+29
    \ 0090 f004                 beq     `?L263`
    \ 0092 a9fe                 lda     #-2
    \ 0094 8002                 bra     `?L249`
    \ 0096 a900     `?L263`:    lda     #0
    \ 0098 a00b     `?L249`:    ldy     #11
    \ 009a 4c....               jmp     _RestoreRegisters
    \ 009d          `?L252`:
    \ 009d e3..                 inw     zp:_Zp+32
    \ 009f a5..                 lda     zp:_Zp+29
    \ 00a1 85..                 sta     zp:_Zp+3
    \ 00a3 a5..                 lda     zp:_Zp+28
    \ 00a5 85..                 sta     zp:_Zp+4
    \ 00a7 8085                 bra     `?L251`
    \ 0000                      .section code,text
    \ 0000                      .public isallocatedBAMtracksector
    \ 0000          isallocatedBAMtracksector:
    \ 0000 85..                 sta     zp:_Zp+1
    \ 0002 a901                 lda     #1
    \ 0004 85..                 sta     zp:_Zp+6
    \ 0006 c6..                 dec     zp:_Zp+1
    \ 0008 ab....               ldz     _Zp+1
    \ 000b c228                 cpz     #40
    \ 000d b00a                 bcs     `?L270`
    \ 000f ad....               lda     BAMsector
    \ 0012 85..                 sta     zp:_Zp+8
    \ 0014 ad....               lda     BAMsector+1
    \ 0017 800f                 bra     `?L1265`
    \ 0019          `?L270`:
    \ 0019 a5..                 lda     zp:_Zp+1
    \ 001b 38                   sec
    \ 001c e928                 sbc     #40
    \ 001e 85..                 sta     zp:_Zp+1
    \ 0020 ad....               lda     BAMsector+2
    \ 0023 85..                 sta     zp:_Zp+8
    \ 0025 ad....               lda     BAMsector+3
    \ 0028          `?L1265`:
    \ 0028 85..                 sta     zp:_Zp+9
    \ 002a ab....               ldz     _Zp
    \ 002d c208                 cpz     #8
    \ 002f b020                 bcs     `?L273`
    \ 0031 20....               jsr     `?L1302`
    \ 0034 9002                 bcc     `?L899`
    \ 0036 e6..                 inc     zp:_Zp+5
    \ 0038          `?L899`:
    \ 0038 20....               jsr     `?L1405`
    \ 003b 48                   pha
    \ 003c 20....               jsr     `?L1374`
    \ 003f aa                   tax
    \ 0040 f006                 beq     `?L901`
    \ 0042          `?L902`:
    \ 0042 cb....               asw     _Zp+2
    \ 0045 ca                   dex
    \ 0046 d0fa                 bne     `?L902`
    \ 0048 68       `?L901`:    pla
    \ 0049 25..                 and     zp:_Zp+2
    \ 004b d3a500               lbne    `?L274`
    \ 004e 4c....               jmp     `?L303`
    \ 0051          `?L273`:
    \ 0051 ab....               ldz     _Zp
    \ 0054 c210                 cpz     #16
    \ 0056 b021                 bcs     `?L280`
    \ 0058 20....               jsr     `?L1302`
    \ 005b 9002                 bcc     `?L904`
    \ 005d e6..                 inc     zp:_Zp+5
    \ 005f          `?L904`:
    \ 005f 20....               jsr     `?L1404`
    \ 0062 48                   pha
    \ 0063 20....               jsr     `?L1374`
    \ 0066 38                   sec
    \ 0067 e908                 sbc     #8
    \ 0069 aa                   tax
    \ 006a f006                 beq     `?L906`
    \ 006c          `?L907`:
    \ 006c cb....               asw     _Zp+2
    \ 006f ca                   dex
    \ 0070 d0fa                 bne     `?L907`
    \ 0072 68       `?L906`:    pla
    \ 0073 25..                 and     zp:_Zp+2
    \ 0075 d07b                 bne     `?L274`
    \ 0077 8076                 bra     `?L303`
    \ 0079          `?L280`:
    \ 0079 ab....               ldz     _Zp
    \ 007c c218                 cpz     #24
    \ 007e b023                 bcs     `?L287`
    \ 0080 20....               jsr     `?L1302`
    \ 0083 9002                 bcc     `?L909`
    \ 0085 e6..                 inc     zp:_Zp+5
    \ 0087          `?L909`:
    \ 0087 e3..                 inw     zp:_Zp+4
    \ 0089 20....               jsr     `?L1404`
    \ 008c 48                   pha
    \ 008d 20....               jsr     `?L1374`
    \ 0090 38                   sec
    \ 0091 e910                 sbc     #16
    \ 0093 aa                   tax
    \ 0094 f006                 beq     `?L911`
    \ 0096          `?L912`:
    \ 0096 cb....               asw     _Zp+2
    \ 0099 ca                   dex
    \ 009a d0fa                 bne     `?L912`
    \ 009c 68       `?L911`:    pla
    \ 009d 25..                 and     zp:_Zp+2
    \ 009f d051                 bne     `?L274`
    \ 00a1 804c                 bra     `?L303`
    \ 00a3          `?L287`:
    \ 00a3 ab....               ldz     _Zp
    \ 00a6 c220                 cpz     #32
    \ 00a8 b025                 bcs     `?L294`
    \ 00aa 20....               jsr     `?L1302`
    \ 00ad 9002                 bcc     `?L914`
    \ 00af e6..                 inc     zp:_Zp+5
    \ 00b1          `?L914`:
    \ 00b1 e3..                 inw     zp:_Zp+4
    \ 00b3 e3..                 inw     zp:_Zp+4
    \ 00b5 20....               jsr     `?L1404`
    \ 00b8 48                   pha
    \ 00b9 20....               jsr     `?L1374`
    \ 00bc 38                   sec
    \ 00bd e918                 sbc     #24
    \ 00bf aa                   tax
    \ 00c0 f006                 beq     `?L916`
    \ 00c2          `?L917`:
    \ 00c2 cb....               asw     _Zp+2
    \ 00c5 ca                   dex
    \ 00c6 d0fa                 bne     `?L917`
    \ 00c8 68       `?L916`:    pla
    \ 00c9 25..                 and     zp:_Zp+2
    \ 00cb d025                 bne     `?L274`
    \ 00cd 8020                 bra     `?L303`
    \ 00cf          `?L294`:
    \ 00cf 20....               jsr     `?L1302`
    \ 00d2 9002                 bcc     `?L919`
    \ 00d4 e6..                 inc     zp:_Zp+5
    \ 00d6 a005     `?L919`:    ldy     #5
    \ 00d8 b1..                 lda     (_Zp+4),y
    \ 00da 48                   pha
    \ 00db 20....               jsr     `?L1374`
    \ 00de 38                   sec
    \ 00df e920                 sbc     #32
    \ 00e1 aa                   tax
    \ 00e2 f006                 beq     `?L921`
    \ 00e4          `?L922`:
    \ 00e4 cb....               asw     _Zp+2
    \ 00e7 ca                   dex
    \ 00e8 d0fa                 bne     `?L922`
    \ 00ea 68       `?L921`:    pla
    \ 00eb 25..                 and     zp:_Zp+2
    \ 00ed d003                 bne     `?L274`
    \ 00ef a901     `?L303`:    lda     #1
    \ 00f1 60                   rts
    \ 00f2 a900     `?L274`:    lda     #0
    \ 00f4 60                   rts
    \ 0000                      .section code,text
    \ 0000                      .public findnextBAMtracksector
    \ 0000          findnextBAMtracksector:
    \ 0000 a2b0                 ldx     #176
    \ 0002 a005                 ldy     #5
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+12
    \ 0009 20....               jsr     `?L1387`
    \ 000c 85..                 sta     zp:_Zp+27
    \ 000e 20....               jsr     `?L1380`
    \ 0011 a901                 lda     #1
    \ 0013 85..                 sta     zp:_Zp+13
    \ 0015 a900                 lda     #0
    \ 0017 85..                 sta     zp:_Zp+11
    \ 0019 20....               jsr     `?L1442`
    \ 001c a9..                 lda     #.byte0 `??_Initializer0`
    \ 001e 85..                 sta     zp:_Zp+2
    \ 0020 a9..                 lda     #.byte1 `??_Initializer0`
    \ 0022 85..                 sta     zp:_Zp+3
    \ 0024 a250                 ldx     #80
    \ 0026 20....               jsr     _MoveLong16X
    \ 0029 a5..                 lda     zp:_Zp+5
    \ 002b 85..                 sta     zp:_Zp+7
    \ 002d c6..                 dec     zp:_Zp+7
    \ 002f          `?L310`:
    \ 002f a5..                 lda     zp:_Zp+11
    \ 0031 85..                 sta     zp:_Zp
    \ 0033 ab....               ldz     _Zp+7
    \ 0036 d4..                 cpz     zp:_Zp+6
    \ 0038 b35601               lbcs    `?L312`
    \ 003b a228                 ldx     #40
    \ 003d e4..                 cpx     zp:_Zp+4
    \ 003f f01d                 beq     `?L313`
    \ 0041 a5..                 lda     zp:_Zp+12
    \ 0043 d015                 bne     `?L317`
    \ 0045 a5..                 lda     zp:_Zp+7
    \ 0047 a6..                 ldx     zp:_Zp+5
    \ 0049 86..                 stx     zp:_Zp
    \ 004b a200                 ldx     #0
    \ 004d 86..                 stx     zp:_Zp+1
    \ 004f c3..                 dew     zp:_Zp
    \ 0051 38                   sec
    \ 0052 e5..                 sbc     zp:_Zp
    \ 0054 05..                 ora     zp:_Zp+1
    \ 0056 d002                 bne     `?L317`
    \ 0058 e6..                 inc     zp:_Zp+7
    \ 005a          `?L317`:
    \ 005a a5..                 lda     zp:_Zp+7
    \ 005c 8021                 bra     `?L1268`
    \ 005e          `?L313`:
    \ 005e 20....               jsr     `?L1442`
    \ 0061 18                   clc
    \ 0062 a5..                 lda     zp:_Zp
    \ 0064 65..                 adc     zp:_Zp+7
    \ 0066 85..                 sta     zp:_Zp
    \ 0068 9002                 bcc     `?L926`
    \ 006a e6..                 inc     zp:_Zp+1
    \ 006c a000     `?L926`:    ldy     #0
    \ 006e b1..                 lda     (_Zp),y
    \ 0070 85..                 sta     zp:_Zp+8
    \ 0072 a5..                 lda     zp:_Zp+12
    \ 0074 f002                 beq     `?L320`
    \ 0076 e6..                 inc     zp:_Zp+8
    \ 0078 a34f     `?L320`:    ldz     #79
    \ 007a d4..                 cpz     zp:_Zp+8
    \ 007c b003                 bcs     `?L314`
    \ 007e 98                   tya
    \ 007f          `?L1268`:
    \ 007f 85..                 sta     zp:_Zp+8
    \ 0081          `?L314`:
    \ 0081 ab....               ldz     _Zp+8
    \ 0084 c228                 cpz     #40
    \ 0086 b00e                 bcs     `?L325`
    \ 0088 a5..                 lda     zp:_Zp+8
    \ 008a 85..                 sta     zp:_Zp+9
    \ 008c ad....               lda     BAMsector
    \ 008f 85..                 sta     zp:_Zp+14
    \ 0091 ad....               lda     BAMsector+1
    \ 0094 800f                 bra     `?L1267`
    \ 0096          `?L325`:
    \ 0096 a5..                 lda     zp:_Zp+8
    \ 0098 38                   sec
    \ 0099 e928                 sbc     #40
    \ 009b 85..                 sta     zp:_Zp+9
    \ 009d ad....               lda     BAMsector+2
    \ 00a0 85..                 sta     zp:_Zp+14
    \ 00a2 ad....               lda     BAMsector+3
    \ 00a5          `?L1267`:
    \ 00a5 85..                 sta     zp:_Zp+15
    \ 00a7 a900                 lda     #0
    \ 00a9 85..                 sta     zp:_Zp+10
    \ 00ab          `?L329`:
    \ 00ab a5..                 lda     zp:_Zp+11
    \ 00ad 85..                 sta     zp:_Zp
    \ 00af a327                 ldz     #39
    \ 00b1 d4..                 cpz     zp:_Zp+10
    \ 00b3 93d300               lbcc    `?L331`
    \ 00b6 ab....               ldz     _Zp+10
    \ 00b9 c208                 cpz     #8
    \ 00bb b01f                 bcs     `?L332`
    \ 00bd 20....               jsr     `?L1307`
    \ 00c0 9002                 bcc     `?L928`
    \ 00c2 e6..                 inc     zp:_Zp+3
    \ 00c4          `?L928`:
    \ 00c4 20....               jsr     `?L1409`
    \ 00c7 48                   pha
    \ 00c8 20....               jsr     `?L1373`
    \ 00cb aa                   tax
    \ 00cc f005                 beq     `?L930`
    \ 00ce          `?L931`:
    \ 00ce 20....               jsr     `?L1378`
    \ 00d1 d0fb                 bne     `?L931`
    \ 00d3 68       `?L930`:    pla
    \ 00d4 25..                 and     zp:_Zp
    \ 00d6 f3a800               lbeq    `?L333`
    \ 00d9 4c....               jmp     `?L362`
    \ 00dc          `?L332`:
    \ 00dc ab....               ldz     _Zp+10
    \ 00df c210                 cpz     #16
    \ 00e1 b022                 bcs     `?L339`
    \ 00e3 20....               jsr     `?L1307`
    \ 00e6 9002                 bcc     `?L933`
    \ 00e8 e6..                 inc     zp:_Zp+3
    \ 00ea          `?L933`:
    \ 00ea e3..                 inw     zp:_Zp+2
    \ 00ec 20....               jsr     `?L1409`
    \ 00ef 48                   pha
    \ 00f0 20....               jsr     `?L1373`
    \ 00f3 38                   sec
    \ 00f4 e908                 sbc     #8
    \ 00f6 aa                   tax
    \ 00f7 f005                 beq     `?L935`
    \ 00f9          `?L936`:
    \ 00f9 20....               jsr     `?L1378`
    \ 00fc d0fb                 bne     `?L936`
    \ 00fe 68       `?L935`:    pla
    \ 00ff 25..                 and     zp:_Zp
    \ 0101 f07d                 beq     `?L333`
    \ 0103 8077                 bra     `?L362`
    \ 0105          `?L339`:
    \ 0105 ab....               ldz     _Zp+10
    \ 0108 c218                 cpz     #24
    \ 010a b024                 bcs     `?L346`
    \ 010c 20....               jsr     `?L1307`
    \ 010f 9002                 bcc     `?L938`
    \ 0111 e6..                 inc     zp:_Zp+3
    \ 0113          `?L938`:
    \ 0113 e3..                 inw     zp:_Zp+2
    \ 0115 e3..                 inw     zp:_Zp+2
    \ 0117 20....               jsr     `?L1409`
    \ 011a 48                   pha
    \ 011b 20....               jsr     `?L1373`
    \ 011e 38                   sec
    \ 011f e910                 sbc     #16
    \ 0121 aa                   tax
    \ 0122 f005                 beq     `?L940`
    \ 0124          `?L941`:
    \ 0124 20....               jsr     `?L1378`
    \ 0127 d0fb                 bne     `?L941`
    \ 0129 68       `?L940`:    pla
    \ 012a 25..                 and     zp:_Zp
    \ 012c f052                 beq     `?L333`
    \ 012e 804c                 bra     `?L362`
    \ 0130          `?L346`:
    \ 0130 ab....               ldz     _Zp+10
    \ 0133 c220                 cpz     #32
    \ 0135 b026                 bcs     `?L353`
    \ 0137 20....               jsr     `?L1307`
    \ 013a 9002                 bcc     `?L943`
    \ 013c e6..                 inc     zp:_Zp+3
    \ 013e          `?L943`:
    \ 013e e3..                 inw     zp:_Zp+2
    \ 0140 e3..                 inw     zp:_Zp+2
    \ 0142 e3..                 inw     zp:_Zp+2
    \ 0144 20....               jsr     `?L1409`
    \ 0147 48                   pha
    \ 0148 20....               jsr     `?L1373`
    \ 014b 38                   sec
    \ 014c e918                 sbc     #24
    \ 014e aa                   tax
    \ 014f f005                 beq     `?L945`
    \ 0151          `?L946`:
    \ 0151 20....               jsr     `?L1378`
    \ 0154 d0fb                 bne     `?L946`
    \ 0156 68       `?L945`:    pla
    \ 0157 25..                 and     zp:_Zp
    \ 0159 f025                 beq     `?L333`
    \ 015b 801f                 bra     `?L362`
    \ 015d          `?L353`:
    \ 015d 20....               jsr     `?L1307`
    \ 0160 9002                 bcc     `?L948`
    \ 0162 e6..                 inc     zp:_Zp+3
    \ 0164 a005     `?L948`:    ldy     #5
    \ 0166 b1..                 lda     (_Zp+2),y
    \ 0168 48                   pha
    \ 0169 20....               jsr     `?L1373`
    \ 016c 38                   sec
    \ 016d e920                 sbc     #32
    \ 016f aa                   tax
    \ 0170 f005                 beq     `?L950`
    \ 0172          `?L951`:
    \ 0172 20....               jsr     `?L1378`
    \ 0175 d0fb                 bne     `?L951`
    \ 0177 68       `?L950`:    pla
    \ 0178 25..                 and     zp:_Zp
    \ 017a f004                 beq     `?L333`
    \ 017c a901     `?L362`:    lda     #1
    \ 017e 8006                 bra     `?L1266`
    \ 0180          `?L333`:
    \ 0180 a5..                 lda     zp:_Zp+11
    \ 0182 f04b                 beq     `?L330`
    \ 0184 a5..                 lda     zp:_Zp+11
    \ 0186          `?L1266`:
    \ 0186 85..                 sta     zp:_Zp
    \ 0188          `?L331`:
    \ 0188 a5..                 lda     zp:_Zp
    \ 018a f036                 beq     `?L311`
    \ 018c a5..                 lda     zp:_Zp+10
    \ 018e 85..                 sta     zp:_Zp+28
    \ 0190          `?L312`:
    \ 0190 e6..                 inc     zp:_Zp+8
    \ 0192 a5..                 lda     zp:_Zp+8
    \ 0194 85..                 sta     zp:_Zp+29
    \ 0196 a5..                 lda     zp:_Zp
    \ 0198 f017                 beq     `?L372`
    \ 019a 20....               jsr     `?L1447`
    \ 019d a5..                 lda     zp:_Zp+28
    \ 019f 20....               jsr     `?L1313`
    \ 01a2 a5..                 lda     zp:_Zp+29
    \ 01a4 20....               jsr     BAMSectorUpdate
    \ 01a7 a5..                 lda     zp:_Zp+29
    \ 01a9 a000                 ldy     #0
    \ 01ab 91..                 sta     (_Zp+26),y
    \ 01ad a5..                 lda     zp:_Zp+28
    \ 01af 8008                 bra     `?L1269`
    \ 01b1 a9ff     `?L372`:    lda     #-1
    \ 01b3 a000                 ldy     #0
    \ 01b5 91..                 sta     (_Zp+26),y
    \ 01b7 a900                 lda     #0
    \ 01b9          `?L1269`:
    \ 01b9 91..                 sta     (_Zp+24),y
    \ 01bb a250                 ldx     #80
    \ 01bd a005                 ldy     #5
    \ 01bf 4c....               jmp     _DeallocStackRestore
    \ 01c2          `?L311`:
    \ 01c2 e6..                 inc     zp:_Zp+7
    \ 01c4 a5..                 lda     zp:_Zp+10
    \ 01c6 85..                 sta     zp:_Zp+28
    \ 01c8 a5..                 lda     zp:_Zp
    \ 01ca 85..                 sta     zp:_Zp+11
    \ 01cc 4c....               jmp     `?L310`
    \ 01cf          `?L330`:
    \ 01cf e6..                 inc     zp:_Zp+10
    \ 01d1 4c....               jmp     `?L329`
    \ 0000                      .section cdata,rodata
    \ 0000          `??_Initializer0`:
    \ 0000 2629282a             .byte   38,41,40,42,37,43,36,44
    \ 0004 252b242c
    \ 0008 232d222e             .byte   35,45,34,46,33,47,32,48
    \ 000c 212f2030
    \ 0010 1f311e32             .byte   31,49,30,50,29,51,28,52
    \ 0014 1d331c34
    \ 0018 1b351a36             .byte   27,53,26,54,25,55,24,56
    \ 001c 19371838
    \ 0020 1739163a             .byte   23,57,22,58,21,59,20,60
    \ 0024 153b143c
    \ 0028 133d123e             .byte   19,61,18,62,17,63,16,64
    \ 002c 113f1040
    \ 0030 0f410e42             .byte   15,65,14,66,13,67,12,68
    \ 0034 0d430c44
    \ 0038 0b450a46             .byte   11,69,10,70,9,71,8,72
    \ 003c 09470848
    \ 0040 0749064a             .byte   7,73,6,74,5,75,4,76
    \ 0044 054b044c
    \ 0048 034d024e             .byte   3,77,2,78,1,79,0,39
    \ 004c 014f0027
    \ 0000                      .section code,text
    \ 0000                      .public writeblockchain
    \ 0000          writeblockchain:
    \ 0000 a2ef                 ldx     #239
    \ 0002 a001                 ldy     #1
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 a000                 ldy     #0
    \ 0009 91..                 sta     (_Vsp),y
    \ 000b c8                   iny
    \ 000c 20....               jsr     `?L1358`
    \ 000f a008                 ldy     #8
    \ 0011 20....               jsr     `?L1431`
    \ 0014 a5..                 lda     zp:_Zp+6
    \ 0016 a005                 ldy     #5
    \ 0018 91..                 sta     (_Vsp),y
    \ 001a a5..                 lda     zp:_Zp+7
    \ 001c a00a                 ldy     #10
    \ 001e 91..                 sta     (_Vsp),y
    \ 0020 a900                 lda     #0
    \ 0022 a010                 ldy     #16
    \ 0024 91..                 sta     (_Vsp),y
    \ 0026 a9ff                 lda     #-1
    \ 0028 a00b                 ldy     #11
    \ 002a 91..                 sta     (_Vsp),y
    \ 002c 20....               jsr     `?L1381`
    \ 002f c8                   iny
    \ 0030 ad....               lda     worksector+2
    \ 0033 91..                 sta     (_Vsp),y
    \ 0035 c8                   iny
    \ 0036 ad....               lda     worksector+3
    \ 0039 91..                 sta     (_Vsp),y
    \ 003b a019                 ldy     #25
    \ 003d b1..                 lda     (_Vsp),y
    \ 003f 85..                 sta     zp:_Zp+6
    \ 0041 88                   dey
    \ 0042 b1..                 lda     (_Vsp),y
    \ 0044 85..                 sta     zp:_Zp+5
    \ 0046 a00a                 ldy     #10
    \ 0048 b1..                 lda     (_Vsp),y
    \ 004a 85..                 sta     zp:_Zp+4
    \ 004c a2..                 ldx     #_Zp+2
    \ 004e a90f                 lda     #15
    \ 0050 20....               jsr     _LoadVspEA
    \ 0053 a2..                 ldx     #_Zp
    \ 0055 a90e                 lda     #14
    \ 0057 20....               jsr     _LoadVspEA
    \ 005a a017                 ldy     #23
    \ 005c b1..                 lda     (_Vsp),y
    \ 005e 20....               jsr     findnextBAMtracksector
    \ 0061 a013                 ldy     #19
    \ 0063 20....               jsr     `?L1316`
    \ 0066 a00e                 ldy     #14
    \ 0068 20....               jsr     `?L1410`
    \ 006b a015                 ldy     #21
    \ 006d 20....               jsr     `?L1316`
    \ 0070 a00f                 ldy     #15
    \ 0072 20....               jsr     `?L1410`
    \ 0075 98                   tya
    \ 0076 85..                 sta     zp:_Zp
    \ 0078 85..                 sta     zp:_Zp+1
    \ 007a a006     `?L1272`:   ldy     #6
    \ 007c a5..                 lda     zp:_Zp
    \ 007e 91..                 sta     (_Vsp),y
    \ 0080 c8                   iny
    \ 0081 a5..                 lda     zp:_Zp+1
    \ 0083 91..                 sta     (_Vsp),y
    \ 0085 88                   dey
    \ 0086 20....               jsr     `?L1316`
    \ 0089 18                   clc
    \ 008a c8                   iny
    \ 008b b1..                 lda     (_Vsp),y
    \ 008d a006                 ldy     #6
    \ 008f f1..                 sbc     (_Vsp),y
    \ 0091 a009                 ldy     #9
    \ 0093 b1..                 lda     (_Vsp),y
    \ 0095 a007                 ldy     #7
    \ 0097 f1..                 sbc     (_Vsp),y
    \ 0099 93f800               lbcc    `?L381`
    \ 009c 20....               jsr     `?L1303`
    \ 009f 20....               jsr     `?L1324`
    \ 00a2 a308                 ldz     #8
    \ 00a4 20....               jsr     `?L1390`
    \ 00a7 98                   tya
    \ 00a8 20....               jsr     `?L1359`
    \ 00ab 85..                 sta     zp:_Zp
    \ 00ad a303                 ldz     #3
    \ 00af 4242b2..             ldq     (_Vsp),z
    \ 00b3 20....               jsr     `?L1305`
    \ 00b6 88                   dey
    \ 00b7 b1..                 lda     (_Zp+24),y
    \ 00b9 f013                 beq     `?L383`
    \ 00bb 20....               jsr     `?L1351`
    \ 00be a010                 ldy     #16
    \ 00c0 b1..                 lda     (_Vsp),y
    \ 00c2 a000                 ldy     #0
    \ 00c4 91..                 sta     (_Zp+24),y
    \ 00c6 a00b                 ldy     #11
    \ 00c8 b1..                 lda     (_Vsp),y
    \ 00ca a001                 ldy     #1
    \ 00cc 91..                 sta     (_Zp+24),y
    \ 00ce a000     `?L383`:    ldy     #0
    \ 00d0 b1..                 lda     (_Zp+24),y
    \ 00d2 f3a000               lbeq    `?L385`
    \ 00d5 a00e                 ldy     #14
    \ 00d7 20....               jsr     `?L1439`
    \ 00da a000                 ldy     #0
    \ 00dc b1..                 lda     (_Zp+24),y
    \ 00de c5..                 cmp     zp:_Zp
    \ 00e0 d39200               lbne    `?L385`
    \ 00e3 a00f                 ldy     #15
    \ 00e5 20....               jsr     `?L1439`
    \ 00e8 46..                 lsr     zp:_Zp
    \ 00ea a001                 ldy     #1
    \ 00ec b1..                 lda     (_Zp+24),y
    \ 00ee 4a                   lsr     a
    \ 00ef c5..                 cmp     zp:_Zp
    \ 00f1 d38100               lbne    `?L385`
    \ 00f4 a006                 ldy     #6
    \ 00f6 20....               jsr     `?L1316`
    \ 00f9 e3..                 inw     zp:_Zp
    \ 00fb 88                   dey
    \ 00fc a5..                 lda     zp:_Zp
    \ 00fe 91..                 sta     (_Vsp),y
    \ 0100 c8                   iny
    \ 0101 a5..                 lda     zp:_Zp+1
    \ 0103 91..                 sta     (_Vsp),y
    \ 0105 20....               jsr     `?L1303`
    \ 0108 a00e                 ldy     #14
    \ 010a b1..                 lda     (_Vsp),y
    \ 010c 85..                 sta     zp:_Zp+4
    \ 010e c8                   iny
    \ 010f b1..                 lda     (_Vsp),y
    \ 0111 85..                 sta     zp:_Zp+5
    \ 0113 a900                 lda     #0
    \ 0115 85..                 sta     zp:_Zp+6
    \ 0117 85..                 sta     zp:_Zp+7
    \ 0119 a308                 ldz     #8
    \ 011b 20....               jsr     `?L1390`
    \ 011e 20....               jsr     `?L1452`
    \ 0121 a5..                 lda     zp:_Zp+1
    \ 0123 85..                 sta     zp:_Zp+2
    \ 0125 a5..                 lda     zp:_Zp
    \ 0127 85..                 sta     zp:_Zp+1
    \ 0129 a900                 lda     #0
    \ 012b 85..                 sta     zp:_Zp
    \ 012d a303                 ldz     #3
    \ 012f 4242b2..             ldq     (_Vsp),z
    \ 0133 20....               jsr     `?L1305`
    \ 0136 a00c                 ldy     #12
    \ 0138 20....               jsr     `?L1316`
    \ 013b a000                 ldy     #0
    \ 013d b1..                 lda     (_Zp),y
    \ 013f f019                 beq     `?L389`
    \ 0141 20....               jsr     `?L1351`
    \ 0144 a00c                 ldy     #12
    \ 0146 20....               jsr     `?L1316`
    \ 0149 a010                 ldy     #16
    \ 014b 20....               jsr     `?L1410`
    \ 014e a00c                 ldy     #12
    \ 0150 20....               jsr     `?L1316`
    \ 0153 e3..                 inw     zp:_Zp
    \ 0155 a00b                 ldy     #11
    \ 0157 20....               jsr     `?L1410`
    \ 015a          `?L389`:
    \ 015a 20....               jsr     `?L1383`
    \ 015d 20....               jsr     `?L1323`
    \ 0160 a000                 ldy     #0
    \ 0162 b1..                 lda     (_Vsp),y
    \ 0164 20....               jsr     PutWholeSector
    \ 0167 a00c                 ldy     #12
    \ 0169 20....               jsr     `?L1316`
    \ 016c a000                 ldy     #0
    \ 016e b1..                 lda     (_Zp),y
    \ 0170 91..                 sta     (_Zp+24),y
    \ 0172 800d                 bra     `?L1270`
    \ 0174          `?L385`:
    \ 0174 20....               jsr     `?L1383`
    \ 0177 20....               jsr     `?L1323`
    \ 017a a000                 ldy     #0
    \ 017c b1..                 lda     (_Vsp),y
    \ 017e 20....               jsr     PutOneSector
    \ 0181 a006     `?L1270`:   ldy     #6
    \ 0183 b1..                 lda     (_Vsp),y
    \ 0185 c8                   iny
    \ 0186 b1..                 lda     (_Vsp),y
    \ 0188 a000                 ldy     #0
    \ 018a b1..                 lda     (_Zp+24),y
    \ 018c d061                 bne     `?L392`
    \ 018e a006                 ldy     #6
    \ 0190 20....               jsr     `?L1316`
    \ 0193 a010     `?L381`:    ldy     #16
    \ 0195 b1..                 lda     (_Vsp),y
    \ 0197 f04f                 beq     `?L377`
    \ 0199 a5..                 lda     zp:_Zp
    \ 019b a008                 ldy     #8
    \ 019d d1..                 cmp     (_Vsp),y
    \ 019f a5..                 lda     zp:_Zp+1
    \ 01a1 c8                   iny
    \ 01a2 f1..                 sbc     (_Vsp),y
    \ 01a4 9042                 bcc     `?L377`
    \ 01a6 a9fc                 lda     #-4
    \ 01a8 20....               jsr     _DecVsp
    \ 01ab a30c                 ldz     #12
    \ 01ad 20....               jsr     `?L1390`
    \ 01b0 a900                 lda     #0
    \ 01b2 85..                 sta     zp:_Zp+2
    \ 01b4 85..                 sta     zp:_Zp+3
    \ 01b6 a003                 ldy     #3
    \ 01b8 a5..                 lda     zp:_Zp+3
    \ 01ba 91..                 sta     (_Vsp),y
    \ 01bc 88                   dey
    \ 01bd a5..                 lda     zp:_Zp+2
    \ 01bf 91..                 sta     (_Vsp),y
    \ 01c1 88                   dey
    \ 01c2 a5..                 lda     zp:_Zp+1
    \ 01c4 91..                 sta     (_Vsp),y
    \ 01c6 88                   dey
    \ 01c7 a5..                 lda     zp:_Zp
    \ 01c9 91..                 sta     (_Vsp),y
    \ 01cb a9..                 lda     #.byte0 _StringLiteral_max
    \ 01cd 85..                 sta     zp:_Zp+4
    \ 01cf a9..                 lda     #.byte1 _StringLiteral_max
    \ 01d1 85..                 sta     zp:_Zp+5
    \ 01d3 a9..                 lda     #.byte0 `_StringLiteral_number of sectors too big`
    \ 01d5 85..                 sta     zp:_Zp+2
    \ 01d7 a9..                 lda     #.byte1 `_StringLiteral_number of sectors too big`
    \ 01d9 85..                 sta     zp:_Zp+3
    \ 01db a9..                 lda     #.byte0 `_StringLiteral_Writing file,`
    \ 01dd 85..                 sta     zp:_Zp
    \ 01df a9..                 lda     #.byte1 `_StringLiteral_Writing file,`
    \ 01e1 85..                 sta     zp:_Zp+1
    \ 01e3 a903                 lda     #3
    \ 01e5 20....               jsr     `?L1391`
    \ 01e8 a211     `?L377`:    ldx     #17
    \ 01ea a001                 ldy     #1
    \ 01ec 4c....               jmp     _DeallocStackRestore
    \ 01ef a010     `?L392`:    ldy     #16
    \ 01f1 b1..                 lda     (_Vsp),y
    \ 01f3 a00e                 ldy     #14
    \ 01f5 91..                 sta     (_Vsp),y
    \ 01f7 a00b                 ldy     #11
    \ 01f9 b1..                 lda     (_Vsp),y
    \ 01fb a00f                 ldy     #15
    \ 01fd 91..                 sta     (_Vsp),y
    \ 01ff a006                 ldy     #6
    \ 0201 20....               jsr     `?L1316`
    \ 0204 e3..                 inw     zp:_Zp
    \ 0206 4c....               jmp     `?L1272`
    \ 0000                      .section code,text
    \ 0000                      .public deleteblockchain
    \ 0000          deleteblockchain:
    \ 0000 a200                 ldx     #0
    \ 0002 a009                 ldy     #9
    \ 0004 20....               jsr     `?L1395`
    \ 0007 a5..                 lda     zp:_Zp+2
    \ 0009 85..                 sta     zp:_Zp+25
    \ 000b a5..                 lda     zp:_Zp+3
    \ 000d 85..                 sta     zp:_Zp+24
    \ 000f a901                 lda     #1
    \ 0011 85..                 sta     zp:_Zp+4
    \ 0013 a5..                 lda     zp:_Zp+26
    \ 0015 20....               jsr     `?L1361`
    \ 0018 20....               jsr     `?L1385`
    \ 001b b004                 bcs     `?L402`
    \ 001d a9ff                 lda     #-1
    \ 001f 8077                 bra     `?L400`
    \ 0021          `?L402`:
    \ 0021 ad....               lda     BAMsector
    \ 0024 85..                 sta     zp:_Zp+30
    \ 0026 ad....               lda     BAMsector+1
    \ 0029 85..                 sta     zp:_Zp+31
    \ 002b a001                 ldy     #1
    \ 002d b1..                 lda     (_Zp+30),y
    \ 002f 85..                 sta     zp:_Zp+4
    \ 0031 88                   dey
    \ 0032 b1..                 lda     (_Zp+30),y
    \ 0034 20....               jsr     `?L1362`
    \ 0037 20....               jsr     `?L1385`
    \ 003a b004                 bcs     `?L409`
    \ 003c a9fe                 lda     #-2
    \ 003e 8058                 bra     `?L400`
    \ 0040          `?L409`:
    \ 0040 a5..                 lda     zp:_Zp+25
    \ 0042 f037                 beq     `?L410`
    \ 0044 a5..                 lda     zp:_Zp+24
    \ 0046 85..                 sta     zp:_Zp+4
    \ 0048 a5..                 lda     zp:_Zp+25
    \ 004a 85..                 sta     zp:_Zp+3
    \ 004c a5..                 lda     zp:_Zp+27
    \ 004e 20....               jsr     `?L1344`
    \ 0051 a5..                 lda     zp:_Zp+28
    \ 0053 20....               jsr     GetOneSector
    \ 0056 ad....               lda     worksector
    \ 0059 85..                 sta     zp:_Zp+32
    \ 005b ad....               lda     worksector+1
    \ 005e 85..                 sta     zp:_Zp+33
    \ 0060 a900                 lda     #0
    \ 0062 85..                 sta     zp:_Zp+5
    \ 0064 a5..                 lda     zp:_Zp+24
    \ 0066 20....               jsr     `?L1313`
    \ 0069 a5..                 lda     zp:_Zp+25
    \ 006b 20....               jsr     BAMSectorUpdate
    \ 006e a000                 ldy     #0
    \ 0070 b1..                 lda     (_Zp+32),y
    \ 0072 85..                 sta     zp:_Zp+25
    \ 0074 c8                   iny
    \ 0075 b1..                 lda     (_Zp+32),y
    \ 0077 85..                 sta     zp:_Zp+24
    \ 0079 80c5                 bra     `?L409`
    \ 007b a901     `?L410`:    lda     #1
    \ 007d 85..                 sta     zp:_Zp+4
    \ 007f a5..                 lda     zp:_Zp+26
    \ 0081 20....               jsr     `?L1361`
    \ 0084 20....               jsr     PutOneSector
    \ 0087 a001                 ldy     #1
    \ 0089 b1..                 lda     (_Zp+30),y
    \ 008b 85..                 sta     zp:_Zp+4
    \ 008d 88                   dey
    \ 008e b1..                 lda     (_Zp+30),y
    \ 0090 20....               jsr     `?L1362`
    \ 0093 20....               jsr     PutOneSector
    \ 0096 a900                 lda     #0
    \ 0098 a009     `?L400`:    ldy     #9
    \ 009a 4c....               jmp     _RestoreRegisters
    \ 0000                      .section code,text
    \ 0000                      .public tracksectorstring
    \ 0000          tracksectorstring:
    \ 0000 85..                 sta     zp:_Zp+13
    \ 0002 a5..                 lda     zp:_Zp
    \ 0004 85..                 sta     zp:_Zp+12
    \ 0006 20....               jsr     `?L1416`
    \ 0009 85..                 sta     zp:_Zp+5
    \ 000b a5..                 lda     zp:_Zp+4
    \ 000d 85..                 sta     zp:_Zp
    \ 000f a5..                 lda     zp:_Zp+5
    \ 0011 85..                 sta     zp:_Zp+1
    \ 0013 e3..                 inw     zp:_Zp+4
    \ 0015 a5..                 lda     zp:_Zp
    \ 0017 18                   clc
    \ 0018 69..                 adc     #.byte0 s
    \ 001a 85..                 sta     zp:_Zp
    \ 001c a5..                 lda     zp:_Zp+1
    \ 001e 69..                 adc     #.byte1 s
    \ 0020 85..                 sta     zp:_Zp+1
    \ 0022 a954                 lda     #84
    \ 0024 a000                 ldy     #0
    \ 0026 20....               jsr     `?L1299`
    \ 0029 a972                 lda     #114
    \ 002b 20....               jsr     `?L1299`
    \ 002e a961                 lda     #97
    \ 0030 20....               jsr     `?L1299`
    \ 0033 a963                 lda     #99
    \ 0035 20....               jsr     `?L1299`
    \ 0038 a96b                 lda     #107
    \ 003a 20....               jsr     `?L1299`
    \ 003d a93a                 lda     #58
    \ 003f 20....               jsr     `?L1299`
    \ 0042 a920                 lda     #32
    \ 0044 20....               jsr     `?L1366`
    \ 0047 65..                 adc     zp:_Zp
    \ 0049 48                   pha
    \ 004a 20....               jsr     `?L1360`
    \ 004d 68                   pla
    \ 004e a000                 ldy     #0
    \ 0050 20....               jsr     `?L1366`
    \ 0053 65..                 adc     zp:_Zp+2
    \ 0055 48                   pha
    \ 0056 20....               jsr     `?L1360`
    \ 0059 68                   pla
    \ 005a a000                 ldy     #0
    \ 005c 20....               jsr     `?L1299`
    \ 005f a920                 lda     #32
    \ 0061 20....               jsr     `?L1299`
    \ 0064 a953                 lda     #83
    \ 0066 20....               jsr     `?L1299`
    \ 0069 a965                 lda     #101
    \ 006b 20....               jsr     `?L1299`
    \ 006e a963                 lda     #99
    \ 0070 20....               jsr     `?L1299`
    \ 0073 a974                 lda     #116
    \ 0075 20....               jsr     `?L1299`
    \ 0078 a96f                 lda     #111
    \ 007a 20....               jsr     `?L1299`
    \ 007d a972                 lda     #114
    \ 007f 20....               jsr     `?L1299`
    \ 0082 a93a                 lda     #58
    \ 0084 20....               jsr     `?L1299`
    \ 0087 a920                 lda     #32
    \ 0089 20....               jsr     `?L1364`
    \ 008c 65..                 adc     zp:_Zp
    \ 008e 48                   pha
    \ 008f 20....               jsr     `?L1360`
    \ 0092 68                   pla
    \ 0093 a000                 ldy     #0
    \ 0095 20....               jsr     `?L1364`
    \ 0098 65..                 adc     zp:_Zp+2
    \ 009a 48                   pha
    \ 009b 20....               jsr     `?L1360`
    \ 009e 68                   pla
    \ 009f a000                 ldy     #0
    \ 00a1 91..                 sta     (_Zp),y
    \ 00a3 20....               jsr     `?L1421`
    \ 00a6 18                   clc
    \ 00a7 69..                 adc     #.byte0 s
    \ 00a9 85..                 sta     zp:_Zp
    \ 00ab a5..                 lda     zp:_Zp+1
    \ 00ad 69..                 adc     #.byte1 s
    \ 00af 85..                 sta     zp:_Zp+1
    \ 00b1 98                   tya
    \ 00b2 91..                 sta     (_Zp),y
    \ 00b4 a9..                 lda     #.byte0 s
    \ 00b6 85..                 sta     zp:_Zp
    \ 00b8 a9..                 lda     #.byte1 s
    \ 00ba 85..                 sta     zp:_Zp+1
    \ 00bc 60                   rts
1125
1126                unsigned char copywholedisk(unsigned char legacyHDOSstate,
1127                                            unsigned char srcdrive, unsigned char destdrive,
1128                                            unsigned char side)  {
    \ 0000                      .section code,text
    \ 0000                      .public copywholedisk
    \ 0000          copywholedisk:
    \ 0000 a200                 ldx     #0
    \ 0002 a008                 ldy     #8
    \ 0004 20....               jsr     `?L1427`
    \ 0007 a5..                 lda     zp:_Zp+1
    \ 0009 85..                 sta     zp:_Zp+30
1129                  unsigned char track;
1130                  unsigned char sector;
1131                  unsigned int  i;
1132                  DATABLOCK* ws;
1133                /*
1134                  // if setting allocated BAM blocks only:
1135                  if ((option.option & OPTIONshowALO))  {
1136                    i = 0;
1137                    GetBAM(side);
1138                    for (track = 1; track <= 80; track++)  {
1139                      for (sector = 0; sector < 40; sector++)  {
1140                        if (isallocatedBAMtracksector(track, sector))  {
1141                          progress("Reading...", tracksectorstring(track, sector), i / 64);
1142                          if (GetOneSector(worksectorasBAM[0], srcdrive, track, sector) > 1)  {
1143                            return 0xff;
1144                          }
1145                          ws = worksector[0];
1146                          lcopy((uint32_t) ws, ATTICFILEBUFFER + i * BLOCKSIZE, BLOCKSIZE);
1147
1148                          progress("Writing...", tracksectorstring(track, sector), i / 64 + 50);
1149                          lcopy(ATTICFILEBUFFER + i * BLOCKSIZE, (uint32_t) ws, BLOCKSIZE);
1150                          PutOneSector((BAM *) ws, destdrive, track, sector);
1151                        }
1152                        i++;
1153                      }
1154                    }
1155                  } else  {
1156                */
1157                    i = 0;
    \ 000b 8a                   txa
    \ 000c 85..                 sta     zp:_Zp+26
    \ 000e 85..                 sta     zp:_Zp+27
1158                    for (track = 1; track <= 80; track++)  {
    \ 0010 a901                 lda     #1
    \ 0012 85..                 sta     zp:_Zp+28
    \ 0014 a350     `?L421`:    ldz     #80
    \ 0016 d4..                 cpz     zp:_Zp+28
    \ 0018 b3a300               lbcs    `?L420`
1159                      for (sector = 0; sector < 40; sector += 2)  {
1160                        if (!(option.option & OPTIONshowALO) ||
1161                            isallocatedBAMtracksector(track, sector) ||
1162                            isallocatedBAMtracksector(track, sector + 1))  {
1163                          progress("Reading...", tracksectorstring(track, sector), i / 64);
1164                          if (GetWholeSector(legacyHDOSstate,
1165                                          worksectorasBAM[0], srcdrive, track, sector) > 1)  {
1166                            return 0xff;
1167                          }
1168                          ws = worksector[0];
1169                          lcopy((uint32_t) ws, ATTICFILEBUFFER + i * BLOCKSIZE, BLOCKSIZE * 2);
1170                          i += 2;
1171                        }
1172                      }
1173                    }
1174                    i = 0;
    \ 001b a900                 lda     #0
    \ 001d 85..                 sta     zp:_Zp+28
    \ 001f 85..                 sta     zp:_Zp+29
1175                    for (track = 1; track <= 80; track++)  {
    \ 0021 a901                 lda     #1
    \ 0023 85..                 sta     zp:_Zp+26
    \ 0025 a350     `?L436`:    ldz     #80
    \ 0027 d4..                 cpz     zp:_Zp+26
    \ 0029 b005                 bcs     `?L435`
1176                      for (sector = 0; sector < 40; sector += 2)  {
1177                        if (!(option.option & OPTIONshowALO) ||
1178                            isallocatedBAMtracksector(track, sector) ||
1179                            isallocatedBAMtracksector(track, sector + 1))  {
1180                          progress("Writing...", tracksectorstring(track, sector), i / 64 + 50);
1181                          lcopy(ATTICFILEBUFFER + i * BLOCKSIZE, (uint32_t) ws, BLOCKSIZE * 2);
1182                          PutWholeSector(legacyHDOSstate,
1183                                         (BAM *) ws, destdrive, track, sector);
1184                          i += 2;
1185                        }
1186                      }
1187                    }
1188                //  }
1189                  return 0;
    \ 002b a900                 lda     #0
    \ 002d 4c....               jmp     `?L419`
    \ 0030 a900     `?L435`:    lda     #0
    \ 0032 85..                 sta     zp:_Zp+27
    \ 0034          `?L440`:
    \ 0034 ab....               ldz     _Zp+27
    \ 0037 c228                 cpz     #40
    \ 0039 9004                 bcc     `?L439`
    \ 003b e6..                 inc     zp:_Zp+26
    \ 003d 80e6                 bra     `?L436`
    \ 003f a902     `?L439`:    lda     #2
    \ 0041 2c....               bit     option
    \ 0044 f01a                 beq     `?L445`
    \ 0046 a5..                 lda     zp:_Zp+27
    \ 0048 85..                 sta     zp:_Zp
    \ 004a a5..                 lda     zp:_Zp+26
    \ 004c 20....               jsr     isallocatedBAMtracksector
    \ 004f aa                   tax
    \ 0050 d00e                 bne     `?L445`
    \ 0052 a5..                 lda     zp:_Zp+27
    \ 0054 85..                 sta     zp:_Zp
    \ 0056 e6..                 inc     zp:_Zp
    \ 0058 a5..                 lda     zp:_Zp+26
    \ 005a 20....               jsr     isallocatedBAMtracksector
    \ 005d aa                   tax
    \ 005e f056                 beq     `?L441`
    \ 0060          `?L445`:
    \ 0060 a5..                 lda     zp:_Zp+27
    \ 0062 85..                 sta     zp:_Zp
    \ 0064 a5..                 lda     zp:_Zp+26
    \ 0066 20....               jsr     tracksectorstring
    \ 0069 a5..                 lda     zp:_Zp+28
    \ 006b 85..                 sta     zp:_Zp+4
    \ 006d a5..                 lda     zp:_Zp+29
    \ 006f 85..                 sta     zp:_Zp+5
    \ 0071 a206                 ldx     #6
    \ 0073 f007                 beq     `?L990`
    \ 0075          `?L991`:
    \ 0075 46..                 lsr     zp:_Zp+5
    \ 0077 66..                 ror     zp:_Zp+4
    \ 0079 ca                   dex
    \ 007a d0f9                 bne     `?L991`
    \ 007c          `?L990`:
    \ 007c 20....               jsr     `?L1436`
    \ 007f 20....               jsr     `?L1382`
    \ 0082 a5..                 lda     zp:_Zp+4
    \ 0084 18                   clc
    \ 0085 6932                 adc     #50
    \ 0087 20....               jsr     progress
    \ 008a 20....               jsr     `?L1332`
    \ 008d 20....               jsr     `?L1324`
    \ 0090 20....               jsr     `?L1443`
    \ 0093 98                   tya
    \ 0094 20....               jsr     `?L1359`
    \ 0097 85..                 sta     zp:_Zp
    \ 0099 a26a                 ldx     #106
    \ 009b a308                 ldz     #8
    \ 009d 20....               jsr     `?L1305`
    \ 00a0 a5..                 lda     zp:_Zp+27
    \ 00a2 85..                 sta     zp:_Zp+4
    \ 00a4 a5..                 lda     zp:_Zp+26
    \ 00a6 85..                 sta     zp:_Zp+3
    \ 00a8 a5..                 lda     zp:_Zp+30
    \ 00aa 85..                 sta     zp:_Zp+2
    \ 00ac 20....               jsr     `?L1323`
    \ 00af 20....               jsr     `?L1445`
    \ 00b2 e3..                 inw     zp:_Zp+28
    \ 00b4 e3..                 inw     zp:_Zp+28
    \ 00b6          `?L441`:
    \ 00b6 e6..                 inc     zp:_Zp+27
    \ 00b8 e6..                 inc     zp:_Zp+27
    \ 00ba 4c....               jmp     `?L440`
    \ 00bd a900     `?L420`:    lda     #0
    \ 00bf 85..                 sta     zp:_Zp+29
    \ 00c1          `?L425`:
    \ 00c1 ab....               ldz     _Zp+29
    \ 00c4 c228                 cpz     #40
    \ 00c6 9005                 bcc     `?L424`
    \ 00c8 e6..                 inc     zp:_Zp+28
    \ 00ca 4c....               jmp     `?L421`
    \ 00cd a902     `?L424`:    lda     #2
    \ 00cf 2c....               bit     option
    \ 00d2 f01a                 beq     `?L430`
    \ 00d4 a5..                 lda     zp:_Zp+29
    \ 00d6 85..                 sta     zp:_Zp
    \ 00d8 a5..                 lda     zp:_Zp+28
    \ 00da 20....               jsr     isallocatedBAMtracksector
    \ 00dd aa                   tax
    \ 00de d00e                 bne     `?L430`
    \ 00e0 a5..                 lda     zp:_Zp+29
    \ 00e2 85..                 sta     zp:_Zp
    \ 00e4 e6..                 inc     zp:_Zp
    \ 00e6 a5..                 lda     zp:_Zp+28
    \ 00e8 20....               jsr     isallocatedBAMtracksector
    \ 00eb aa                   tax
    \ 00ec f076                 beq     `?L426`
    \ 00ee          `?L430`:
    \ 00ee a5..                 lda     zp:_Zp+29
    \ 00f0 85..                 sta     zp:_Zp
    \ 00f2 a5..                 lda     zp:_Zp+28
    \ 00f4 20....               jsr     tracksectorstring
    \ 00f7 20....               jsr     `?L1436`
    \ 00fa 85..                 sta     zp:_Zp+3
    \ 00fc a9..                 lda     #.byte0 `_StringLiteral_Reading...`
    \ 00fe 85..                 sta     zp:_Zp
    \ 0100 a9..                 lda     #.byte1 `_StringLiteral_Reading...`
    \ 0102 85..                 sta     zp:_Zp+1
    \ 0104 a5..                 lda     zp:_Zp+26
    \ 0106 85..                 sta     zp:_Zp+4
    \ 0108 a5..                 lda     zp:_Zp+27
    \ 010a 85..                 sta     zp:_Zp+5
    \ 010c a206                 ldx     #6
    \ 010e f007                 beq     `?L1001`
    \ 0110          `?L1002`:
    \ 0110 46..                 lsr     zp:_Zp+5
    \ 0112 66..                 ror     zp:_Zp+4
    \ 0114 ca                   dex
    \ 0115 d0f9                 bne     `?L1002`
    \ 0117          `?L1001`:
    \ 0117 a5..                 lda     zp:_Zp+4
    \ 0119 20....               jsr     progress
    \ 011c a5..                 lda     zp:_Zp+29
    \ 011e 85..                 sta     zp:_Zp+4
    \ 0120 a5..                 lda     zp:_Zp+28
    \ 0122 85..                 sta     zp:_Zp+3
    \ 0124 a5..                 lda     zp:_Zp+31
    \ 0126 20....               jsr     `?L1344`
    \ 0129 a5..                 lda     zp:_Zp+32
    \ 012b 20....               jsr     GetWholeSector
    \ 012e 85..                 sta     zp:_Zp
    \ 0130 a301                 ldz     #1
    \ 0132 d4..                 cpz     zp:_Zp
    \ 0134 b007                 bcs     `?L432`
    \ 0136 a9ff                 lda     #-1
    \ 0138          `?L419`:
1190                }
    \ 0138 a008                 ldy     #8
    \ 013a 4c....               jmp     _RestoreRegisters
    \ 013d          `?L432`:
    \ 013d 20....               jsr     `?L1381`
    \ 0140 20....               jsr     `?L1332`
    \ 0143 a5..                 lda     zp:_Zp+27
    \ 0145 85..                 sta     zp:_Zp+1
    \ 0147 a5..                 lda     zp:_Zp+26
    \ 0149 85..                 sta     zp:_Zp
    \ 014b 98                   tya
    \ 014c 20....               jsr     `?L1359`
    \ 014f 85..                 sta     zp:_Zp
    \ 0151 a26a                 ldx     #106
    \ 0153 20....               jsr     `?L1341`
    \ 0156 424285..             stq     zp:_Zp+4
    \ 015a 20....               jsr     `?L1354`
    \ 015d 20....               jsr     `?L1314`
    \ 0160 e3..                 inw     zp:_Zp+26
    \ 0162 e3..                 inw     zp:_Zp+26
    \ 0164          `?L426`:
    \ 0164 e6..                 inc     zp:_Zp+29
    \ 0166 e6..                 inc     zp:_Zp+29
    \ 0168 4c....               jmp     `?L425`
1191
1192                // this is a mixture of storage card and C= file types:
1193                unsigned char gettype(unsigned char type, unsigned char * s, unsigned char i)  {
    \ 0000                      .section code,text
    \ 0000                      .public gettype
    \ 0000          gettype:
    \ 0000 85..                 sta     zp:_Zp+3
1194                  if (type & HYPPODIRENTATTR)  {
    \ 0002 6f..30               bbr6    zp:_Zp+3,`?L450`
1195                    switch (type & (~HYPPODIRENTATTR)) {
    \ 0005 67..                 rmb6    zp:_Zp+3
    \ 0007 a210                 ldx     #16
    \ 0009 e4..                 cpx     zp:_Zp+3
    \ 000b f014                 beq     `?L456`
1196                      case HYPPODIRENTATTRDIR:
1197                        s[i++] = 'D';
1198                        s[i++] = 'I';
1199                        s[i++] = 'R';
1200                      break;
1201                      default:
1202                        s[i++] = ' ';
    \ 000d a5..                 lda     zp:_Zp+2
    \ 000f e6..                 inc     zp:_Zp+2
    \ 0011 4b                   taz
    \ 0012 a920                 lda     #32
1203                        s[i++] = ' ';
1204                        s[i++] = ' ';
    \ 0014 20....               jsr     `?L1334`
    \ 0017 a920                 lda     #32
    \ 0019 20....               jsr     `?L1334`
    \ 001c a920                 lda     #32
1205                      break;
    \ 001e 4c....               jmp     `?L1273`
    \ 0021          `?L456`:
    \ 0021 a5..                 lda     zp:_Zp+2
    \ 0023 e6..                 inc     zp:_Zp+2
    \ 0025 4b                   taz
    \ 0026 a944                 lda     #68
    \ 0028 20....               jsr     `?L1334`
    \ 002b a949                 lda     #73
    \ 002d 20....               jsr     `?L1334`
    \ 0030 a952                 lda     #82
    \ 0032 4c....               jmp     `?L1273`
    \ 0035          `?L450`:
1206                    }
1207                  } else {
1208                    switch (type & 0xf) {
    \ 0035 a90f                 lda     #15
    \ 0037 25..                 and     zp:_Zp+3
    \ 0039 3a                   dec     a
    \ 003a 85..                 sta     zp:_Zp+3
    \ 003c a304                 ldz     #4
    \ 003e d4..                 cpz     zp:_Zp+3
    \ 0040 9066                 bcc     `?L461`
    \ 0042 a5..                 lda     zp:_Zp+3
    \ 0044 0a                   asl     a
    \ 0045 aa                   tax
    \ 0046 7c....               jmp     (`?L623`,x)
    \ 0049          `?L462`:
1209                      case VAL_DOSFTYPE_SEQ:
1210                        s[i++] = 'S';
1211                        s[i++] = 'E';
1212                        s[i++] = 'Q';
1213                      break;
1214                      case VAL_DOSFTYPE_PRG:
1215                        s[i++] = 'P';
1216                        s[i++] = 'R';
1217                        s[i++] = 'G';
1218                      break;
1219                      case VAL_DOSFTYPE_USR:
1220                        s[i++] = 'U';
1221                        s[i++] = 'S';
1222                        s[i++] = 'R';
1223                      break;
1224                      case VAL_DOSFTYPE_REL:
1225                        s[i++] = 'R';
1226                        s[i++] = 'E';
1227                        s[i++] = 'L';
1228                      break;
1229                      case VAL_DOSFTYPE_CBM:
1230                        s[i++] = 'C';
    \ 0049 a5..                 lda     zp:_Zp+2
    \ 004b e6..                 inc     zp:_Zp+2
    \ 004d 4b                   taz
    \ 004e a943                 lda     #67
1231                        s[i++] = 'B';
1232                        s[i++] = 'M';
    \ 0050 20....               jsr     `?L1334`
    \ 0053 a942                 lda     #66
    \ 0055 20....               jsr     `?L1334`
    \ 0058 a94d                 lda     #77
1233                      break;
    \ 005a 805d                 bra     `?L1273`
    \ 005c          `?L463`:
    \ 005c a5..                 lda     zp:_Zp+2
    \ 005e e6..                 inc     zp:_Zp+2
    \ 0060 4b                   taz
    \ 0061 a952                 lda     #82
    \ 0063 20....               jsr     `?L1334`
    \ 0066 a945                 lda     #69
    \ 0068 20....               jsr     `?L1334`
    \ 006b a94c                 lda     #76
    \ 006d 804a                 bra     `?L1273`
    \ 006f          `?L464`:
    \ 006f a5..                 lda     zp:_Zp+2
    \ 0071 e6..                 inc     zp:_Zp+2
    \ 0073 4b                   taz
    \ 0074 a955                 lda     #85
    \ 0076 20....               jsr     `?L1334`
    \ 0079 a953                 lda     #83
    \ 007b 20....               jsr     `?L1334`
    \ 007e a952                 lda     #82
    \ 0080 8037                 bra     `?L1273`
    \ 0082          `?L465`:
    \ 0082 a5..                 lda     zp:_Zp+2
    \ 0084 e6..                 inc     zp:_Zp+2
    \ 0086 4b                   taz
    \ 0087 a950                 lda     #80
    \ 0089 20....               jsr     `?L1334`
    \ 008c a952                 lda     #82
    \ 008e 20....               jsr     `?L1334`
    \ 0091 a947                 lda     #71
    \ 0093 8024                 bra     `?L1273`
    \ 0095          `?L466`:
    \ 0095 a5..                 lda     zp:_Zp+2
    \ 0097 e6..                 inc     zp:_Zp+2
    \ 0099 4b                   taz
    \ 009a a953                 lda     #83
    \ 009c 20....               jsr     `?L1334`
    \ 009f a945                 lda     #69
    \ 00a1 20....               jsr     `?L1334`
    \ 00a4 a951                 lda     #81
    \ 00a6 8011                 bra     `?L1273`
    \ 00a8          `?L461`:
1234                      default: // VAL_DOSFTYPE_DEL
1235                        s[i++] = 'D';
    \ 00a8 a5..                 lda     zp:_Zp+2
    \ 00aa e6..                 inc     zp:_Zp+2
    \ 00ac 4b                   taz
    \ 00ad a944                 lda     #68
1236                        s[i++] = 'E';
1237                        s[i++] = 'L';
    \ 00af 20....               jsr     `?L1334`
    \ 00b2 a945                 lda     #69
    \ 00b4 20....               jsr     `?L1334`
    \ 00b7 a94c                 lda     #76
    \ 00b9          `?L1273`:
    \ 00b9 92..                 sta     (_Zp),z
1238                      break;
1239                    }
1240                  }
1241                  return i;
    \ 00bb a5..                 lda     zp:_Zp+2
1242                }
    \ 00bd 60                   rts
1243
1244                DIRENT* getdirententry(unsigned char side, unsigned int entry)  {
    \ 0000                      .section code,text
    \ 0000                      .public getdirententry
    \ 0000          getdirententry:
    \ 0000 a200                 ldx     #0
    \ 0002 a00a                 ldy     #10
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+34
    \ 0009 20....               jsr     `?L1387`
    \ 000c 85..                 sta     zp:_Zp+27
1245                  unsigned int i;
1246                  unsigned int pos;
1247                  DIRENT* ds;
1248                  unsigned int max = ENTRIESPERBLOCK;
    \ 000e a908                 lda     #8
    \ 0010 85..                 sta     zp:_Zp+28
    \ 0012 a900                 lda     #0
    \ 0014 85..                 sta     zp:_Zp+29
1249
1250                  ds = &readdir_dirent->direntryblock[0];
1251
1252                  for (i = 0, pos = 0; i < max; i++)  {
    \ 0016 20....               jsr     `?L1426`
    \ 0019 85..                 sta     zp:_Zp+24
    \ 001b 8a                   txa
    \ 001c 6d....               adc     readdir_dirent+1
    \ 001f 85..                 sta     zp:_Zp+25
    \ 0021 8a                   txa
    \ 0022 85..                 sta     zp:_Zp+32
    \ 0024 85..                 sta     zp:_Zp+33
    \ 0026 85..                 sta     zp:_Zp+30
    \ 0028 85..                 sta     zp:_Zp+31
    \ 002a          `?L478`:
    \ 002a a5..                 lda     zp:_Zp+32
    \ 002c c5..                 cmp     zp:_Zp+28
    \ 002e a5..                 lda     zp:_Zp+33
    \ 0030 e5..                 sbc     zp:_Zp+29
    \ 0032 9006                 bcc     `?L477`
1253                    // lcopy(uint32_t source_address, uint32_t destination_address, uint16_t count);
1254                    lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i * DIRENTSIZE,
1255                          (uint32_t) ds, DIRENTSIZE);
1256
1257                //    if (ds->track == 0)  return NULL; // no more entries
1258                    if ((ds->chntrack > 0) &&
1259                        ((i % ENTRIESPERBLOCK) == 0))  {
1260                      max += ENTRIESPERBLOCK; // more attic pages
1261                    }
1262                    // if a non-deleted or a SD card file (hence no mask) ?
1263                    if (ds->type != VAL_DOSFTYPE_DEL || (option.option & OPTIONshowDEL))  {
1264                      if (pos == entry)  return ds; // found
1265                      pos++;
1266                    }
1267
1268                #ifdef DEBUG
1269                    if (ds->track > 0)  {
1270                      mprintf("direntry ", i);
1271                      mh4printf(" is: ", (long) &ds);
1272                      memcpy(dosfilename, ds->name, DOSFILENAMELEN);
1273                      dosfilename[DOSFILENAMELEN] = 0; // proper null termination
1274                      msprintf(" name ");
1275                //        msprintf((char *) dosfilename);
1276                      mprintf(" chntrk ", ds->chntrack);
1277                      mprintf(" chnsect ", ds->chnsector);
1278                      mhprintf(" type ", ds->type&0xf);
1279                      mprintf(" trk ", ds->track);
1280                      mprintf(" sect ", ds->sector);
1281                      mprintf(" size ", ds->size);
1282                      mhprintf(" access ", ds->access);
1283                      cputln();
1284                    }
1285                #endif
1286                  }
1287                //  cgetc();
1288                  return NULL;
    \ 0034 a900                 lda     #0
    \ 0036 85..                 sta     zp:_Zp
    \ 0038 806d                 bra     `?L1274`
    \ 003a          `?L477`:
    \ 003a a6..                 ldx     zp:_Zp+34
    \ 003c 20....               jsr     `?L1296`
    \ 003f f005                 beq     `?L1010`
    \ 0041          `?L1011`:
    \ 0041 20....               jsr     `?L1350`
    \ 0044 d0fb                 bne     `?L1011`
    \ 0046          `?L1010`:
    \ 0046 20....               jsr     _SpillZP
    \ 0049 04..                 .byte   4,_Zp+4
    \ 004b 20....               jsr     _FillQ
    \ 004e 20....               jsr     `?L1308`
    \ 0051 20....               jsr     `?L1412`
    \ 0054 20....               jsr     `?L1324`
    \ 0057 aa                   tax
    \ 0058 20....               jsr     `?L1341`
    \ 005b 48                   pha
    \ 005c da                   phx
    \ 005d 5a                   phy
    \ 005e db                   phz
    \ 005f a5..                 lda     zp:_Zp+32
    \ 0061 85..                 sta     zp:_Zp
    \ 0063 a5..                 lda     zp:_Zp+33
    \ 0065 20....               jsr     `?L1347`
    \ 0068 f005                 beq     `?L1014`
    \ 006a          `?L1015`:
    \ 006a 20....               jsr     `?L1378`
    \ 006d d0fb                 bne     `?L1015`
    \ 006f a900     `?L1014`:   lda     #0
    \ 0071 85..                 sta     zp:_Zp+2
    \ 0073 85..                 sta     zp:_Zp+3
    \ 0075 fb                   plz
    \ 0076 7a                   ply
    \ 0077 fa                   plx
    \ 0078 68                   pla
    \ 0079 20....               jsr     `?L1305`
    \ 007c 88                   dey
    \ 007d b1..                 lda     (_Zp+24),y
    \ 007f f009                 beq     `?L482`
    \ 0081 a5..                 lda     zp:_Zp+32
    \ 0083 2907                 and     #7
    \ 0085 d003                 bne     `?L482`
    \ 0087 20....               jsr     `?L1401`
    \ 008a a002     `?L482`:    ldy     #2
    \ 008c b1..                 lda     (_Zp+24),y
    \ 008e d005                 bne     `?L486`
    \ 0090 20....               jsr     `?L1433`
    \ 0093 f01b                 beq     `?L479`
    \ 0095          `?L486`:
    \ 0095 a5..                 lda     zp:_Zp+26
    \ 0097 c5..                 cmp     zp:_Zp+30
    \ 0099 d013                 bne     `?L488`
    \ 009b a5..                 lda     zp:_Zp+27
    \ 009d c5..                 cmp     zp:_Zp+31
    \ 009f d00d                 bne     `?L488`
    \ 00a1 a5..                 lda     zp:_Zp+24
    \ 00a3 85..                 sta     zp:_Zp
    \ 00a5 a5..                 lda     zp:_Zp+25
    \ 00a7          `?L1274`:
    \ 00a7 85..                 sta     zp:_Zp+1
1289                }
    \ 00a9 a00a                 ldy     #10
    \ 00ab 4c....               jmp     _RestoreRegisters
    \ 00ae          `?L488`:
    \ 00ae e3..                 inw     zp:_Zp+30
    \ 00b0          `?L479`:
    \ 00b0 e3..                 inw     zp:_Zp+32
    \ 00b2 4c....               jmp     `?L478`
1290                unsigned char getdirent(unsigned char legacyHDOSstate, unsigned char drive,
1291                                        unsigned char side, unsigned char dirtrack)  {
    \ 0000                      .section code,text
    \ 0000                      .public getdirent
    \ 0000          getdirent:
    \ 0000 20....               jsr     `?L1372`
    \ 0003 85..                 sta     zp:_Zp+16
    \ 0005 a5..                 lda     zp:_Zp
    \ 0007 85..                 sta     zp:_Zp+6
    \ 0009 a5..                 lda     zp:_Zp+1
    \ 000b 85..                 sta     zp:_Zp+26
1292                  signed int entry; // counts below zero
1293
1294                  // _miniInit();
1295                /*
1296                  msprintf("before readblockchain");
1297                  cputln();
1298                  cgetc();
1299                */
1300                  if (readblockchain(legacyHDOSstate,
1301                                     ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE,
1302                                     DIRENTBLOCKS, drive, dirtrack, DIRENTSECT) > 1)  {
    \ 000d a6..                 ldx     zp:_Zp+26
    \ 000f 20....               jsr     `?L1441`
    \ 0012 20....               jsr     `?L1355`
    \ 0015 20....               jsr     `?L1388`
    \ 0018 f007                 beq     `?L1021`
    \ 001a          `?L1022`:
    \ 001a 424206..             aslq    zp:_Zp+12
    \ 001e ca                   dex
    \ 001f d0f9                 bne     `?L1022`
    \ 0021          `?L1021`:
    \ 0021 20....               jsr     _SpillZP
    \ 0024 04..                 .byte   4,_Zp+12
    \ 0026 20....               jsr     _FillQ
    \ 0029 38                   sec
    \ 002a 4242e5..             sbcq    zp:_Zp+8
    \ 002e 424285..             stq     zp:_Zp+8
    \ 0032 a9ff                 lda     #-1
    \ 0034 20....               jsr     _DecVsp
    \ 0037 a903                 lda     #3
    \ 0039 a000                 ldy     #0
    \ 003b 91..                 sta     (_Vsp),y
    \ 003d a5..                 lda     zp:_Zp+2
    \ 003f 85..                 sta     zp:_Zp+7
    \ 0041 a91f                 lda     #31
    \ 0043 85..                 sta     zp:_Zp+4
    \ 0045 a900                 lda     #0
    \ 0047 85..                 sta     zp:_Zp+5
    \ 0049 aa                   tax
    \ 004a a308                 ldz     #8
    \ 004c 18                   clc
    \ 004d 424265..             adcq    zp:_Zp+8
    \ 0051 424285..             stq     zp:_Zp
    \ 0055 a5..                 lda     zp:_Zp+16
    \ 0057 20....               jsr     `?L1429`
    \ 005a 85..                 sta     zp:_Zp
    \ 005c a301                 ldz     #1
    \ 005e d4..                 cpz     zp:_Zp
    \ 0060 900c                 bcc     `?L502`
1303                    return 0xff;
1304                  }
1305                /*
1306                  msprintf("after readblockchain");
1307                  cputln();
1308                  cgetc();
1309                */
1310                  for (entry = NBRENTRIES; entry >= 0; entry--)  {
    \ 0062 a9f8                 lda     #248
    \ 0064 85..                 sta     zp:_Zp+24
    \ 0066 a900                 lda     #0
    \ 0068 85..                 sta     zp:_Zp+25
    \ 006a          `?L500`:
    \ 006a a5..                 lda     zp:_Zp+25
    \ 006c 1004                 bpl     `?L499`
    \ 006e          `?L502`:
1311                //    if (entry < 10)  valuesbox(0, "loop entries", "entry=", entry, " ", 0);
1312                    if (getdirententry(side, entry) != NULL)  return entry;  // nbr of entries
1313                  }
1314                  return 0xff;
    \ 006e a9ff                 lda     #-1
    \ 0070 8010                 bra     `?L494`
    \ 0072          `?L499`:
    \ 0072 20....               jsr     `?L1323`
    \ 0075 a5..                 lda     zp:_Zp+26
    \ 0077 20....               jsr     getdirententry
    \ 007a a5..                 lda     zp:_Zp
    \ 007c 05..                 ora     zp:_Zp+1
    \ 007e f007                 beq     `?L501`
    \ 0080 a5..                 lda     zp:_Zp+24
    \ 0082          `?L494`:
1315                }
    \ 0082 a002                 ldy     #2
    \ 0084 4c....               jmp     _RestoreRegisters
    \ 0087          `?L501`:
    \ 0087 c3..                 dew     zp:_Zp+24
    \ 0089 80df                 bra     `?L500`
1316
1317                // start track/sector must be present in newds:
1318                void writenewdirententry(unsigned char legacyHDOSstate,
1319                                         unsigned char drive, unsigned char side,
1320                                         unsigned char dirtrack,
1321                                         unsigned char firsttrack, unsigned char lasttrack,
1322                                         DIRENT* newds)  {
    \ 0000                      .section code,text
    \ 0000                      .public writenewdirententry
    \ 0000          writenewdirententry:
    \ 0000 a2ef                 ldx     #239
    \ 0002 20....               jsr     `?L1434`
    \ 0005 a007                 ldy     #7
    \ 0007 91..                 sta     (_Vsp),y
    \ 0009 a5..                 lda     zp:_Zp+1
    \ 000b 85..                 sta     zp:_Zp+28
    \ 000d a5..                 lda     zp:_Zp+2
    \ 000f 88                   dey
    \ 0010 91..                 sta     (_Vsp),y
    \ 0012 a5..                 lda     zp:_Zp+3
    \ 0014 a000                 ldy     #0
    \ 0016 91..                 sta     (_Vsp),y
    \ 0018 a5..                 lda     zp:_Zp+4
    \ 001a c8                   iny
    \ 001b 91..                 sta     (_Vsp),y
    \ 001d a00f                 ldy     #15
    \ 001f 20....               jsr     `?L1432`
1323                  unsigned char i;
1324                  unsigned char topdirent = 0;  // keep number of first dirent of current sector
    \ 0022 a900                 lda     #0
    \ 0024 85..                 sta     zp:_Zp
1325                  DIRENT* ds;
1326                //  DIRENT* newds;
1327                  unsigned int max = ENTRIESPERBLOCK;
    \ 0026 a908                 lda     #8
    \ 0028 85..                 sta     zp:_Zp+2
1328                  unsigned char track = dirtrack;
1329                  unsigned char sector = DIRENTSECT;  // @@ to be changed for sector chained by t=40, s=0
1330                  unsigned char nexttrack = 0;
1331                  unsigned char nextsector = 0;
1332
1333                  // _miniInit();
1334
1335                  // blatantly misuse the unfilled DIRENT buffer:
1336                  ds = &readdir_dirent->direntryblock[1];
1337
1338                  // first try overwriting DEL file entry:
1339                  for (i = 0; i < max; i++)  {
    \ 002a 20....               jsr     `?L1452`
    \ 002d a006                 ldy     #6
    \ 002f 20....               jsr     `?L1317`
    \ 0032 a903                 lda     #3
    \ 0034 85..                 sta     zp:_Zp+4
    \ 0036 a900                 lda     #0
    \ 0038 a00c                 ldy     #12
    \ 003a 91..                 sta     (_Vsp),y
    \ 003c c8                   iny
    \ 003d 91..                 sta     (_Vsp),y
    \ 003f 18                   clc
    \ 0040 a9e0                 lda     #224
    \ 0042 6d....               adc     readdir_dirent
    \ 0045 85..                 sta     zp:_Zp+24
    \ 0047 a900                 lda     #0
    \ 0049 6d....               adc     readdir_dirent+1
    \ 004c 85..                 sta     zp:_Zp+25
    \ 004e a900                 lda     #0
    \ 0050 85..                 sta     zp:_Zp+29
    \ 0052 a5..                 lda     zp:_Zp
    \ 0054 c8                   iny
    \ 0055 91..                 sta     (_Vsp),y
    \ 0057 20....               jsr     `?L1417`
    \ 005a a5..                 lda     zp:_Zp+1
    \ 005c a009                 ldy     #9
    \ 005e 91..                 sta     (_Vsp),y
    \ 0060 a5..                 lda     zp:_Zp+4
    \ 0062 88       `?L1276`:   dey
    \ 0063 91..                 sta     (_Vsp),y
    \ 0065 a5..                 lda     zp:_Zp+29
    \ 0067 a00a                 ldy     #10
    \ 0069 d1..                 cmp     (_Vsp),y
    \ 006b a900                 lda     #0
    \ 006d c8                   iny
    \ 006e f1..                 sbc     (_Vsp),y
    \ 0070 931802               lbcc    `?L511`
1340                    // lcopy(uint32_t source_address, uint32_t destination_address, uint16_t count);
1341                    lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i * DIRENTSIZE,
1342                          (uint32_t) ds, DIRENTSIZE);
1343
1344                    if ((i % ENTRIESPERBLOCK) == 0)  {
1345                      topdirent = i;
1346                      // not for the first iteration:
1347                      if (i > 0)  {
1348                        track = nexttrack;
1349                        sector = nextsector;
1350                      }
1351                    }
1352                    if (ds->chntrack > 0)  {
1353                      max += ENTRIESPERBLOCK; // more attic pages
1354                      nexttrack = ds->chntrack;  // chain for where to write dirent sector
1355                      nextsector = ds->chnsector;
1356                    }
1357                    if ((ds->type&0xf) == VAL_DOSFTYPE_DEL)  {
1358                      newds->chntrack = ds->chntrack;  // keep blockchain
1359                      newds->chnsector = ds->chnsector;
1360                      lcopy((uint32_t) newds,
1361                            ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i * DIRENTSIZE,
1362                            DIRENTSIZE);
1363
1364                #ifdef DEBUG
1365                      mprintf("writenewdirententry i=", i);
1366                      mprintf(" ofs=", side * ATTICDIRENTSIZE +
1367                                       i / (BLOCKSIZE / DIRENTSIZE) * BLOCKSIZE);
1368                      mprintf(" side=", sector % 2);
1369                      mprintf(" newds->track=", newds->track);
1370                      mprintf(" newds->sector=", newds->sector);
1371                      cputln();
1372                      mprintf("track=", track);
1373                      mprintf(" sector=", sector);
1374                      mprintf(" nexttrack=", nexttrack);
1375                      mprintf(" nextsector=", nextsector);
1376                      mprintf(" type=", (newds->type&0xf));
1377                      cputln();
1378                      mh4printf(" ds addr=", (long) ds);
1379                      mh4printf(" newds addr=", (long) newds);
1380                      cputln();
1381                      cgetc();
1382                #endif
1383
1384                      lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE +
1385                              i / (BLOCKSIZE / DIRENTSIZE) * BLOCKSIZE,
1386                            BLOCKDATALOW, BLOCKSIZE);
1387                      PutOneSector(legacyHDOSstate,
1388                                   (BAM *) worksectorasBAM[0], drive, track, sector);
1389                #ifdef DEBUG
1390                      msprintf("writenewdirententry done");
1391                      cputln();
1392                      cgetc();
1393                #endif
1394                      return;
1395                    }
1396
1397                #ifdef DEBUG
1398                    if (ds->track > 0)  {
1399                      mprintf("writedirentry ", i);
1400                      mh4printf(" is: ", (long) &ds);
1401                      memcpy(dosfilename, ds->name, DOSFILENAMELEN);
1402                      dosfilename[DOSFILENAMELEN] = 0; // proper null termination
1403                      msprintf(" name ");
1404                //        msprintf((char *) dosfilename);
1405                      mprintf(" chntrk ", ds->chntrack);
1406                      mprintf(" chnsect ", ds->chnsector);
1407                      mhprintf(" type ", ds->type&0xf);
1408                      mprintf(" trk ", ds->track);
1409                      mprintf(" sect ", ds->sector);
1410                      mprintf(" size ", ds->size);
1411                      mhprintf(" access ", ds->access);
1412                      cputln();
1413                      cgetc();
1414                    }
1415                #endif
1416                  }
1417                  
1418                  // peek first dirent of full block to set new chain:
1419                  lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + topdirent * DIRENTSIZE,
    \ 0073 a6..                 ldx     zp:_Zp+28
    \ 0075 20....               jsr     `?L1296`
    \ 0078 f005                 beq     `?L1029`
    \ 007a          `?L1030`:
    \ 007a 20....               jsr     `?L1350`
    \ 007d d0fb                 bne     `?L1030`
    \ 007f          `?L1029`:
    \ 007f 20....               jsr     _SpillZP
    \ 0082 04..                 .byte   4,_Zp+4
    \ 0084 20....               jsr     _FillQ
    \ 0087 20....               jsr     `?L1308`
    \ 008a 20....               jsr     `?L1412`
    \ 008d 20....               jsr     `?L1324`
    \ 0090 aa                   tax
    \ 0091 20....               jsr     `?L1341`
    \ 0094 48                   pha
    \ 0095 da                   phx
    \ 0096 5a                   phy
    \ 0097 db                   phz
    \ 0098 a010                 ldy     #16
    \ 009a 20....               jsr     `?L1439`
    \ 009d 20....               jsr     `?L1346`
    \ 00a0 f005                 beq     `?L1033`
    \ 00a2          `?L1034`:
    \ 00a2 20....               jsr     `?L1378`
    \ 00a5 d0fb                 bne     `?L1034`
    \ 00a7          `?L1033`:
    \ 00a7 20....               jsr     `?L1420`
    \ 00aa 3002                 bmi     `?L1036`
    \ 00ac a900                 lda     #0
    \ 00ae          `?L1036`:
    \ 00ae 85..                 sta     zp:_Zp+2
    \ 00b0 85..                 sta     zp:_Zp+3
    \ 00b2 fb                   plz
    \ 00b3 7a                   ply
    \ 00b4 fa                   plx
    \ 00b5 68                   pla
    \ 00b6 20....               jsr     `?L1305`
1420                        (uint32_t) ds, DIRENTSIZE);
1421                  // dirent already full, establish an additional sector:
1422                  // @@ sector strategy needed
1423                  findnextBAMtracksector(&nexttrack, &nextsector, TRUE, dirtrack,
    \ 00b9 b1..                 lda     (_Vsp),y
    \ 00bb 85..                 sta     zp:_Zp+6
    \ 00bd 88                   dey
    \ 00be b1..                 lda     (_Vsp),y
    \ 00c0 85..                 sta     zp:_Zp+5
    \ 00c2 a006                 ldy     #6
    \ 00c4 b1..                 lda     (_Vsp),y
    \ 00c6 85..                 sta     zp:_Zp+4
    \ 00c8 a2..                 ldx     #_Zp+2
    \ 00ca a90d                 lda     #13
    \ 00cc 20....               jsr     _LoadVspEA
    \ 00cf a2..                 ldx     #_Zp
    \ 00d1 a90c                 lda     #12
    \ 00d3 20....               jsr     _LoadVspEA
    \ 00d6 a901                 lda     #1
    \ 00d8 20....               jsr     findnextBAMtracksector
1424                                         firsttrack, lasttrack);
1425                  ds->chntrack = nexttrack;
    \ 00db a00c                 ldy     #12
    \ 00dd b1..                 lda     (_Vsp),y
    \ 00df a000                 ldy     #0
    \ 00e1 91..                 sta     (_Zp+24),y
1426                  ds->chnsector = nextsector;
    \ 00e3 a00d                 ldy     #13
    \ 00e5 b1..                 lda     (_Vsp),y
    \ 00e7 a001                 ldy     #1
    \ 00e9 91..                 sta     (_Zp+24),y
1427                  // write new chain:
1428                  lcopy((uint32_t) ds, // first dirent is the new one
    \ 00eb a6..                 ldx     zp:_Zp+28
    \ 00ed 20....               jsr     `?L1296`
    \ 00f0 f005                 beq     `?L1043`
    \ 00f2          `?L1044`:
    \ 00f2 20....               jsr     `?L1350`
    \ 00f5 d0fb                 bne     `?L1044`
    \ 00f7          `?L1043`:
    \ 00f7 20....               jsr     _SpillZP
    \ 00fa 04..                 .byte   4,_Zp+4
    \ 00fc 20....               jsr     _FillQ
    \ 00ff 20....               jsr     `?L1308`
    \ 0102 20....               jsr     `?L1412`
    \ 0105 a900                 lda     #0
    \ 0107 aa                   tax
    \ 0108 20....               jsr     `?L1341`
    \ 010b 48                   pha
    \ 010c da                   phx
    \ 010d 5a                   phy
    \ 010e db                   phz
    \ 010f a010                 ldy     #16
    \ 0111 20....               jsr     `?L1439`
    \ 0114 20....               jsr     `?L1346`
    \ 0117 f005                 beq     `?L1047`
    \ 0119          `?L1048`:
    \ 0119 20....               jsr     `?L1378`
    \ 011c d0fb                 bne     `?L1048`
    \ 011e          `?L1047`:
    \ 011e 20....               jsr     `?L1420`
    \ 0121 3002                 bmi     `?L1050`
    \ 0123 a900                 lda     #0
    \ 0125          `?L1050`:
    \ 0125 85..                 sta     zp:_Zp+2
    \ 0127 85..                 sta     zp:_Zp+3
    \ 0129 fb                   plz
    \ 012a 7a                   ply
    \ 012b fa                   plx
    \ 012c 68                   pla
    \ 012d 20....               jsr     `?L1342`
    \ 0130 424285..             stq     zp:_Zp+4
    \ 0134 20....               jsr     `?L1323`
    \ 0137 20....               jsr     `?L1314`
1429                        ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + topdirent * DIRENTSIZE,
1430                        DIRENTSIZE);
1431                  // dirty, copy attic back to block buffer and save it:
1432                  lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE +
    \ 013a a6..                 ldx     zp:_Zp+28
    \ 013c 20....               jsr     `?L1296`
    \ 013f f005                 beq     `?L1054`
    \ 0141          `?L1055`:
    \ 0141 20....               jsr     `?L1350`
    \ 0144 d0fb                 bne     `?L1055`
    \ 0146          `?L1054`:
    \ 0146 20....               jsr     _SpillZP
    \ 0149 04..                 .byte   4,_Zp+4
    \ 014b 20....               jsr     _FillQ
    \ 014e 20....               jsr     `?L1338`
    \ 0151 424285..             stq     zp:_Zp
    \ 0155 20....               jsr     `?L1303`
    \ 0158 a219                 ldx     #25
    \ 015a 4b                   taz
    \ 015b 424285..             stq     zp:_Zp+4
    \ 015f a010                 ldy     #16
    \ 0161 b1..                 lda     (_Vsp),y
    \ 0163 20....               jsr     `?L1440`
    \ 0166 6b                   tza
    \ 0167 85..                 sta     zp:_Zp+9
    \ 0169 20....               jsr     `?L1355`
    \ 016c 6b                   tza
    \ 016d 85..                 sta     zp:_Zp+8
    \ 016f 4242a5..             ldq     zp:_Zp+8
    \ 0173 20....               jsr     `?L1305`
1433                        topdirent / (BLOCKSIZE / DIRENTSIZE) * BLOCKSIZE,
1434                        BLOCKDATALOW, BLOCKSIZE);
1435                  PutOneSector(legacyHDOSstate,
    \ 0176 a008                 ldy     #8
    \ 0178 b1..                 lda     (_Vsp),y
    \ 017a 85..                 sta     zp:_Zp+4
    \ 017c c8                   iny
    \ 017d b1..                 lda     (_Vsp),y
    \ 017f 20....               jsr     `?L1437`
    \ 0182 20....               jsr     `?L1344`
    \ 0185 20....               jsr     `?L1444`
1436                               (BAM *) worksectorasBAM[0], drive, track, sector);
1437                #ifdef DEBUG
1438                      mprintf("first sector set, i=", i);
1439                      cputln();
1440                      cgetc();
1441                #endif
1442
1443                  // i is already incremented after the loop, so step into next dirent block
1444                  lfill(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i * DIRENTSIZE,
    \ 0188 a6..                 ldx     zp:_Zp+28
    \ 018a 20....               jsr     `?L1296`
    \ 018d f005                 beq     `?L1061`
    \ 018f          `?L1062`:
    \ 018f 20....               jsr     `?L1350`
    \ 0192 d0fb                 bne     `?L1062`
    \ 0194          `?L1061`:
    \ 0194 20....               jsr     _SpillZP
    \ 0197 04..                 .byte   4,_Zp+4
    \ 0199 20....               jsr     _FillQ
    \ 019c 38                   sec
    \ 019d 4242e5..             sbcq    zp:_Zp
    \ 01a1 424285..             stq     zp:_Zp
    \ 01a5 20....               jsr     `?L1416`
    \ 01a8 20....               jsr     `?L1447`
    \ 01ab 20....               jsr     `?L1340`
    \ 01ae 48                   pha
    \ 01af da                   phx
    \ 01b0 5a                   phy
    \ 01b1 db                   phz
    \ 01b2 20....               jsr     `?L1345`
    \ 01b5 f005                 beq     `?L1064`
    \ 01b7          `?L1065`:
    \ 01b7 20....               jsr     `?L1378`
    \ 01ba d0fb                 bne     `?L1065`
    \ 01bc          `?L1064`:
    \ 01bc 20....               jsr     `?L1420`
    \ 01bf 3002                 bmi     `?L1067`
    \ 01c1 a900                 lda     #0
    \ 01c3          `?L1067`:
    \ 01c3 85..                 sta     zp:_Zp+2
    \ 01c5 85..                 sta     zp:_Zp+3
    \ 01c7 fb                   plz
    \ 01c8 7a                   ply
    \ 01c9 fa                   plx
    \ 01ca 68                   pla
    \ 01cb 20....               jsr     `?L1342`
    \ 01ce 424285..             stq     zp:_Zp
    \ 01d2 a900                 lda     #0
    \ 01d4 20....               jsr     lfill
1445                        0, BLOCKSIZE); // zero the whole block to fill one dirent after
1446                  newds->chntrack = 0;  // indicate end of chain
    \ 01d7 a00f                 ldy     #15
1447                  newds->chnsector = 0xff;
1448                  lcopy((uint32_t) newds, // first dirent is the new one
    \ 01d9 20....               jsr     `?L1316`
    \ 01dc a900                 lda     #0
    \ 01de a000                 ldy     #0
    \ 01e0 91..                 sta     (_Zp),y
    \ 01e2 a00f                 ldy     #15
    \ 01e4 20....               jsr     `?L1316`
    \ 01e7 e3..                 inw     zp:_Zp
    \ 01e9 a9ff                 lda     #-1
    \ 01eb a000                 ldy     #0
    \ 01ed 91..                 sta     (_Zp),y
    \ 01ef a6..                 ldx     zp:_Zp+28
    \ 01f1 86..                 stx     zp:_Zp
    \ 01f3 a900                 lda     #0
    \ 01f5 85..                 sta     zp:_Zp+1
    \ 01f7 20....               jsr     `?L1359`
    \ 01fa 20....               jsr     `?L1298`
    \ 01fd f005                 beq     `?L1070`
    \ 01ff          `?L1071`:
    \ 01ff 20....               jsr     `?L1350`
    \ 0202 d0fb                 bne     `?L1071`
    \ 0204          `?L1070`:
    \ 0204 20....               jsr     _SpillZP
    \ 0207 04..                 .byte   4,_Zp+4
    \ 0209 20....               jsr     _FillQ
    \ 020c 20....               jsr     `?L1308`
    \ 020f 20....               jsr     `?L1412`
    \ 0212 a900                 lda     #0
    \ 0214 aa                   tax
    \ 0215 20....               jsr     `?L1341`
    \ 0218 48                   pha
    \ 0219 da                   phx
    \ 021a 5a                   phy
    \ 021b db                   phz
    \ 021c 20....               jsr     `?L1345`
    \ 021f f005                 beq     `?L1074`
    \ 0221          `?L1075`:
    \ 0221 20....               jsr     `?L1378`
    \ 0224 d0fb                 bne     `?L1075`
    \ 0226          `?L1074`:
    \ 0226 20....               jsr     `?L1420`
    \ 0229 3002                 bmi     `?L1077`
    \ 022b a900                 lda     #0
    \ 022d          `?L1077`:
    \ 022d 85..                 sta     zp:_Zp+2
    \ 022f 85..                 sta     zp:_Zp+3
    \ 0231 fb                   plz
    \ 0232 7a                   ply
    \ 0233 fa                   plx
    \ 0234 68                   pla
    \ 0235 20....               jsr     `?L1342`
    \ 0238 424285..             stq     zp:_Zp+4
    \ 023c a011                 ldy     #17
    \ 023e 20....               jsr     `?L1316`
    \ 0241 20....               jsr     `?L1314`
1449                        ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i * DIRENTSIZE,
1450                        DIRENTSIZE);
1451
1452                  // dirty, copy attic back to block buffer and save it:
1453                  lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE +
    \ 0244 a6..                 ldx     zp:_Zp+28
    \ 0246 20....               jsr     `?L1296`
    \ 0249 f005                 beq     `?L1081`
    \ 024b          `?L1082`:
    \ 024b 20....               jsr     `?L1350`
    \ 024e d0fb                 bne     `?L1082`
    \ 0250          `?L1081`:
    \ 0250 20....               jsr     _SpillZP
    \ 0253 04..                 .byte   4,_Zp+4
    \ 0255 20....               jsr     _FillQ
    \ 0258 20....               jsr     `?L1338`
    \ 025b 424285..             stq     zp:_Zp
    \ 025f 20....               jsr     `?L1303`
    \ 0262 a219                 ldx     #25
    \ 0264 4b                   taz
    \ 0265 424285..             stq     zp:_Zp+4
    \ 0269 a5..                 lda     zp:_Zp+29
    \ 026b 20....               jsr     `?L1440`
    \ 026e 98                   tya
    \ 026f 85..                 sta     zp:_Zp+9
    \ 0271 20....               jsr     `?L1355`
    \ 0274 98                   tya
    \ 0275 85..                 sta     zp:_Zp+8
    \ 0277 4242a5..             ldq     zp:_Zp+8
    \ 027b 20....               jsr     `?L1305`
1454                        i / (BLOCKSIZE / DIRENTSIZE) * BLOCKSIZE,
1455                        BLOCKDATALOW, BLOCKSIZE);
1456                  PutOneSector(legacyHDOSstate,
    \ 027e a00d                 ldy     #13
    \ 0280 b1..                 lda     (_Vsp),y
    \ 0282 85..                 sta     zp:_Zp+4
    \ 0284 88                   dey
    \ 0285 b1..                 lda     (_Vsp),y
    \ 0287 4c....               jmp     `?L1278`
    \ 028a          `?L511`:
    \ 028a a6..                 ldx     zp:_Zp+28
    \ 028c 20....               jsr     `?L1296`
    \ 028f f005                 beq     `?L1088`
    \ 0291          `?L1089`:
    \ 0291 20....               jsr     `?L1350`
    \ 0294 d0fb                 bne     `?L1089`
    \ 0296          `?L1088`:
    \ 0296 20....               jsr     _SpillZP
    \ 0299 04..                 .byte   4,_Zp+4
    \ 029b 20....               jsr     _FillQ
    \ 029e 38                   sec
    \ 029f 4242e5..             sbcq    zp:_Zp
    \ 02a3 424285..             stq     zp:_Zp
    \ 02a7 a002                 ldy     #2
    \ 02a9 20....               jsr     `?L1358`
    \ 02ac 20....               jsr     `?L1310`
    \ 02af 20....               jsr     `?L1412`
    \ 02b2 20....               jsr     `?L1324`
    \ 02b5 a304                 ldz     #4
    \ 02b7 4242b2..             ldq     (_Vsp),z
    \ 02bb 20....               jsr     `?L1339`
    \ 02be 48                   pha
    \ 02bf da                   phx
    \ 02c0 5a                   phy
    \ 02c1 db                   phz
    \ 02c2 20....               jsr     `?L1345`
    \ 02c5 f005                 beq     `?L1092`
    \ 02c7          `?L1093`:
    \ 02c7 20....               jsr     `?L1378`
    \ 02ca d0fb                 bne     `?L1093`
    \ 02cc          `?L1092`:
    \ 02cc 20....               jsr     `?L1420`
    \ 02cf 3002                 bmi     `?L1095`
    \ 02d1 a900                 lda     #0
    \ 02d3          `?L1095`:
    \ 02d3 85..                 sta     zp:_Zp+2
    \ 02d5 85..                 sta     zp:_Zp+3
    \ 02d7 fb                   plz
    \ 02d8 7a                   ply
    \ 02d9 fa                   plx
    \ 02da 68                   pla
    \ 02db 20....               jsr     `?L1305`
    \ 02de a907                 lda     #7
    \ 02e0 24..                 bit     zp:_Zp+29
    \ 02e2 d011                 bne     `?L515`
    \ 02e4 a5..                 lda     zp:_Zp+29
    \ 02e6 85..                 sta     zp:_Zp
    \ 02e8 a5..                 lda     zp:_Zp+29
    \ 02ea f00e                 beq     `?L518`
    \ 02ec a00c                 ldy     #12
    \ 02ee b1..                 lda     (_Vsp),y
    \ 02f0 85..                 sta     zp:_Zp+26
    \ 02f2 c8                   iny
    \ 02f3 800c                 bra     `?L1275`
    \ 02f5 a00e     `?L515`:    ldy     #14
    \ 02f7 20....               jsr     `?L1439`
    \ 02fa a009     `?L518`:    ldy     #9
    \ 02fc b1..                 lda     (_Vsp),y
    \ 02fe 85..                 sta     zp:_Zp+26
    \ 0300 88                   dey
    \ 0301          `?L1275`:
    \ 0301 b1..                 lda     (_Vsp),y
    \ 0303 85..                 sta     zp:_Zp+27
    \ 0305 a000                 ldy     #0
    \ 0307 b1..                 lda     (_Zp+24),y
    \ 0309 f022                 beq     `?L521`
    \ 030b a908                 lda     #8
    \ 030d a00a                 ldy     #10
    \ 030f 18                   clc
    \ 0310 71..                 adc     (_Vsp),y
    \ 0312 85..                 sta     zp:_Zp+2
    \ 0314 a900                 lda     #0
    \ 0316 c8                   iny
    \ 0317 71..                 adc     (_Vsp),y
    \ 0319 85..                 sta     zp:_Zp+3
    \ 031b a000                 ldy     #0
    \ 031d b1..                 lda     (_Zp+24),y
    \ 031f a00c                 ldy     #12
    \ 0321 91..                 sta     (_Vsp),y
    \ 0323 a001                 ldy     #1
    \ 0325 b1..                 lda     (_Zp+24),y
    \ 0327 a00d                 ldy     #13
    \ 0329 91..                 sta     (_Vsp),y
    \ 032b 800a                 bra     `?L522`
    \ 032d a00a     `?L521`:    ldy     #10
    \ 032f 20....               jsr     `?L1384`
    \ 0332 c8                   iny
    \ 0333 b1..                 lda     (_Vsp),y
    \ 0335 85..                 sta     zp:_Zp+3
    \ 0337 a90f     `?L522`:    lda     #15
    \ 0339 a302                 ldz     #2
    \ 033b 32..                 and     (_Zp+24),z
    \ 033d d3be00               lbne    `?L513`
    \ 0340 a00f                 ldy     #15
    \ 0342 20....               jsr     `?L1316`
    \ 0345 a000                 ldy     #0
    \ 0347 b1..                 lda     (_Zp+24),y
    \ 0349 91..                 sta     (_Zp),y
    \ 034b a00f                 ldy     #15
    \ 034d 20....               jsr     `?L1316`
    \ 0350 e3..                 inw     zp:_Zp
    \ 0352 a001                 ldy     #1
    \ 0354 b1..                 lda     (_Zp+24),y
    \ 0356 88                   dey
    \ 0357 91..                 sta     (_Zp),y
    \ 0359 a6..                 ldx     zp:_Zp+28
    \ 035b 86..                 stx     zp:_Zp
    \ 035d 98                   tya
    \ 035e 85..                 sta     zp:_Zp+1
    \ 0360 20....               jsr     `?L1359`
    \ 0363 20....               jsr     `?L1298`
    \ 0366 f005                 beq     `?L1099`
    \ 0368          `?L1100`:
    \ 0368 20....               jsr     `?L1350`
    \ 036b d0fb                 bne     `?L1100`
    \ 036d          `?L1099`:
    \ 036d 20....               jsr     _SpillZP
    \ 0370 04..                 .byte   4,_Zp+4
    \ 0372 20....               jsr     _FillQ
    \ 0375 20....               jsr     `?L1308`
    \ 0378 20....               jsr     `?L1412`
    \ 037b a900                 lda     #0
    \ 037d aa                   tax
    \ 037e 20....               jsr     `?L1341`
    \ 0381 48                   pha
    \ 0382 da                   phx
    \ 0383 5a                   phy
    \ 0384 db                   phz
    \ 0385 20....               jsr     `?L1345`
    \ 0388 f005                 beq     `?L1103`
    \ 038a          `?L1104`:
    \ 038a 20....               jsr     `?L1378`
    \ 038d d0fb                 bne     `?L1104`
    \ 038f          `?L1103`:
    \ 038f 20....               jsr     `?L1420`
    \ 0392 3002                 bmi     `?L1106`
    \ 0394 a900                 lda     #0
    \ 0396          `?L1106`:
    \ 0396 85..                 sta     zp:_Zp+2
    \ 0398 85..                 sta     zp:_Zp+3
    \ 039a fb                   plz
    \ 039b 7a                   ply
    \ 039c fa                   plx
    \ 039d 68                   pla
    \ 039e 20....               jsr     `?L1342`
    \ 03a1 424285..             stq     zp:_Zp+4
    \ 03a5 a011                 ldy     #17
    \ 03a7 20....               jsr     `?L1316`
    \ 03aa 20....               jsr     `?L1314`
    \ 03ad a6..                 ldx     zp:_Zp+28
    \ 03af 20....               jsr     `?L1296`
    \ 03b2 f005                 beq     `?L1110`
    \ 03b4          `?L1111`:
    \ 03b4 20....               jsr     `?L1350`
    \ 03b7 d0fb                 bne     `?L1111`
    \ 03b9          `?L1110`:
    \ 03b9 20....               jsr     _SpillZP
    \ 03bc 04..                 .byte   4,_Zp+4
    \ 03be 20....               jsr     _FillQ
    \ 03c1 20....               jsr     `?L1338`
    \ 03c4 424285..             stq     zp:_Zp
    \ 03c8 20....               jsr     `?L1303`
    \ 03cb a219                 ldx     #25
    \ 03cd 4b                   taz
    \ 03ce 424285..             stq     zp:_Zp+4
    \ 03d2 a5..                 lda     zp:_Zp+29
    \ 03d4 20....               jsr     `?L1440`
    \ 03d7 98                   tya
    \ 03d8 85..                 sta     zp:_Zp+9
    \ 03da 20....               jsr     `?L1355`
    \ 03dd 98                   tya
    \ 03de 85..                 sta     zp:_Zp+8
    \ 03e0 4242a5..             ldq     zp:_Zp+8
    \ 03e4 20....               jsr     `?L1305`
    \ 03e7 a5..                 lda     zp:_Zp+27
    \ 03e9 85..                 sta     zp:_Zp+4
    \ 03eb a5..                 lda     zp:_Zp+26
    \ 03ed          `?L1278`:
    \ 03ed 20....               jsr     `?L1437`
    \ 03f0 20....               jsr     `?L1344`
    \ 03f3 20....               jsr     `?L1444`
1457                               (BAM *) worksectorasBAM[0], drive, nexttrack, nextsector);
1458                //  messagebox(0, "directory entries exhausted");
1459                }
    \ 03f6 a211                 ldx     #17
    \ 03f8 a006                 ldy     #6
    \ 03fa 4c....               jmp     _DeallocStackRestore
    \ 03fd          `?L513`:
    \ 03fd e6..                 inc     zp:_Zp+29
    \ 03ff a5..                 lda     zp:_Zp
    \ 0401 a00e                 ldy     #14
    \ 0403 91..                 sta     (_Vsp),y
    \ 0405 20....               jsr     `?L1417`
    \ 0408 a5..                 lda     zp:_Zp+26
    \ 040a a009                 ldy     #9
    \ 040c 91..                 sta     (_Vsp),y
    \ 040e a5..                 lda     zp:_Zp+27
    \ 0410 4c....               jmp     `?L1276`
1460
1461                void deletedirententry(unsigned char legacyHDOSstate,
1462                                       unsigned char drive, unsigned char side,
1463                                       unsigned char dirtrack, unsigned char entry)  {
    \ 0000                      .section code,text
    \ 0000                      .public deletedirententry
    \ 0000          deletedirententry:
    \ 0000 a2f4                 ldx     #244
    \ 0002 a008                 ldy     #8
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+28
    \ 0009 a5..                 lda     zp:_Zp
    \ 000b a007                 ldy     #7
    \ 000d 91..                 sta     (_Vsp),y
    \ 000f a5..                 lda     zp:_Zp+1
    \ 0011 a00b                 ldy     #11
    \ 0013 91..                 sta     (_Vsp),y
    \ 0015 a5..                 lda     zp:_Zp+2
    \ 0017 a008                 ldy     #8
    \ 0019 91..                 sta     (_Vsp),y
    \ 001b a5..                 lda     zp:_Zp+3
    \ 001d a000                 ldy     #0
    \ 001f 91..                 sta     (_Vsp),y
1464                  unsigned char i;
1465                  unsigned int s;
1466                  unsigned char pos;
1467                  unsigned char filetypebefore;
1468                  DIRENT* ds;
1469                  unsigned int max = ENTRIESPERBLOCK;
    \ 0021 a908                 lda     #8
    \ 0023 85..                 sta     zp:_Zp+30
    \ 0025 a900                 lda     #0
    \ 0027 85..                 sta     zp:_Zp+31
1470                  unsigned char track = dirtrack;
    \ 0029 a008                 ldy     #8
1471                  unsigned char sector = DIRENTSECT;  // @@ to be changed for sector chained by t=40, s=0
1472                  unsigned char nexttrack = 0;
1473                  unsigned char nextsector = 0;
1474
1475                  // _miniInit();
1476
1477                  ds = &readdir_dirent->direntryblock[0];
1478
1479                  // loop all entries:
1480                  for (i = 0, pos = 0; i < max; i++)  {
    \ 002b 20....               jsr     `?L1439`
    \ 002e a903                 lda     #3
    \ 0030 85..                 sta     zp:_Zp+1
    \ 0032 a900                 lda     #0
    \ 0034 85..                 sta     zp:_Zp+2
    \ 0036 85..                 sta     zp:_Zp+3
    \ 0038 20....               jsr     `?L1426`
    \ 003b 85..                 sta     zp:_Zp+26
    \ 003d a900                 lda     #0
    \ 003f 6d....               adc     readdir_dirent+1
    \ 0042 85..                 sta     zp:_Zp+27
    \ 0044 a900                 lda     #0
    \ 0046 85..                 sta     zp:_Zp+29
    \ 0048 85..                 sta     zp:_Zp+32
    \ 004a a5..                 lda     zp:_Zp
    \ 004c a002                 ldy     #2
    \ 004e 91..                 sta     (_Vsp),y
    \ 0050 a5..                 lda     zp:_Zp+1
    \ 0052 88                   dey
    \ 0053 91..                 sta     (_Vsp),y
    \ 0055 a5..                 lda     zp:_Zp+2
    \ 0057 a00a                 ldy     #10
    \ 0059 91..                 sta     (_Vsp),y
    \ 005b a5..                 lda     zp:_Zp+3
    \ 005d 88       `?L1281`:   dey
    \ 005e 91..                 sta     (_Vsp),y
    \ 0060 a5..                 lda     zp:_Zp+29
    \ 0062 c5..                 cmp     zp:_Zp+30
    \ 0064 a900                 lda     #0
    \ 0066 e5..                 sbc     zp:_Zp+31
    \ 0068 b39401               lbcs    `?L530`
1481                    // lcopy(uint32_t source_address, uint32_t destination_address, uint16_t count);
1482                    lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i * DIRENTSIZE,
    \ 006b 20....               jsr     `?L1438`
    \ 006e 20....               jsr     `?L1297`
    \ 0071 f005                 beq     `?L1118`
    \ 0073          `?L1119`:
    \ 0073 20....               jsr     `?L1350`
    \ 0076 d0fb                 bne     `?L1119`
    \ 0078 a003     `?L1118`:   ldy     #3
    \ 007a 20....               jsr     `?L1431`
    \ 007d c8                   iny
    \ 007e 20....               jsr     `?L1432`
    \ 0081 a303                 ldz     #3
    \ 0083 4242b2..             ldq     (_Vsp),z
    \ 0087 38                   sec
    \ 0088 4242e5..             sbcq    zp:_Zp
    \ 008c 424285..             stq     zp:_Zp
    \ 0090 a003                 ldy     #3
    \ 0092 20....               jsr     `?L1358`
    \ 0095 20....               jsr     `?L1310`
    \ 0098 20....               jsr     `?L1412`
    \ 009b 20....               jsr     `?L1400`
    \ 009e a305                 ldz     #5
    \ 00a0 4242b2..             ldq     (_Vsp),z
    \ 00a4 20....               jsr     `?L1339`
    \ 00a7 48                   pha
    \ 00a8 da                   phx
    \ 00a9 5a                   phy
    \ 00aa db                   phz
    \ 00ab 20....               jsr     `?L1345`
    \ 00ae f005                 beq     `?L1122`
    \ 00b0          `?L1123`:
    \ 00b0 20....               jsr     `?L1378`
    \ 00b3 d0fb                 bne     `?L1123`
    \ 00b5          `?L1122`:
    \ 00b5 20....               jsr     `?L1420`
    \ 00b8 3002                 bmi     `?L1125`
    \ 00ba a900                 lda     #0
    \ 00bc          `?L1125`:
    \ 00bc 85..                 sta     zp:_Zp+2
    \ 00be 85..                 sta     zp:_Zp+3
    \ 00c0 fb                   plz
    \ 00c1 7a                   ply
    \ 00c2 fa                   plx
    \ 00c3 68                   pla
    \ 00c4 20....               jsr     `?L1305`
1483                          (uint32_t) ds, DIRENTSIZE);
1484
1485                    // not for the first iteration:
1486                    if (i > 0 && (i % ENTRIESPERBLOCK) == 0)  {
    \ 00c7 a5..                 lda     zp:_Zp+29
    \ 00c9 f00a                 beq     `?L535`
    \ 00cb a907                 lda     #7
    \ 00cd 24..                 bit     zp:_Zp+29
    \ 00cf d004                 bne     `?L535`
1487                      track = nexttrack;
    \ 00d1 a00a                 ldy     #10
    \ 00d3 8001                 bra     `?L1282`
    \ 00d5 c8       `?L535`:    iny
    \ 00d6          `?L1282`:
    \ 00d6 b1..                 lda     (_Vsp),y
    \ 00d8 85..                 sta     zp:_Zp+24
1488                      sector = nextsector;
    \ 00da 88                   dey
    \ 00db b1..                 lda     (_Vsp),y
    \ 00dd 85..                 sta     zp:_Zp+25
1489                    }
1490                    if (ds->chntrack > 0)  {
    \ 00df a000                 ldy     #0
    \ 00e1 b1..                 lda     (_Zp+26),y
    \ 00e3 f016                 beq     `?L538`
1491                      max += ENTRIESPERBLOCK; // more attic pages
    \ 00e5 a5..                 lda     zp:_Zp+30
    \ 00e7 18                   clc
    \ 00e8 6908                 adc     #8
    \ 00ea 85..                 sta     zp:_Zp+30
    \ 00ec a5..                 lda     zp:_Zp+31
    \ 00ee 6900                 adc     #0
    \ 00f0 85..                 sta     zp:_Zp+31
1492                      nexttrack = ds->chntrack;  // chain for where to write dirent sector
    \ 00f2 b1..                 lda     (_Zp+26),y
    \ 00f4 85..                 sta     zp:_Zp+1
1493                      nextsector = ds->chnsector;
    \ 00f6 c8                   iny
    \ 00f7 b1..                 lda     (_Zp+26),y
    \ 00f9 8008                 bra     `?L1279`
    \ 00fb a00a     `?L538`:    ldy     #10
    \ 00fd 20....               jsr     `?L1317`
    \ 0100 88                   dey
    \ 0101 b1..                 lda     (_Vsp),y
    \ 0103          `?L1279`:
    \ 0103 85..                 sta     zp:_Zp
1494                    }
1495
1496                    // if a non-deleted or a SD card file (hence no mask) ?
1497                    if (ds->type != VAL_DOSFTYPE_DEL || (option.option & OPTIONshowDEL))  {
    \ 0105 a002                 ldy     #2
    \ 0107 b1..                 lda     (_Zp+26),y
    \ 0109 d006                 bne     `?L543`
    \ 010b 20....               jsr     `?L1433`
    \ 010e f33201               lbeq    `?L541`
    \ 0111          `?L543`:
1498                      if (pos == entry)  {
    \ 0111 a000                 ldy     #0
    \ 0113 b1..                 lda     (_Vsp),y
    \ 0115 c5..                 cmp     zp:_Zp+32
    \ 0117 d32701               lbne    `?L545`
1499                //        valuesbox(0, "Deleting...", "i=", i, "pos=", pos);
1500                        //                           also clear upper bits:
1501                        filetypebefore = ds->type;
    \ 011a a002                 ldy     #2
    \ 011c b1..                 lda     (_Zp+26),y
    \ 011e 85..                 sta     zp:_Zp+30
1502                        ds->type = VAL_DOSFTYPE_DEL; // + (ds->type & ~0xf);
    \ 0120 a900                 lda     #0
    \ 0122 91..                 sta     (_Zp+26),y
1503                        lcopy((uint32_t) ds, ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i * DIRENTSIZE,
    \ 0124 20....               jsr     `?L1438`
    \ 0127 20....               jsr     `?L1297`
    \ 012a f005                 beq     `?L1129`
    \ 012c          `?L1130`:
    \ 012c 20....               jsr     `?L1350`
    \ 012f d0fb                 bne     `?L1130`
    \ 0131          `?L1129`:
    \ 0131 20....               jsr     _SpillZP
    \ 0134 04..                 .byte   4,_Zp+4
    \ 0136 20....               jsr     _FillQ
    \ 0139 20....               jsr     `?L1308`
    \ 013c 20....               jsr     `?L1412`
    \ 013f a900                 lda     #0
    \ 0141 aa                   tax
    \ 0142 20....               jsr     `?L1341`
    \ 0145 48                   pha
    \ 0146 da                   phx
    \ 0147 5a                   phy
    \ 0148 db                   phz
    \ 0149 20....               jsr     `?L1345`
    \ 014c f005                 beq     `?L1133`
    \ 014e          `?L1134`:
    \ 014e 20....               jsr     `?L1378`
    \ 0151 d0fb                 bne     `?L1134`
    \ 0153          `?L1133`:
    \ 0153 20....               jsr     `?L1420`
    \ 0156 3002                 bmi     `?L1136`
    \ 0158 a900                 lda     #0
    \ 015a          `?L1136`:
    \ 015a 85..                 sta     zp:_Zp+2
    \ 015c 85..                 sta     zp:_Zp+3
    \ 015e fb                   plz
    \ 015f 7a                   ply
    \ 0160 fa                   plx
    \ 0161 68                   pla
    \ 0162 20....               jsr     `?L1342`
    \ 0165 424285..             stq     zp:_Zp+4
    \ 0169 20....               jsr     `?L1399`
    \ 016c 20....               jsr     `?L1314`
1504                              DIRENTSIZE);
1505                #ifdef DEBUG
1506                        mprintf("deletedirententry i=", i);
1507                        mprintf(" ofs=", i / (BLOCKSIZE / DIRENTSIZE) * BLOCKSIZE);
1508                        mprintf(" side=", side);
1509                        mprintf(" track=", track);
1510                        mprintf(" sector=", sector);
1511                        mprintf(" nexttrack=", nexttrack);
1512                        mprintf(" nextsector=", nextsector);
1513                        mprintf(" type=", (ds->type&0xf));
1514                        mh4printf(" ds addr=", (long) &ds);
1515                        mprintf(" filetrack=", ds->track);
1516                        mprintf(" filesector=", ds->sector);
1517                        cputln();
1518                        cgetc();
1519                #endif
1520                        lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE +
    \ 016f 20....               jsr     `?L1438`
    \ 0172 20....               jsr     `?L1297`
    \ 0175 f005                 beq     `?L1140`
    \ 0177          `?L1141`:
    \ 0177 20....               jsr     `?L1350`
    \ 017a d0fb                 bne     `?L1141`
    \ 017c          `?L1140`:
    \ 017c 20....               jsr     _SpillZP
    \ 017f 04..                 .byte   4,_Zp+4
    \ 0181 20....               jsr     _FillQ
    \ 0184 20....               jsr     `?L1338`
    \ 0187 424285..             stq     zp:_Zp
    \ 018b 20....               jsr     `?L1303`
    \ 018e a219                 ldx     #25
    \ 0190 4b                   taz
    \ 0191 424285..             stq     zp:_Zp+4
    \ 0195 a5..                 lda     zp:_Zp+29
    \ 0197 20....               jsr     `?L1440`
    \ 019a 98                   tya
    \ 019b 85..                 sta     zp:_Zp+9
    \ 019d 20....               jsr     `?L1355`
    \ 01a0 98                   tya
    \ 01a1 85..                 sta     zp:_Zp+8
    \ 01a3 4242a5..             ldq     zp:_Zp+8
    \ 01a7 20....               jsr     `?L1305`
1521                                i / (BLOCKSIZE / DIRENTSIZE) * BLOCKSIZE,
1522                              BLOCKDATALOW, BLOCKSIZE);
1523                        PutOneSector(legacyHDOSstate,
    \ 01aa a5..                 lda     zp:_Zp+25
    \ 01ac 85..                 sta     zp:_Zp+4
    \ 01ae a5..                 lda     zp:_Zp+24
    \ 01b0 20....               jsr     `?L1437`
    \ 01b3 20....               jsr     `?L1344`
    \ 01b6 a5..                 lda     zp:_Zp+28
    \ 01b8 20....               jsr     PutOneSector
1524                                     (BAM *) worksectorasBAM[0], drive, track, sector);
1525                // basepage[3] = 0xff; // @@@@ debug
1526                // basepage[4] = 0xff; // @@@@ debug
1527                        if ((filetypebefore&0xf) != VAL_DOSFTYPE_CBM)  {
    \ 01bb a90f                 lda     #15
    \ 01bd 25..                 and     zp:_Zp+30
    \ 01bf c905                 cmp     #5
    \ 01c1 f01b                 beq     `?L547`
1528                          deleteblockchain(legacyHDOSstate,
    \ 01c3 a004                 ldy     #4
    \ 01c5 b1..                 lda     (_Zp+26),y
    \ 01c7 85..                 sta     zp:_Zp+3
    \ 01c9 88                   dey
    \ 01ca b1..                 lda     (_Zp+26),y
    \ 01cc 85..                 sta     zp:_Zp+2
    \ 01ce a008                 ldy     #8
    \ 01d0 20....               jsr     `?L1317`
    \ 01d3 88                   dey
    \ 01d4 20....               jsr     `?L1439`
    \ 01d7 a5..                 lda     zp:_Zp+28
    \ 01d9 20....               jsr     deleteblockchain
    \ 01dc 8020                 bra     `?L530`
    \ 01de          `?L547`:
1529                                           drive, dirtrack, ds->track, ds->sector);
1530                        } else {
1531                          // remove 40 more sectors because the dirent track is not in size:
1532                          for (s = 0; s < (ds->size + 40); s++)  {
    \ 01de a900                 lda     #0
    \ 01e0 85..                 sta     zp:_Zp+24
    \ 01e2 85..                 sta     zp:_Zp+25
    \ 01e4 a928     `?L551`:    lda     #40
    \ 01e6 a01e                 ldy     #30
    \ 01e8 18                   clc
    \ 01e9 71..                 adc     (_Zp+26),y
    \ 01eb 85..                 sta     zp:_Zp
    \ 01ed a900                 lda     #0
    \ 01ef c8                   iny
    \ 01f0 71..                 adc     (_Zp+26),y
    \ 01f2 85..                 sta     zp:_Zp+1
    \ 01f4 a5..                 lda     zp:_Zp+24
    \ 01f6 c5..                 cmp     zp:_Zp
    \ 01f8 a5..                 lda     zp:_Zp+25
    \ 01fa e5..                 sbc     zp:_Zp+1
    \ 01fc 9007                 bcc     `?L550`
    \ 01fe          `?L530`:
1533                            BAMSectorUpdate(BAMsector[0], BAMsector[1],
1534                                            ds->track + (s / 40), ds->sector + (s % 40), 0); // 0=free up
1535                // basepage[3] = ds->track + (s / 40);  // @@@@ debug
1536                // basepage[4] = ds->sector + (s % 40); // @@@@ debug
1537                          }
1538                // basepage[5] = (ds->size + 40) % 256; // @@@@ debug
1539                // basepage[6] = (ds->size + 40) / 256; // @@@@ debug
1540                        }
1541                #ifdef DEBUG
1542                        msprintf("deletedirententry done");
1543                        cputln();
1544                        cgetc();
1545                #endif
1546                        return;
1547                      }
1548                      pos++;
1549                    }
1550
1551                #ifdef DEBUG
1552                    if (ds->track > 0)  {
1553                      mprintf("direntry ", i);
1554                      mh4printf(" is: ", (long) &ds);
1555                      memcpy(dosfilename, ds->name, DOSFILENAMELEN);
1556                      dosfilename[DOSFILENAMELEN] = 0; // proper null termination
1557                      msprintf(" name ");
1558                //        msprintf((char *) dosfilename);
1559                      mprintf(" chntrk ", ds->chntrack);
1560                      mprintf(" chnsect ", ds->chnsector);
1561                      mhprintf(" type ", ds->type&0xf);
1562                      mprintf(" trk ", ds->track);
1563                      mprintf(" sect ", ds->sector);
1564                      mprintf(" size ", ds->size);
1565                      mhprintf(" access ", ds->access);
1566                      cputln();
1567                      cgetc();
1568                    }
1569                #endif
1570                  }
1571                //  messagebox(0, "entry not found");
1572                }
    \ 01fe a20c                 ldx     #12
    \ 0200 a008                 ldy     #8
    \ 0202 4c....               jmp     _DeallocStackRestore
    \ 0205 a900     `?L550`:    lda     #0
    \ 0207 85..                 sta     zp:_Zp+5
    \ 0209 20....               jsr     `?L1323`
    \ 020c 20....               jsr     `?L1413`
    \ 020f a5..                 lda     zp:_Zp+2
    \ 0211 a304                 ldz     #4
    \ 0213 18                   clc
    \ 0214 72..                 adc     (_Zp+26),z
    \ 0216 20....               jsr     `?L1313`
    \ 0219 20....               jsr     _SpillZP
    \ 021c 02..                 .byte   2,_Zp+2
    \ 021e 20....               jsr     _SpillZP
    \ 0221 02..                 .byte   2,_Zp
    \ 0223 20....               jsr     `?L1323`
    \ 0226 20....               jsr     `?L1413`
    \ 0229 a5..                 lda     zp:_Zp
    \ 022b 3b                   dez
    \ 022c 18                   clc
    \ 022d 72..                 adc     (_Zp+26),z
    \ 022f 20....               jsr     _FillZP
    \ 0232 02..                 .byte   2,_Zp
    \ 0234 20....               jsr     _FillZP
    \ 0237 02..                 .byte   2,_Zp+2
    \ 0239 20....               jsr     BAMSectorUpdate
    \ 023c e3..                 inw     zp:_Zp+24
    \ 023e 80a4                 bra     `?L551`
    \ 0240          `?L545`:
    \ 0240 e6..                 inc     zp:_Zp+32
    \ 0242          `?L541`:
    \ 0242 a5..                 lda     zp:_Zp+32
    \ 0244 a001                 ldy     #1
    \ 0246 91..                 sta     (_Vsp),y
    \ 0248 e6..                 inc     zp:_Zp+29
    \ 024a b1..                 lda     (_Vsp),y
    \ 024c 85..                 sta     zp:_Zp+32
    \ 024e a5..                 lda     zp:_Zp+24
    \ 0250 c8                   iny
    \ 0251 91..                 sta     (_Vsp),y
    \ 0253 a5..                 lda     zp:_Zp+25
    \ 0255 88                   dey
    \ 0256 91..                 sta     (_Vsp),y
    \ 0258 a5..                 lda     zp:_Zp+1
    \ 025a a00a                 ldy     #10
    \ 025c 91..                 sta     (_Vsp),y
    \ 025e a5..                 lda     zp:_Zp
    \ 0260 4c....               jmp     `?L1281`
1573
1574                void swapdirententry(unsigned char side, unsigned int entry1,
1575                                                         unsigned int entry2)  {
    \ 0000                      .section code,text
    \ 0000                      .public swapdirententry
    \ 0000          swapdirententry:
    \ 0000 a200                 ldx     #0
    \ 0002 a011                 ldy     #17
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+36
    \ 0009 a5..                 lda     zp:_Zp
    \ 000b 85..                 sta     zp:_Zp+34
    \ 000d a5..                 lda     zp:_Zp+1
    \ 000f 85..                 sta     zp:_Zp+35
    \ 0011 20....               jsr     `?L1380`
1576                  unsigned int i1;
1577                  unsigned int i2;
1578                  unsigned int pos;
1579                  DIRENT* ds;
1580                  DIRENT* dstemp;
1581                  unsigned int max = ENTRIESPERBLOCK;
    \ 0014 a908                 lda     #8
    \ 0016 85..                 sta     zp:_Zp+26
    \ 0018 a900                 lda     #0
    \ 001a 85..                 sta     zp:_Zp+27
1582
1583                  ds = &readdir_dirent->direntryblock[0];
1584                  dstemp = &readdir_dirent->direntryblock[1];
1585
1586                  // These two loops are to search/skip non-del items until the entry 
1587                  // matches:
1588                  for (i1 = 0, pos = 0; i1 < max; i1++)  {
    \ 001c 20....               jsr     `?L1426`
    \ 001f 85..                 sta     zp:_Zp+32
    \ 0021 8a                   txa
    \ 0022 6d....               adc     readdir_dirent+1
    \ 0025 85..                 sta     zp:_Zp+33
    \ 0027 18                   clc
    \ 0028 a9e0                 lda     #224
    \ 002a 6d....               adc     readdir_dirent
    \ 002d 85..                 sta     zp:_Zp+30
    \ 002f 8a                   txa
    \ 0030 6d....               adc     readdir_dirent+1
    \ 0033 85..                 sta     zp:_Zp+31
    \ 0035 8a                   txa
    \ 0036 85..                 sta     zp:_Zp+40
    \ 0038 85..                 sta     zp:_Zp+41
    \ 003a 85..                 sta     zp:_Zp+38
    \ 003c 85..                 sta     zp:_Zp+39
    \ 003e          `?L559`:
    \ 003e a5..                 lda     zp:_Zp+26
    \ 0040 85..                 sta     zp:_Zp+28
    \ 0042 a5..                 lda     zp:_Zp+27
    \ 0044 85..                 sta     zp:_Zp+29
    \ 0046 a5..                 lda     zp:_Zp+40
    \ 0048 c5..                 cmp     zp:_Zp+26
    \ 004a a5..                 lda     zp:_Zp+41
    \ 004c e5..                 sbc     zp:_Zp+27
    \ 004e b38100               lbcs    `?L561`
1589                    // lcopy(uint32_t source_address, uint32_t destination_address, uint16_t count);
1590                    lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i1 * DIRENTSIZE,
    \ 0051 a6..                 ldx     zp:_Zp+36
    \ 0053 20....               jsr     `?L1296`
    \ 0056 f005                 beq     `?L1152`
    \ 0058          `?L1153`:
    \ 0058 20....               jsr     `?L1350`
    \ 005b d0fb                 bne     `?L1153`
    \ 005d          `?L1152`:
    \ 005d 20....               jsr     _SpillZP
    \ 0060 04..                 .byte   4,_Zp+4
    \ 0062 20....               jsr     _FillQ
    \ 0065 20....               jsr     `?L1308`
    \ 0068 20....               jsr     `?L1412`
    \ 006b a5..                 lda     zp:_Zp+33
    \ 006d 85..                 sta     zp:_Zp+5
    \ 006f a5..                 lda     zp:_Zp+32
    \ 0071 85..                 sta     zp:_Zp+4
    \ 0073 98                   tya
    \ 0074 85..                 sta     zp:_Zp+6
    \ 0076 85..                 sta     zp:_Zp+7
    \ 0078 aa                   tax
    \ 0079 20....               jsr     `?L1341`
    \ 007c 48                   pha
    \ 007d da                   phx
    \ 007e 5a                   phy
    \ 007f db                   phz
    \ 0080 a5..                 lda     zp:_Zp+40
    \ 0082 85..                 sta     zp:_Zp
    \ 0084 a5..                 lda     zp:_Zp+41
    \ 0086 20....               jsr     `?L1347`
    \ 0089 f005                 beq     `?L1156`
    \ 008b          `?L1157`:
    \ 008b 20....               jsr     `?L1378`
    \ 008e d0fb                 bne     `?L1157`
    \ 0090 a900     `?L1156`:   lda     #0
    \ 0092 85..                 sta     zp:_Zp+2
    \ 0094 85..                 sta     zp:_Zp+3
    \ 0096 fb                   plz
    \ 0097 7a                   ply
    \ 0098 fa                   plx
    \ 0099 68                   pla
    \ 009a 20....               jsr     `?L1305`
1591                          (uint32_t) ds, DIRENTSIZE);
1592
1593                    if (ds->chntrack > 0)  max += ENTRIESPERBLOCK; // more attic pages
    \ 009d 88                   dey
    \ 009e b1..                 lda     (_Zp+32),y
    \ 00a0 f00d                 beq     `?L562`
    \ 00a2 a5..                 lda     zp:_Zp+26
    \ 00a4 18                   clc
    \ 00a5 6908                 adc     #8
    \ 00a7 85..                 sta     zp:_Zp+28
    \ 00a9 a5..                 lda     zp:_Zp+27
    \ 00ab 6900                 adc     #0
    \ 00ad 8006                 bra     `?L1283`
    \ 00af          `?L562`:
    \ 00af a5..                 lda     zp:_Zp+26
    \ 00b1 85..                 sta     zp:_Zp+28
    \ 00b3 a5..                 lda     zp:_Zp+27
    \ 00b5          `?L1283`:
    \ 00b5 85..                 sta     zp:_Zp+29
1594                    // if a non-deleted or a SD card file (hence no mask) ?
1595                    if (ds->type != VAL_DOSFTYPE_DEL || (option.option & OPTIONshowDEL))  {
    \ 00b7 a002                 ldy     #2
    \ 00b9 b1..                 lda     (_Zp+32),y
    \ 00bb d006                 bne     `?L567`
    \ 00bd 20....               jsr     `?L1433`
    \ 00c0 f30f02               lbeq    `?L560`
    \ 00c3          `?L567`:
1596                      if (pos == entry1)  { // found
    \ 00c3 a5..                 lda     zp:_Zp+34
    \ 00c5 c5..                 cmp     zp:_Zp+38
    \ 00c7 d30602               lbne    `?L569`
    \ 00ca a5..                 lda     zp:_Zp+35
    \ 00cc c5..                 cmp     zp:_Zp+39
    \ 00ce d3ff01               lbne    `?L569`
    \ 00d1          `?L561`:
1597                        break;
1598                      }
1599                      pos++;
1600                    }
1601                  }
1602
1603                  for (i2 = 0, pos = 0; i2 < max; i2++)  {
    \ 00d1 a900                 lda     #0
    \ 00d3 85..                 sta     zp:_Zp+34
    \ 00d5 85..                 sta     zp:_Zp+35
    \ 00d7 85..                 sta     zp:_Zp+26
    \ 00d9 85..                 sta     zp:_Zp+27
    \ 00db          `?L573`:
    \ 00db a5..                 lda     zp:_Zp+34
    \ 00dd c5..                 cmp     zp:_Zp+28
    \ 00df a5..                 lda     zp:_Zp+35
    \ 00e1 e5..                 sbc     zp:_Zp+29
    \ 00e3 b06e                 bcs     `?L575`
1604                    // lcopy(uint32_t source_address, uint32_t destination_address, uint16_t count);
1605                    lcopy(ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i2 * DIRENTSIZE,
    \ 00e5 a6..                 ldx     zp:_Zp+36
    \ 00e7 20....               jsr     `?L1296`
    \ 00ea f005                 beq     `?L1162`
    \ 00ec          `?L1163`:
    \ 00ec 20....               jsr     `?L1350`
    \ 00ef d0fb                 bne     `?L1163`
    \ 00f1          `?L1162`:
    \ 00f1 20....               jsr     _SpillZP
    \ 00f4 04..                 .byte   4,_Zp+4
    \ 00f6 20....               jsr     _FillQ
    \ 00f9 20....               jsr     `?L1308`
    \ 00fc 20....               jsr     `?L1412`
    \ 00ff a5..                 lda     zp:_Zp+33
    \ 0101 85..                 sta     zp:_Zp+5
    \ 0103 a5..                 lda     zp:_Zp+32
    \ 0105 85..                 sta     zp:_Zp+4
    \ 0107 98                   tya
    \ 0108 85..                 sta     zp:_Zp+6
    \ 010a 85..                 sta     zp:_Zp+7
    \ 010c aa                   tax
    \ 010d 20....               jsr     `?L1341`
    \ 0110 48                   pha
    \ 0111 da                   phx
    \ 0112 5a                   phy
    \ 0113 db                   phz
    \ 0114 a5..                 lda     zp:_Zp+34
    \ 0116 85..                 sta     zp:_Zp
    \ 0118 a5..                 lda     zp:_Zp+35
    \ 011a 20....               jsr     `?L1347`
    \ 011d f005                 beq     `?L1166`
    \ 011f          `?L1167`:
    \ 011f 20....               jsr     `?L1378`
    \ 0122 d0fb                 bne     `?L1167`
    \ 0124 a900     `?L1166`:   lda     #0
    \ 0126 85..                 sta     zp:_Zp+2
    \ 0128 85..                 sta     zp:_Zp+3
    \ 012a fb                   plz
    \ 012b 7a                   ply
    \ 012c fa                   plx
    \ 012d 68                   pla
    \ 012e 20....               jsr     `?L1305`
1606                          (uint32_t) ds, DIRENTSIZE);
1607
1608                    if (ds->chntrack > 0)  max += ENTRIESPERBLOCK; // more attic pages
    \ 0131 88                   dey
    \ 0132 b1..                 lda     (_Zp+32),y
    \ 0134 f003                 beq     `?L577`
    \ 0136 20....               jsr     `?L1401`
    \ 0139          `?L577`:
1609                    // if a non-deleted or a SD card file (hence no mask) ?
1610                    if (ds->type != VAL_DOSFTYPE_DEL || (option.option & OPTIONshowDEL))  {
    \ 0139 a002                 ldy     #2
    \ 013b b1..                 lda     (_Zp+32),y
    \ 013d d006                 bne     `?L581`
    \ 013f 20....               jsr     `?L1433`
    \ 0142 f38601               lbeq    `?L574`
    \ 0145          `?L581`:
1611                      if (pos == entry2)  { // found
    \ 0145 a5..                 lda     zp:_Zp+24
    \ 0147 c5..                 cmp     zp:_Zp+26
    \ 0149 d37d01               lbne    `?L583`
    \ 014c a5..                 lda     zp:_Zp+25
    \ 014e c5..                 cmp     zp:_Zp+27
    \ 0150 d37601               lbne    `?L583`
    \ 0153          `?L575`:
1612                        break;
1613                      }
1614                      pos++;
1615                    }
1616                  }
1617
1618                  // Temporarily dump first dirent into data block not in use. From v0.6.6
1619                  // this is leaving the first two bytes alone which are the blockchain:
1620                  lcopy((ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i1 * DIRENTSIZE) + 2,
    \ 0153 a6..                 ldx     zp:_Zp+36
    \ 0155 20....               jsr     `?L1296`
    \ 0158 f005                 beq     `?L1172`
    \ 015a          `?L1173`:
    \ 015a 20....               jsr     `?L1350`
    \ 015d d0fb                 bne     `?L1173`
    \ 015f          `?L1172`:
    \ 015f 20....               jsr     _SpillZP
    \ 0162 04..                 .byte   4,_Zp+4
    \ 0164 20....               jsr     _FillQ
    \ 0167 20....               jsr     `?L1308`
    \ 016a a91e                 lda     #30
    \ 016c 91..                 sta     (_Vsp),y
    \ 016e a5..                 lda     zp:_Zp+31
    \ 0170 85..                 sta     zp:_Zp+5
    \ 0172 a5..                 lda     zp:_Zp+30
    \ 0174 85..                 sta     zp:_Zp+4
    \ 0176 98                   tya
    \ 0177 85..                 sta     zp:_Zp+6
    \ 0179 85..                 sta     zp:_Zp+7
    \ 017b aa                   tax
    \ 017c 20....               jsr     `?L1341`
    \ 017f 48                   pha
    \ 0180 da                   phx
    \ 0181 5a                   phy
    \ 0182 db                   phz
    \ 0183 a5..                 lda     zp:_Zp+40
    \ 0185 85..                 sta     zp:_Zp
    \ 0187 a5..                 lda     zp:_Zp+41
    \ 0189 20....               jsr     `?L1347`
    \ 018c f005                 beq     `?L1176`
    \ 018e          `?L1177`:
    \ 018e 20....               jsr     `?L1378`
    \ 0191 d0fb                 bne     `?L1177`
    \ 0193 a900     `?L1176`:   lda     #0
    \ 0195 85..                 sta     zp:_Zp+2
    \ 0197 85..                 sta     zp:_Zp+3
    \ 0199 fb                   plz
    \ 019a 7a                   ply
    \ 019b fa                   plx
    \ 019c 68                   pla
    \ 019d 20....               jsr     `?L1342`
    \ 01a0 42421a               inq     q
    \ 01a3 42421a               inq     q
    \ 01a6 424285..             stq     zp:_Zp
    \ 01aa 20....               jsr     lcopy
    \ 01ad a001                 ldy     #1
    \ 01af 20....               jsr     _IncVsp
1621                        (uint32_t) dstemp, DIRENTSIZE - 2);
1622                  // Copy second one in first:
1623                  lcopy((ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i2 * DIRENTSIZE) + 2,
    \ 01b2 a6..                 ldx     zp:_Zp+36
    \ 01b4 20....               jsr     `?L1296`
    \ 01b7 f005                 beq     `?L1181`
    \ 01b9          `?L1182`:
    \ 01b9 20....               jsr     `?L1350`
    \ 01bc d0fb                 bne     `?L1182`
    \ 01be          `?L1181`:
    \ 01be a6..                 ldx     zp:_Zp+36
    \ 01c0 20....               jsr     `?L1441`
    \ 01c3 20....               jsr     `?L1355`
    \ 01c6 20....               jsr     `?L1388`
    \ 01c9 f007                 beq     `?L1184`
    \ 01cb          `?L1185`:
    \ 01cb 424206..             aslq    zp:_Zp+12
    \ 01cf ca                   dex
    \ 01d0 d0f9                 bne     `?L1185`
    \ 01d2          `?L1184`:
    \ 01d2 20....               jsr     _SpillZP
    \ 01d5 04..                 .byte   4,_Zp+4
    \ 01d7 20....               jsr     _FillQ
    \ 01da 38                   sec
    \ 01db 4242e5..             sbcq    zp:_Zp
    \ 01df 424285..             stq     zp:_Zp+16
    \ 01e3 20....               jsr     _SpillZP
    \ 01e6 04..                 .byte   4,_Zp+12
    \ 01e8 20....               jsr     _FillQ
    \ 01eb 38                   sec
    \ 01ec 4242e5..             sbcq    zp:_Zp+8
    \ 01f0 20....               jsr     `?L1309`
    \ 01f3 a91e                 lda     #30
    \ 01f5 91..                 sta     (_Vsp),y
    \ 01f7 a900                 lda     #0
    \ 01f9 aa                   tax
    \ 01fa 20....               jsr     `?L1341`
    \ 01fd 48                   pha
    \ 01fe da                   phx
    \ 01ff 5a                   phy
    \ 0200 db                   phz
    \ 0201 a905                 lda     #5
    \ 0203 aa                   tax
    \ 0204 f006                 beq     `?L1188`
    \ 0206          `?L1189`:
    \ 0206 cb....               asw     _Zp+40
    \ 0209 ca                   dex
    \ 020a d0fa                 bne     `?L1189`
    \ 020c          `?L1188`:
    \ 020c a5..                 lda     zp:_Zp+41
    \ 020e 85..                 sta     zp:_Zp+1
    \ 0210 a5..                 lda     zp:_Zp+40
    \ 0212 85..                 sta     zp:_Zp
    \ 0214 a900                 lda     #0
    \ 0216 85..                 sta     zp:_Zp+2
    \ 0218 85..                 sta     zp:_Zp+3
    \ 021a fb                   plz
    \ 021b 7a                   ply
    \ 021c fa                   plx
    \ 021d 68                   pla
    \ 021e 20....               jsr     `?L1342`
    \ 0221 42421a               inq     q
    \ 0224 42421a               inq     q
    \ 0227 424285..             stq     zp:_Zp+4
    \ 022b a900                 lda     #0
    \ 022d aa                   tax
    \ 022e a8                   tay
    \ 022f a308                 ldz     #8
    \ 0231 18                   clc
    \ 0232 424265..             adcq    zp:_Zp+16
    \ 0236 48                   pha
    \ 0237 da                   phx
    \ 0238 5a                   phy
    \ 0239 db                   phz
    \ 023a a5..                 lda     zp:_Zp+34
    \ 023c 85..                 sta     zp:_Zp
    \ 023e a5..                 lda     zp:_Zp+35
    \ 0240 20....               jsr     `?L1347`
    \ 0243 f005                 beq     `?L1191`
    \ 0245          `?L1192`:
    \ 0245 20....               jsr     `?L1378`
    \ 0248 d0fb                 bne     `?L1192`
    \ 024a a900     `?L1191`:   lda     #0
    \ 024c 85..                 sta     zp:_Zp+2
    \ 024e 85..                 sta     zp:_Zp+3
    \ 0250 fb                   plz
    \ 0251 7a                   ply
    \ 0252 fa                   plx
    \ 0253 68                   pla
    \ 0254 20....               jsr     `?L1342`
    \ 0257 42421a               inq     q
    \ 025a 42421a               inq     q
    \ 025d 424285..             stq     zp:_Zp
    \ 0261 20....               jsr     lcopy
    \ 0264 a001                 ldy     #1
    \ 0266 20....               jsr     _IncVsp
1624                        (ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i1 * DIRENTSIZE) + 2,
1625                        DIRENTSIZE - 2);
1626                  // Now temporary in second:
1627                  lcopy((uint32_t) dstemp,
    \ 0269 a6..                 ldx     zp:_Zp+36
    \ 026b 20....               jsr     `?L1296`
    \ 026e f005                 beq     `?L1196`
    \ 0270          `?L1197`:
    \ 0270 20....               jsr     `?L1350`
    \ 0273 d0fb                 bne     `?L1197`
    \ 0275          `?L1196`:
    \ 0275 20....               jsr     _SpillZP
    \ 0278 04..                 .byte   4,_Zp+4
    \ 027a 20....               jsr     _FillQ
    \ 027d 20....               jsr     `?L1308`
    \ 0280 a91e                 lda     #30
    \ 0282 91..                 sta     (_Vsp),y
    \ 0284 a900                 lda     #0
    \ 0286 aa                   tax
    \ 0287 20....               jsr     `?L1341`
    \ 028a 48                   pha
    \ 028b da                   phx
    \ 028c 5a                   phy
    \ 028d db                   phz
    \ 028e a905                 lda     #5
    \ 0290 aa                   tax
    \ 0291 f006                 beq     `?L1200`
    \ 0293          `?L1201`:
    \ 0293 cb....               asw     _Zp+34
    \ 0296 ca                   dex
    \ 0297 d0fa                 bne     `?L1201`
    \ 0299          `?L1200`:
    \ 0299 a5..                 lda     zp:_Zp+35
    \ 029b 85..                 sta     zp:_Zp+1
    \ 029d a5..                 lda     zp:_Zp+34
    \ 029f 85..                 sta     zp:_Zp
    \ 02a1 a900                 lda     #0
    \ 02a3 85..                 sta     zp:_Zp+2
    \ 02a5 85..                 sta     zp:_Zp+3
    \ 02a7 fb                   plz
    \ 02a8 7a                   ply
    \ 02a9 fa                   plx
    \ 02aa 68                   pla
    \ 02ab 20....               jsr     `?L1342`
    \ 02ae 42421a               inq     q
    \ 02b1 42421a               inq     q
    \ 02b4 424285..             stq     zp:_Zp+4
    \ 02b8 a5..                 lda     zp:_Zp+30
    \ 02ba 85..                 sta     zp:_Zp
    \ 02bc a5..                 lda     zp:_Zp+31
    \ 02be 85..                 sta     zp:_Zp+1
    \ 02c0 20....               jsr     `?L1314`
1628                        (ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE + i2 * DIRENTSIZE) + 2,
1629                        DIRENTSIZE - 2);
1630
1631                //  cgetc();
1632                }
    \ 02c3 a011                 ldy     #17
    \ 02c5 4c....               jmp     _RestoreRegisters
    \ 02c8          `?L583`:
    \ 02c8 e3..                 inw     zp:_Zp+26
    \ 02ca          `?L574`:
    \ 02ca e3..                 inw     zp:_Zp+34
    \ 02cc 4c....               jmp     `?L573`
    \ 02cf          `?L569`:
    \ 02cf e3..                 inw     zp:_Zp+38
    \ 02d1          `?L560`:
    \ 02d1 e3..                 inw     zp:_Zp+40
    \ 02d3 a5..                 lda     zp:_Zp+28
    \ 02d5 85..                 sta     zp:_Zp+26
    \ 02d7 a5..                 lda     zp:_Zp+29
    \ 02d9 85..                 sta     zp:_Zp+27
    \ 02db 4c....               jmp     `?L559`
1633
1634                // @@@@ this deletes all dirents and completely saves them back as new,
1635                // @@@@ thus should be changed at some point:
1636                void rewritedirent(unsigned char legacyHDOSstate,
1637                                   unsigned char drive, unsigned char side,
1638                                   unsigned char dirtrack,
1639                                   unsigned char firsttrack, unsigned char lasttrack)  {
    \ 0000                      .section code,text
    \ 0000                      .public rewritedirent
    \ 0000          rewritedirent:
    \ 0000 a2fe                 ldx     #254
    \ 0002 a005                 ldy     #5
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+29
    \ 0009 a5..                 lda     zp:_Zp
    \ 000b 85..                 sta     zp:_Zp+28
    \ 000d a5..                 lda     zp:_Zp+1
    \ 000f 85..                 sta     zp:_Zp+27
    \ 0011 a5..                 lda     zp:_Zp+2
    \ 0013 85..                 sta     zp:_Zp+26
    \ 0015 a5..                 lda     zp:_Zp+3
    \ 0017 85..                 sta     zp:_Zp+25
    \ 0019 a5..                 lda     zp:_Zp+4
    \ 001b 85..                 sta     zp:_Zp+24
1640                  unsigned char starttrack;
1641                  unsigned char startsector;
1642
1643                  if (deleteblockchain(legacyHDOSstate, drive, dirtrack,
1644                                       dirtrack, DIRENTSECT))  {
    \ 001d a903                 lda     #3
    \ 001f 85..                 sta     zp:_Zp+3
    \ 0021 a5..                 lda     zp:_Zp+26
    \ 0023 85..                 sta     zp:_Zp+2
    \ 0025 a5..                 lda     zp:_Zp+26
    \ 0027 85..                 sta     zp:_Zp+1
    \ 0029 a5..                 lda     zp:_Zp+28
    \ 002b 85..                 sta     zp:_Zp
    \ 002d a5..                 lda     zp:_Zp+29
    \ 002f 20....               jsr     deleteblockchain
    \ 0032 aa                   tax
    \ 0033 f025                 beq     `?L589`
1645                    messagebox(MBOXNOCANCEL, "Updating directory,",
    \ 0035 20....               jsr     `?L1418`
    \ 0038 20....               jsr     `?L1312`
    \ 003b 91..                 sta     (_Vsp),y
    \ 003d 88                   dey
    \ 003e 91..                 sta     (_Vsp),y
    \ 0040 20....               jsr     `?L1379`
    \ 0043 a9..                 lda     #.byte0 `_StringLiteral_fatal error`
    \ 0045 85..                 sta     zp:_Zp+2
    \ 0047 a9..                 lda     #.byte1 `_StringLiteral_fatal error`
    \ 0049 85..                 sta     zp:_Zp+3
    \ 004b a9..                 lda     #.byte0 `_StringLiteral_Updating directory,`
    \ 004d 85..                 sta     zp:_Zp
    \ 004f a9..                 lda     #.byte1 `_StringLiteral_Updating directory,`
    \ 0051 85..                 sta     zp:_Zp+1
    \ 0053 a904                 lda     #4
    \ 0055 20....               jsr     `?L1391`
    \ 0058 8069                 bra     `?L588`
    \ 005a          `?L589`:
1646                               "fatal error",
1647                               " ", 0);
1648                  } else {
1649                    writeblockchain(legacyHDOSstate,
    \ 005a a6..                 ldx     zp:_Zp+27
    \ 005c 20....               jsr     `?L1296`
    \ 005f f005                 beq     `?L1223`
    \ 0061          `?L1224`:
    \ 0061 20....               jsr     `?L1350`
    \ 0064 d0fb                 bne     `?L1224`
    \ 0066          `?L1223`:
    \ 0066 20....               jsr     _SpillZP
    \ 0069 04..                 .byte   4,_Zp+4
    \ 006b 20....               jsr     _FillQ
    \ 006e 38                   sec
    \ 006f 4242e5..             sbcq    zp:_Zp
    \ 0073 424285..             stq     zp:_Zp
    \ 0077 a9f9                 lda     #-7
    \ 0079 20....               jsr     _DecVsp
    \ 007c a5..                 lda     zp:_Zp+24
    \ 007e a006                 ldy     #6
    \ 0080 91..                 sta     (_Vsp),y
    \ 0082 a5..                 lda     zp:_Zp+25
    \ 0084 88                   dey
    \ 0085 91..                 sta     (_Vsp),y
    \ 0087 a901                 lda     #1
    \ 0089 88                   dey
    \ 008a 91..                 sta     (_Vsp),y
    \ 008c a2..                 ldx     #_Zp+4
    \ 008e a908                 lda     #8
    \ 0090 20....               jsr     `?L1397`
    \ 0093 a907                 lda     #7
    \ 0095 20....               jsr     `?L1397`
    \ 0098 a5..                 lda     zp:_Zp+26
    \ 009a 85..                 sta     zp:_Zp+7
    \ 009c a5..                 lda     zp:_Zp+28
    \ 009e 85..                 sta     zp:_Zp+6
    \ 00a0 a91f                 lda     #31
    \ 00a2 85..                 sta     zp:_Zp+4
    \ 00a4 a900                 lda     #0
    \ 00a6 85..                 sta     zp:_Zp+5
    \ 00a8 a200                 ldx     #0
    \ 00aa 20....               jsr     `?L1341`
    \ 00ad 424285..             stq     zp:_Zp
    \ 00b1 a5..                 lda     zp:_Zp+29
    \ 00b3 20....               jsr     writeblockchain
    \ 00b6 a006                 ldy     #6
    \ 00b8 20....               jsr     _IncVsp
1650                                    ATTICDIRENTBUFFER + side * ATTICDIRENTSIZE,
1651                                    DIRENTBLOCKS, drive,
1652                                    &starttrack, &startsector,
1653                                    dirtrack, TRUE, firsttrack, lasttrack);
1654                    PutBAM(legacyHDOSstate, drive, side, dirtrack);
    \ 00bb a5..                 lda     zp:_Zp+26
    \ 00bd 20....               jsr     `?L1343`
    \ 00c0 20....               jsr     PutBAM
    \ 00c3          `?L588`:
1655                  }
1656                }
    \ 00c3 a202                 ldx     #2
    \ 00c5 a005                 ldy     #5
    \ 00c7 4c....               jmp     _DeallocStackRestore
1657
1658                void renamedisk(unsigned char legacyHDOSstate,
1659                                unsigned char drive, unsigned char side,
1660                                unsigned char dirtrack,
1661                                char* name)  {
    \ 0000                      .section code,text
    \ 0000                      .public renamedisk
    \ 0000 a200     renamedisk: ldx     #0
    \ 0002 20....               jsr     `?L1434`
    \ 0005 85..                 sta     zp:_Zp+29
    \ 0007 a5..                 lda     zp:_Zp+2
    \ 0009 85..                 sta     zp:_Zp+28
    \ 000b a5..                 lda     zp:_Zp+4
    \ 000d 85..                 sta     zp:_Zp+26
    \ 000f a5..                 lda     zp:_Zp+5
    \ 0011 85..                 sta     zp:_Zp+27
1662                  HEADER* hs;
1663                  hs = (HEADER *) worksector[0]; // misuse data sector
1664
1665                  if (GetOneSector(legacyHDOSstate,
1666                                   (BAM *) hs, drive, dirtrack, HEADERSECT) < 2)  {
    \ 0013 20....               jsr     `?L1381`
    \ 0016 8a                   txa
    \ 0017 85..                 sta     zp:_Zp+4
    \ 0019 a5..                 lda     zp:_Zp+28
    \ 001b 85..                 sta     zp:_Zp+3
    \ 001d a5..                 lda     zp:_Zp+29
    \ 001f 85..                 sta     zp:_Zp+2
    \ 0021 20....               jsr     `?L1323`
    \ 0024 a5..                 lda     zp:_Zp+30
    \ 0026 20....               jsr     GetOneSector
    \ 0029 c902                 cmp     #2
    \ 002b b040                 bcs     `?L595`
1667                    strcopy(name, (char *) hs->diskname, 16);
    \ 002d a5..                 lda     zp:_Zp+24
    \ 002f 85..                 sta     zp:_Zp+2
    \ 0031 a5..                 lda     zp:_Zp+25
    \ 0033 20....               jsr     `?L1425`
    \ 0036 20....               jsr     `?L1399`
    \ 0039 a910                 lda     #16
    \ 003b 20....               jsr     strcopy
1668                    if (PutOneSector(legacyHDOSstate,
1669                                     (BAM *) hs, drive, dirtrack, HEADERSECT) > 2)  {
    \ 003e 20....               jsr     `?L1416`
    \ 0041 a5..                 lda     zp:_Zp+28
    \ 0043 85..                 sta     zp:_Zp+3
    \ 0045 a5..                 lda     zp:_Zp+29
    \ 0047 85..                 sta     zp:_Zp+2
    \ 0049 20....               jsr     `?L1323`
    \ 004c 20....               jsr     `?L1444`
    \ 004f 85..                 sta     zp:_Zp
    \ 0051 a302                 ldz     #2
    \ 0053 d4..                 cpz     zp:_Zp
    \ 0055 b039                 bcs     `?L594`
1670                      messagebox(MBOXNOCANCEL, "Renaming subpartition,",
    \ 0057 20....               jsr     `?L1418`
    \ 005a 20....               jsr     `?L1312`
    \ 005d 91..                 sta     (_Vsp),y
    \ 005f 88                   dey
    \ 0060 91..                 sta     (_Vsp),y
    \ 0062 20....               jsr     `?L1379`
    \ 0065 a9..                 lda     #.byte0 `_StringLiteral_write error`
    \ 0067 85..                 sta     zp:_Zp+2
    \ 0069 a9..                 lda     #.byte1 `_StringLiteral_write error`
    \ 006b 8014                 bra     `?L1286`
    \ 006d          `?L595`:
1671                                 "write error",
1672                                 " ", 0);
1673                    }
1674                  } else {
1675                    messagebox(MBOXNOCANCEL, "Renaming subpartition,",
    \ 006d 20....               jsr     `?L1418`
    \ 0070 20....               jsr     `?L1312`
    \ 0073 91..                 sta     (_Vsp),y
    \ 0075 88                   dey
    \ 0076 91..                 sta     (_Vsp),y
    \ 0078 20....               jsr     `?L1379`
    \ 007b a9..                 lda     #.byte0 `_StringLiteral_read error`
    \ 007d 85..                 sta     zp:_Zp+2
    \ 007f a9..                 lda     #.byte1 `_StringLiteral_read error`
    \ 0081          `?L1286`:
    \ 0081 85..                 sta     zp:_Zp+3
    \ 0083 a9..                 lda     #.byte0 `_StringLiteral_Renaming subpartition,`
    \ 0085 85..                 sta     zp:_Zp
    \ 0087 a9..                 lda     #.byte1 `_StringLiteral_Renaming subpartition,`
    \ 0089 85..                 sta     zp:_Zp+1
    \ 008b a904                 lda     #4
    \ 008d 20....               jsr     `?L1391`
    \ 0090          `?L594`:
1676                               "read error",
1677                               " ", 0);
1678                  }
1679                }
    \ 0090 a006                 ldy     #6
    \ 0092 4c....               jmp     _RestoreRegisters
    \ 0000                      .section code,text
    \ 0000          `?L1295`:
    \ 0000 a6..                 ldx     zp:_Zp+8
    \ 0002 86..                 stx     zp:_Zp+6
    \ 0004 a900                 lda     #0
    \ 0006 85..                 sta     zp:_Zp+7
    \ 0008 cb....               asw     _Zp+6
    \ 000b a5..                 lda     zp:_Zp+6
    \ 000d 85..                 sta     zp:_Zp
    \ 000f cb....               asw     _Zp+6
    \ 0012 a5..                 lda     zp:_Zp+6
    \ 0014 18                   clc
    \ 0015 65..                 adc     zp:_Zp
    \ 0017 85..                 sta     zp:_Zp
    \ 0019 a5..                 lda     zp:_Zp+2
    \ 001b 18                   clc
    \ 001c 6910                 adc     #16
    \ 001e 85..                 sta     zp:_Zp+6
    \ 0020 a5..                 lda     zp:_Zp+3
    \ 0022 6900                 adc     #0
    \ 0024 85..                 sta     zp:_Zp+7
    \ 0026 18                   clc
    \ 0027 a5..                 lda     zp:_Zp+6
    \ 0029 65..                 adc     zp:_Zp
    \ 002b 85..                 sta     zp:_Zp+6
    \ 002d 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1296`:
    \ 0000 86..                 stx     zp:_Zp
    \ 0002 a900     `?L1297`:   lda     #0
    \ 0004 85..                 sta     zp:_Zp+1
    \ 0006 85..                 sta     zp:_Zp+3
    \ 0008 a5..                 lda     zp:_Zp+1
    \ 000a 85..                 sta     zp:_Zp+2
    \ 000c a5..                 lda     zp:_Zp
    \ 000e 85..                 sta     zp:_Zp+1
    \ 0010 a900                 lda     #0
    \ 0012          `?L1298`:
    \ 0012 85..                 sta     zp:_Zp
    \ 0014 4242a5..             ldq     zp:_Zp
    \ 0018 424285..             stq     zp:_Zp+4
    \ 001c a905                 lda     #5
    \ 001e aa                   tax
    \ 001f 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1299`:
    \ 0000 91..                 sta     (_Zp),y
    \ 0002 a5..                 lda     zp:_Zp+4
    \ 0004 85..                 sta     zp:_Zp
    \ 0006 a5..                 lda     zp:_Zp+5
    \ 0008 85..                 sta     zp:_Zp+1
    \ 000a e3..                 inw     zp:_Zp+4
    \ 000c a5..                 lda     zp:_Zp
    \ 000e 18                   clc
    \ 000f 69..                 adc     #.byte0 s
    \ 0011 85..                 sta     zp:_Zp
    \ 0013 a5..                 lda     zp:_Zp+1
    \ 0015 69..                 adc     #.byte1 s
    \ 0017 85..                 sta     zp:_Zp+1
    \ 0019 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1300`:
    \ 0000 a6..                 ldx     zp:_Zp+4
    \ 0002 86..                 stx     zp:_Zp+2
    \ 0004 a900                 lda     #0
    \ 0006          `?L1301`:
    \ 0006 85..                 sta     zp:_Zp+3
    \ 0008 cb....               asw     _Zp+2
    \ 000b a5..                 lda     zp:_Zp+2
    \ 000d 85..                 sta     zp:_Zp
    \ 000f cb....               asw     _Zp+2
    \ 0012 a5..                 lda     zp:_Zp+2
    \ 0014 18                   clc
    \ 0015 65..                 adc     zp:_Zp
    \ 0017 85..                 sta     zp:_Zp
    \ 0019 a5..                 lda     zp:_Zp+24
    \ 001b 18                   clc
    \ 001c 6910                 adc     #16
    \ 001e 85..                 sta     zp:_Zp+2
    \ 0020 a5..                 lda     zp:_Zp+25
    \ 0022 6900                 adc     #0
    \ 0024 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1302`:
    \ 0000 a6..                 ldx     zp:_Zp+1
    \ 0002 86..                 stx     zp:_Zp+4
    \ 0004 a900                 lda     #0
    \ 0006 85..                 sta     zp:_Zp+5
    \ 0008 cb....               asw     _Zp+4
    \ 000b a5..                 lda     zp:_Zp+4
    \ 000d 85..                 sta     zp:_Zp+2
    \ 000f cb....               asw     _Zp+4
    \ 0012 a5..                 lda     zp:_Zp+4
    \ 0014 18                   clc
    \ 0015 65..                 adc     zp:_Zp+2
    \ 0017 85..                 sta     zp:_Zp+2
    \ 0019 a5..                 lda     zp:_Zp+8
    \ 001b 18                   clc
    \ 001c 6910                 adc     #16
    \ 001e 85..                 sta     zp:_Zp+4
    \ 0020 a5..                 lda     zp:_Zp+9
    \ 0022 6900                 adc     #0
    \ 0024 85..                 sta     zp:_Zp+5
    \ 0026 a5..                 lda     zp:_Zp+2
    \ 0028 85..                 sta     zp:_Zp+1
    \ 002a 18                   clc
    \ 002b a5..                 lda     zp:_Zp+4
    \ 002d 65..                 adc     zp:_Zp+1
    \ 002f 85..                 sta     zp:_Zp+4
    \ 0031 60                   rts
    \ 0000                      .section code,text
    \ 0000 a9fe     `?L1303`:   lda     #-2
    \ 0002 20....               jsr     _DecVsp
    \ 0005 a001                 ldy     #1
    \ 0007 a901                 lda     #1
    \ 0009 91..                 sta     (_Vsp),y
    \ 000b 88                   dey
    \ 000c a900                 lda     #0
    \ 000e 91..                 sta     (_Vsp),y
    \ 0010 60                   rts
    \ 0000                      .section code,text
    \ 0000 18       `?L1305`:   clc
    \ 0001 424265..             adcq    zp:_Zp
    \ 0005 424285..             stq     zp:_Zp
    \ 0009 20....               jsr     lcopy
    \ 000c a001                 ldy     #1
    \ 000e 4c....               jmp     _IncVsp
    \ 0000                      .section code,text
    \ 0000          `?L1307`:
    \ 0000 a6..                 ldx     zp:_Zp+9
    \ 0002 86..                 stx     zp:_Zp+2
    \ 0004 a900                 lda     #0
    \ 0006 85..                 sta     zp:_Zp+3
    \ 0008 cb....               asw     _Zp+2
    \ 000b a5..                 lda     zp:_Zp+2
    \ 000d 85..                 sta     zp:_Zp
    \ 000f cb....               asw     _Zp+2
    \ 0012 a5..                 lda     zp:_Zp+2
    \ 0014 18                   clc
    \ 0015 65..                 adc     zp:_Zp
    \ 0017 85..                 sta     zp:_Zp
    \ 0019 a5..                 lda     zp:_Zp+14
    \ 001b 18                   clc
    \ 001c 6910                 adc     #16
    \ 001e 85..                 sta     zp:_Zp+2
    \ 0020 a5..                 lda     zp:_Zp+15
    \ 0022 6900                 adc     #0
    \ 0024 85..                 sta     zp:_Zp+3
    \ 0026 18                   clc
    \ 0027 a5..                 lda     zp:_Zp+2
    \ 0029 65..                 adc     zp:_Zp
    \ 002b 85..                 sta     zp:_Zp+2
    \ 002d 60                   rts
    \ 0000                      .section code,text
    \ 0000 38       `?L1308`:   sec
    \ 0001 4242e5..             sbcq    zp:_Zp
    \ 0005          `?L1309`:
    \ 0005 424285..             stq     zp:_Zp
    \ 0009 a9fe     `?L1310`:   lda     #-2
    \ 000b 20....               jsr     _DecVsp
    \ 000e a001                 ldy     #1
    \ 0010 a900     `?L1312`:   lda     #0
    \ 0012 91..                 sta     (_Vsp),y
    \ 0014 88                   dey
    \ 0015 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1313`:
    \ 0000 85..                 sta     zp:_Zp+4
    \ 0002 ad....               lda     BAMsector+2
    \ 0005 85..                 sta     zp:_Zp+2
    \ 0007 ad....               lda     BAMsector+3
    \ 000a 85..                 sta     zp:_Zp+3
    \ 000c ad....               lda     BAMsector
    \ 000f 85..                 sta     zp:_Zp
    \ 0011 ad....               lda     BAMsector+1
    \ 0014 85..                 sta     zp:_Zp+1
    \ 0016 60                   rts
    \ 0000                      .section code,text
    \ 0000 a900     `?L1314`:   lda     #0
    \ 0002 85..                 sta     zp:_Zp+2
    \ 0004 85..                 sta     zp:_Zp+3
    \ 0006 20....               jsr     lcopy
    \ 0009 a001                 ldy     #1
    \ 000b 4c....               jmp     _IncVsp
    \ 0000                      .section code,text
    \ 0000          `?L1316`:
    \ 0000 b1..                 lda     (_Vsp),y
    \ 0002 85..                 sta     zp:_Zp
    \ 0004 c8                   iny
    \ 0005          `?L1317`:
    \ 0005 b1..                 lda     (_Vsp),y
    \ 0007 85..                 sta     zp:_Zp+1
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1318`:
    \ 0000 85..                 sta     zp:_Zp+1
    \ 0002 20....               jsr     mprintfd
    \ 0005 a6..                 ldx     zp:_Zp+26
    \ 0007 86..                 stx     zp:_Zp+4
    \ 0009 a900                 lda     #0
    \ 000b 85..                 sta     zp:_Zp+5
    \ 000d 85..                 sta     zp:_Zp+6
    \ 000f 85..                 sta     zp:_Zp+7
    \ 0011 a9..                 lda     #.byte0 `_StringLiteral_ Sector=`
    \ 0013 85..                 sta     zp:_Zp
    \ 0015 a9..                 lda     #.byte1 `_StringLiteral_ Sector=`
    \ 0017 85..                 sta     zp:_Zp+1
    \ 0019 20....               jsr     mprintfd
    \ 001c 4c....               jmp     cputlnd
    \ 0000                      .section code,text
    \ 0000          `?L1321`:
    \ 0000 cb....               asw     _Zp+2
    \ 0003 a5..                 lda     zp:_Zp+2
    \ 0005 85..                 sta     zp:_Zp
    \ 0007 cb....               asw     _Zp+2
    \ 000a a5..                 lda     zp:_Zp+2
    \ 000c 18                   clc
    \ 000d 65..                 adc     zp:_Zp
    \ 000f 85..                 sta     zp:_Zp
    \ 0011 a5..                 lda     zp:_Zp+26
    \ 0013 18                   clc
    \ 0014 6910                 adc     #16
    \ 0016 85..                 sta     zp:_Zp+2
    \ 0018 a5..                 lda     zp:_Zp+27
    \ 001a 6900     `?L1322`:   adc     #0
    \ 001c 85..                 sta     zp:_Zp+3
    \ 001e 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1323`:
    \ 0000 a5..                 lda     zp:_Zp+24
    \ 0002 85..                 sta     zp:_Zp
    \ 0004 a5..                 lda     zp:_Zp+25
    \ 0006 85..                 sta     zp:_Zp+1
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1324`:
    \ 0000 a5..                 lda     zp:_Zp+25
    \ 0002 85..                 sta     zp:_Zp+5
    \ 0004 a5..                 lda     zp:_Zp+24
    \ 0006 85..                 sta     zp:_Zp+4
    \ 0008 98                   tya
    \ 0009 85..                 sta     zp:_Zp+6
    \ 000b 85..                 sta     zp:_Zp+7
    \ 000d 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1325`:
    \ 0000 85..                 sta     zp:_Zp+1
    \ 0002 20....               jsr     mprintfd
    \ 0005 a6..                 ldx     zp:_Zp+25
    \ 0007 86..                 stx     zp:_Zp+4
    \ 0009 a900                 lda     #0
    \ 000b 85..                 sta     zp:_Zp+5
    \ 000d 85..                 sta     zp:_Zp+6
    \ 000f 85..                 sta     zp:_Zp+7
    \ 0011 a9..                 lda     #.byte0 `_StringLiteral_ Sector=`
    \ 0013 85..                 sta     zp:_Zp
    \ 0015 a9..                 lda     #.byte1 `_StringLiteral_ Sector=`
    \ 0017 85..                 sta     zp:_Zp+1
    \ 0019 20....               jsr     mprintfd
    \ 001c ad82d0               lda     0xd082
    \ 001f 85..                 sta     zp:_Zp+4
    \ 0021 a900                 lda     #0
    \ 0023 85..                 sta     zp:_Zp+5
    \ 0025 85..                 sta     zp:_Zp+6
    \ 0027 85..                 sta     zp:_Zp+7
    \ 0029 a9..                 lda     #.byte0 `_StringLiteral_ $d082U=`
    \ 002b 85..                 sta     zp:_Zp
    \ 002d a9..                 lda     #.byte1 `_StringLiteral_ $d082U=`
    \ 002f 85..                 sta     zp:_Zp+1
    \ 0031 20....               jsr     mhprintfd
    \ 0034 20....               jsr     cputlnd
    \ 0037 20....               jsr     cgetcd
    \ 003a a940                 lda     #64
    \ 003c 8d80d0               sta     0xd080
    \ 003f a902                 lda     #2
    \ 0041 20....               jsr     bordercolor
    \ 0044 a9ff                 lda     #-1
    \ 0046 60                   rts
    \ 0000                      .section code,text
    \ 0000 a9fe     `?L1332`:   lda     #-2
    \ 0002 20....               jsr     _DecVsp
    \ 0005 a001                 ldy     #1
    \ 0007 a902                 lda     #2
    \ 0009 91..                 sta     (_Vsp),y
    \ 000b 88                   dey
    \ 000c a900                 lda     #0
    \ 000e 91..                 sta     (_Vsp),y
    \ 0010 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1334`:
    \ 0000 92..                 sta     (_Zp),z
    \ 0002 a5..                 lda     zp:_Zp+2
    \ 0004 e6..                 inc     zp:_Zp+2
    \ 0006 4b                   taz
    \ 0007 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1335`:
    \ 0000 a5..                 lda     zp:_Zp+24
    \ 0002 85..                 sta     zp:_Zp
    \ 0004 c6..                 dec     zp:_Zp
    \ 0006 a5..                 lda     zp:_Zp
    \ 0008 8d84d0               sta     0xd084
    \ 000b a6..                 ldx     zp:_Zp+25
    \ 000d 86..                 stx     zp:_Zp
    \ 000f a900                 lda     #0
    \ 0011 85..                 sta     zp:_Zp+1
    \ 0013 a914                 lda     #20
    \ 0015 85..                 sta     zp:_Zp+10
    \ 0017 a900                 lda     #0
    \ 0019 85..                 sta     zp:_Zp+11
    \ 001b 20....               jsr     _DivMod16
    \ 001e a5..                 lda     zp:_Zp+2
    \ 0020 85..                 sta     zp:_Zp
    \ 0022 a5..                 lda     zp:_Zp+3
    \ 0024 85..                 sta     zp:_Zp+1
    \ 0026 a902                 lda     #2
    \ 0028 85..                 sta     zp:_Zp+10
    \ 002a a900                 lda     #0
    \ 002c 85..                 sta     zp:_Zp+11
    \ 002e 20....               jsr     _DivMod16
    \ 0031 e6..                 inc     zp:_Zp
    \ 0033 a5..                 lda     zp:_Zp
    \ 0035 8d85d0               sta     0xd085
    \ 0038 ab....               ldz     _Zp+25
    \ 003b c214                 cpz     #20
    \ 003d 60                   rts
    \ 0000                      .section code,text
    \ 0000 38       `?L1338`:   sec
    \ 0001 4242e5..             sbcq    zp:_Zp
    \ 0005          `?L1339`:
    \ 0005 424285..             stq     zp:_Zp
    \ 0009 a900     `?L1340`:   lda     #0
    \ 000b aa                   tax
    \ 000c a8                   tay
    \ 000d a308     `?L1341`:   ldz     #8
    \ 000f 18       `?L1342`:   clc
    \ 0010 424265..             adcq    zp:_Zp
    \ 0014 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1343`:
    \ 0000 85..                 sta     zp:_Zp+2
    \ 0002 a5..                 lda     zp:_Zp+27
    \ 0004 85..                 sta     zp:_Zp+1
    \ 0006 a5..                 lda     zp:_Zp+28
    \ 0008 85..                 sta     zp:_Zp
    \ 000a a5..                 lda     zp:_Zp+29
    \ 000c 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1344`:
    \ 0000 85..                 sta     zp:_Zp+2
    \ 0002 ad....               lda     worksectorasBAM
    \ 0005 85..                 sta     zp:_Zp
    \ 0007 ad....               lda     worksectorasBAM+1
    \ 000a 85..                 sta     zp:_Zp+1
    \ 000c 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1345`:
    \ 0000 a6..                 ldx     zp:_Zp+29
    \ 0002 86..                 stx     zp:_Zp
    \ 0004 a900     `?L1346`:   lda     #0
    \ 0006          `?L1347`:
    \ 0006 85..                 sta     zp:_Zp+1
    \ 0008 a905                 lda     #5
    \ 000a aa                   tax
    \ 000b 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1348`:
    \ 0000 20....               jsr     clrhomed
    \ 0003 a6..                 ldx     zp:_Zp+27
    \ 0005 86..                 stx     zp:_Zp+4
    \ 0007 a900                 lda     #0
    \ 0009 85..                 sta     zp:_Zp+5
    \ 000b 85..                 sta     zp:_Zp+6
    \ 000d 85..                 sta     zp:_Zp+7
    \ 000f 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1350`:
    \ 0000 424206..             aslq    zp:_Zp+4
    \ 0004 ca                   dex
    \ 0005 60                   rts
    \ 0000                      .section code,text
    \ 0000 a019     `?L1351`:   ldy     #25
    \ 0002 b1..                 lda     (_Vsp),y
    \ 0004 85..                 sta     zp:_Zp+6
    \ 0006 88                   dey
    \ 0007 b1..                 lda     (_Vsp),y
    \ 0009 85..                 sta     zp:_Zp+5
    \ 000b a00a                 ldy     #10
    \ 000d b1..                 lda     (_Vsp),y
    \ 000f 85..                 sta     zp:_Zp+4
    \ 0011 a2..                 ldx     #_Zp+2
    \ 0013 a90b                 lda     #11
    \ 0015 20....               jsr     _LoadVspEA
    \ 0018 a2..                 ldx     #_Zp
    \ 001a a910                 lda     #16
    \ 001c 20....               jsr     _LoadVspEA
    \ 001f a017                 ldy     #23
    \ 0021 b1..                 lda     (_Vsp),y
    \ 0023 4c....               jmp     findnextBAMtracksector
    \ 0000                      .section code,text
    \ 0000          `?L1354`:
    \ 0000 a5..                 lda     zp:_Zp+25
    \ 0002 85..                 sta     zp:_Zp+1
    \ 0004 a5..                 lda     zp:_Zp+24
    \ 0006 85..                 sta     zp:_Zp
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1355`:
    \ 0000 85..                 sta     zp:_Zp+11
    \ 0002 a5..                 lda     zp:_Zp+9
    \ 0004 85..                 sta     zp:_Zp+10
    \ 0006 a5..                 lda     zp:_Zp+8
    \ 0008 85..                 sta     zp:_Zp+9
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1356`:
    \ 0000 e3..                 inw     zp:_Zp+6
    \ 0002 e3..                 inw     zp:_Zp+6
    \ 0004          `?L1357`:
    \ 0004 a5..                 lda     zp:_Zp+5
    \ 0006 85..                 sta     zp:_Zp
    \ 0008 a5..                 lda     zp:_Zp+4
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1358`:
    \ 0000 a5..                 lda     zp:_Zp
    \ 0002 91..                 sta     (_Vsp),y
    \ 0004 c8                   iny
    \ 0005 a5..                 lda     zp:_Zp+1
    \ 0007 91..                 sta     (_Vsp),y
    \ 0009 c8                   iny
    \ 000a a5..                 lda     zp:_Zp+2
    \ 000c 91..                 sta     (_Vsp),y
    \ 000e c8                   iny
    \ 000f a5..                 lda     zp:_Zp+3
    \ 0011 91..                 sta     (_Vsp),y
    \ 0013 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1359`:
    \ 0000 85..                 sta     zp:_Zp+3
    \ 0002 a5..                 lda     zp:_Zp+1
    \ 0004 85..                 sta     zp:_Zp+2
    \ 0006 a5..                 lda     zp:_Zp
    \ 0008 85..                 sta     zp:_Zp+1
    \ 000a 98                   tya
    \ 000b 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1360`:
    \ 0000 a5..                 lda     zp:_Zp+6
    \ 0002 18                   clc
    \ 0003 69..                 adc     #.byte0 s
    \ 0005 85..                 sta     zp:_Zp
    \ 0007 a5..                 lda     zp:_Zp+7
    \ 0009 69..                 adc     #.byte1 s
    \ 000b 85..                 sta     zp:_Zp+1
    \ 000d 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1361`:
    \ 0000 85..                 sta     zp:_Zp+3
    \ 0002 a5..                 lda     zp:_Zp+27
    \ 0004 85..                 sta     zp:_Zp+2
    \ 0006 ad....               lda     BAMsector
    \ 0009 85..                 sta     zp:_Zp
    \ 000b ad....               lda     BAMsector+1
    \ 000e 85..                 sta     zp:_Zp+1
    \ 0010 a5..                 lda     zp:_Zp+28
    \ 0012 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1362`:
    \ 0000 85..                 sta     zp:_Zp+3
    \ 0002 a5..                 lda     zp:_Zp+27
    \ 0004 85..                 sta     zp:_Zp+2
    \ 0006 ad....               lda     BAMsector+2
    \ 0009 85..                 sta     zp:_Zp
    \ 000b ad....               lda     BAMsector+3
    \ 000e 85..                 sta     zp:_Zp+1
    \ 0010 a5..                 lda     zp:_Zp+28
    \ 0012 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1363`:
    \ 0000 a6..                 ldx     zp:_Zp+8
    \ 0002 86..                 stx     zp:_Zp+4
    \ 0004 6b                   tza
    \ 0005 85..                 sta     zp:_Zp+5
    \ 0007 cb....               asw     _Zp+4
    \ 000a a5..                 lda     zp:_Zp+4
    \ 000c 85..                 sta     zp:_Zp
    \ 000e cb....               asw     _Zp+4
    \ 0011 a5..                 lda     zp:_Zp+4
    \ 0013 18                   clc
    \ 0014 65..                 adc     zp:_Zp
    \ 0016 85..                 sta     zp:_Zp
    \ 0018 a5..                 lda     zp:_Zp+2
    \ 001a 18                   clc
    \ 001b 6910                 adc     #16
    \ 001d 85..                 sta     zp:_Zp+2
    \ 001f a5..                 lda     zp:_Zp+3
    \ 0021 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1364`:
    \ 0000 91..                 sta     (_Zp),y
    \ 0002 a5..                 lda     zp:_Zp+4
    \ 0004 85..                 sta     zp:_Zp+6
    \ 0006 a5..                 lda     zp:_Zp+5
    \ 0008 85..                 sta     zp:_Zp+7
    \ 000a e3..                 inw     zp:_Zp+4
    \ 000c a6..                 ldx     zp:_Zp+12
    \ 000e 86..                 stx     zp:_Zp
    \ 0010 85..                 sta     zp:_Zp+1
    \ 0012 a90a                 lda     #10
    \ 0014 85..                 sta     zp:_Zp+10
    \ 0016 a900                 lda     #0
    \ 0018 85..                 sta     zp:_Zp+11
    \ 001a 20....               jsr     _DivMod16
    \ 001d a930                 lda     #48
    \ 001f 18                   clc
    \ 0020 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1366`:
    \ 0000 91..                 sta     (_Zp),y
    \ 0002 a5..                 lda     zp:_Zp+4
    \ 0004 85..                 sta     zp:_Zp+6
    \ 0006 a5..                 lda     zp:_Zp+5
    \ 0008 85..                 sta     zp:_Zp+7
    \ 000a e3..                 inw     zp:_Zp+4
    \ 000c a6..                 ldx     zp:_Zp+13
    \ 000e 86..                 stx     zp:_Zp
    \ 0010 85..                 sta     zp:_Zp+1
    \ 0012 a90a                 lda     #10
    \ 0014 85..                 sta     zp:_Zp+10
    \ 0016 a900                 lda     #0
    \ 0018 85..                 sta     zp:_Zp+11
    \ 001a 20....               jsr     _DivMod16
    \ 001d a930                 lda     #48
    \ 001f 18                   clc
    \ 0020 60                   rts
    \ 0000                      .section code,text
    \ 0000 a0fd     `?L1368`:   ldy     #253
    \ 0002 a30f                 ldz     #15
    \ 0004 424285..             stq     zp:_Zp
    \ 0008 20....               jsr     lcopy
    \ 000b a001                 ldy     #1
    \ 000d 4c....               jmp     _IncVsp
    \ 0000                      .section code,text
    \ 0000          `?L1370`:
    \ 0000 a6..                 ldx     zp:_Zp
    \ 0002 86..                 stx     zp:_Zp+24
    \ 0004 a6..                 ldx     zp:_Zp+1
    \ 0006 86..                 stx     zp:_Zp+25
    \ 0008 a6..                 ldx     zp:_Zp+4
    \ 000a 86..                 stx     zp:_Zp+2
    \ 000c a6..                 ldx     zp:_Zp+3
    \ 000e 86..                 stx     zp:_Zp+1
    \ 0010 a6..                 ldx     zp:_Zp+5
    \ 0012 86..                 stx     zp:_Zp
    \ 0014 20....               jsr     ReadSector
    \ 0017 85..                 sta     zp:_Zp+26
    \ 0019 a301                 ldz     #1
    \ 001b d4..                 cpz     zp:_Zp+26
    \ 001d 60                   rts
    \ 0000                      .section code,text
    \ 0000 a200     `?L1372`:   ldx     #0
    \ 0002 a002                 ldy     #2
    \ 0004 4c....               jmp     _AllocStackSave
    \ 0000                      .section code,text
    \ 0000          `?L1373`:
    \ 0000 a6..                 ldx     zp:_Zp+13
    \ 0002 86..                 stx     zp:_Zp
    \ 0004 ca                   dex
    \ 0005 86..                 stx     zp:_Zp+1
    \ 0007 a5..                 lda     zp:_Zp+10
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1374`:
    \ 0000 a6..                 ldx     zp:_Zp+6
    \ 0002 86..                 stx     zp:_Zp+2
    \ 0004 ca                   dex
    \ 0005 86..                 stx     zp:_Zp+3
    \ 0007 a5..                 lda     zp:_Zp
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1375`:
    \ 0000 a5..                 lda     zp:_Zp
    \ 0002 85..                 sta     zp:_Zp+4
    \ 0004 a5..                 lda     zp:_Zp+1
    \ 0006 85..                 sta     zp:_Zp+5
    \ 0008 e3..                 inw     zp:_Zp+4
    \ 000a e3..                 inw     zp:_Zp+4
    \ 000c e3..                 inw     zp:_Zp+4
    \ 000e e3..                 inw     zp:_Zp+4
    \ 0010 18                   clc
    \ 0011 a5..                 lda     zp:_Zp+4
    \ 0013 65..                 adc     zp:_Zp+2
    \ 0015 85..                 sta     zp:_Zp+4
    \ 0017 60                   rts
    \ 0000                      .section code,text
    \ 0000 a200     `?L1376`:   ldx     #0
    \ 0002 a006                 ldy     #6
    \ 0004 20....               jsr     _AllocStackSave
    \ 0007 85..                 sta     zp:_Zp+29
    \ 0009 a5..                 lda     zp:_Zp+2
    \ 000b 85..                 sta     zp:_Zp+28
    \ 000d a5..                 lda     zp:_Zp+3
    \ 000f 85..                 sta     zp:_Zp+27
    \ 0011 a5..                 lda     zp:_Zp+4
    \ 0013 85..                 sta     zp:_Zp+26
    \ 0015 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1378`:
    \ 0000 cb....               asw     _Zp
    \ 0003 ca                   dex
    \ 0004 60                   rts
    \ 0000                      .section code,text
    \ 0000 88       `?L1379`:   dey
    \ 0001 91..                 sta     (_Vsp),y
    \ 0003 a9..                 lda     #.byte0 `_StringLiteral_ `
    \ 0005 85..                 sta     zp:_Zp+4
    \ 0007 a9..                 lda     #.byte1 `_StringLiteral_ `
    \ 0009 85..                 sta     zp:_Zp+5
    \ 000b 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1380`:
    \ 0000 a5..                 lda     zp:_Zp+2
    \ 0002 85..                 sta     zp:_Zp+24
    \ 0004 a5..                 lda     zp:_Zp+3
    \ 0006 85..                 sta     zp:_Zp+25
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1381`:
    \ 0000 ad....               lda     worksector
    \ 0003 85..                 sta     zp:_Zp+24
    \ 0005 ad....               lda     worksector+1
    \ 0008 85..                 sta     zp:_Zp+25
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1382`:
    \ 0000 85..                 sta     zp:_Zp+3
    \ 0002 a9..                 lda     #.byte0 `_StringLiteral_Writing...`
    \ 0004 85..                 sta     zp:_Zp
    \ 0006 a9..                 lda     #.byte1 `_StringLiteral_Writing...`
    \ 0008 85..                 sta     zp:_Zp+1
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000 a00f     `?L1383`:   ldy     #15
    \ 0002 b1..                 lda     (_Vsp),y
    \ 0004 85..                 sta     zp:_Zp+4
    \ 0006 88                   dey
    \ 0007 b1..                 lda     (_Vsp),y
    \ 0009 85..                 sta     zp:_Zp+3
    \ 000b a005                 ldy     #5
    \ 000d          `?L1384`:
    \ 000d b1..                 lda     (_Vsp),y
    \ 000f 85..                 sta     zp:_Zp+2
    \ 0011 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1385`:
    \ 0000 20....               jsr     GetOneSector
    \ 0003 85..                 sta     zp:_Zp
    \ 0005 a301                 ldz     #1
    \ 0007 d4..                 cpz     zp:_Zp
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1387`:
    \ 0000 a5..                 lda     zp:_Zp
    \ 0002 85..                 sta     zp:_Zp+26
    \ 0004 a5..                 lda     zp:_Zp+1
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000 a900     `?L1388`:   lda     #0
    \ 0002 85..                 sta     zp:_Zp+8
    \ 0004 4242a5..             ldq     zp:_Zp+8
    \ 0008 424285..             stq     zp:_Zp+12
    \ 000c a905                 lda     #5
    \ 000e aa                   tax
    \ 000f 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1389`:
    \ 0000 85..                 sta     zp:_Zp+1
    \ 0002 85..                 sta     zp:_Zp+2
    \ 0004 85..                 sta     zp:_Zp+3
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1390`:
    \ 0000 b2..                 lda     (_Vsp),z
    \ 0002 85..                 sta     zp:_Zp
    \ 0004 1b                   inz
    \ 0005 b2..                 lda     (_Vsp),z
    \ 0007 85..                 sta     zp:_Zp+1
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1391`:
    \ 0000 20....               jsr     messagebox
    \ 0003 a003                 ldy     #3
    \ 0005 4c....               jmp     _IncVsp
    \ 0000                      .section code,text
    \ 0000 98       `?L1393`:   tya
    \ 0001 85..                 sta     zp:_Zp+9
    \ 0003 b1..                 lda     (_Zp+6),y
    \ 0005 85..                 sta     zp:_Zp+10
    \ 0007 38                   sec
    \ 0008 a5..                 lda     zp:_Zp+8
    \ 000a e5..                 sbc     zp:_Zp+10
    \ 000c 85..                 sta     zp:_Zp+8
    \ 000e 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1394`:
    \ 0000 a5..                 lda     zp:_Zp
    \ 0002 85..                 sta     zp:_Zp+24
    \ 0004 a5..                 lda     zp:_Zp+1
    \ 0006 85..                 sta     zp:_Zp+25
    \ 0008 a901                 lda     #1
    \ 000a 25..                 and     zp:_Zp+26
    \ 000c 85..                 sta     zp:_Zp+30
    \ 000e 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1395`:
    \ 0000 20....               jsr     _AllocStackSave
    \ 0003 85..                 sta     zp:_Zp+28
    \ 0005 a5..                 lda     zp:_Zp
    \ 0007 85..                 sta     zp:_Zp+27
    \ 0009 a5..                 lda     zp:_Zp+1
    \ 000b 85..                 sta     zp:_Zp+26
    \ 000d 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1397`:
    \ 0000 20....               jsr     _LoadVspEA
    \ 0003 88                   dey
    \ 0004 a5..                 lda     zp:_Zp+5
    \ 0006 91..                 sta     (_Vsp),y
    \ 0008 88                   dey
    \ 0009 a5..                 lda     zp:_Zp+4
    \ 000b 91..                 sta     (_Vsp),y
    \ 000d 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1399`:
    \ 0000 a5..                 lda     zp:_Zp+26
    \ 0002 85..                 sta     zp:_Zp
    \ 0004 a5..                 lda     zp:_Zp+27
    \ 0006 85..                 sta     zp:_Zp+1
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1400`:
    \ 0000 a5..                 lda     zp:_Zp+27
    \ 0002 85..                 sta     zp:_Zp+5
    \ 0004 a5..                 lda     zp:_Zp+26
    \ 0006 85..                 sta     zp:_Zp+4
    \ 0008 98                   tya
    \ 0009 85..                 sta     zp:_Zp+6
    \ 000b 85..                 sta     zp:_Zp+7
    \ 000d 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1401`:
    \ 0000 a5..                 lda     zp:_Zp+28
    \ 0002 18                   clc
    \ 0003 6908                 adc     #8
    \ 0005 85..                 sta     zp:_Zp+28
    \ 0007 a5..                 lda     zp:_Zp+29
    \ 0009 6900                 adc     #0
    \ 000b 85..                 sta     zp:_Zp+29
    \ 000d 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1402`:
    \ 0000 20....               jsr     cgetcd
    \ 0003 a5..                 lda     zp:_Zp+26
    \ 0005 38                   sec
    \ 0006 e5..                 sbc     zp:_Zp+30
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1404`:
    \ 0000 e3..                 inw     zp:_Zp+4
    \ 0002          `?L1405`:
    \ 0002 e3..                 inw     zp:_Zp+4
    \ 0004 a000     `?L1406`:   ldy     #0
    \ 0006 b1..                 lda     (_Zp+4),y
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1407`:
    \ 0000 a5..                 lda     zp:_Zp+30
    \ 0002 38                   sec
    \ 0003 e929                 sbc     #41
    \ 0005 85..                 sta     zp:_Zp+2
    \ 0007 a900                 lda     #0
    \ 0009 e900                 sbc     #0
    \ 000b 85..                 sta     zp:_Zp+3
    \ 000d 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1408`:
    \ 0000 e3..                 inw     zp:_Zp+2
    \ 0002 e3..                 inw     zp:_Zp+2
    \ 0004 a9ff                 lda     #-1
    \ 0006 91..                 sta     (_Zp+2),y
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1409`:
    \ 0000 e3..                 inw     zp:_Zp+2
    \ 0002 a000                 ldy     #0
    \ 0004 b1..                 lda     (_Zp+2),y
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1410`:
    \ 0000 b1..                 lda     (_Vsp),y
    \ 0002 a000                 ldy     #0
    \ 0004 91..                 sta     (_Zp),y
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000 a920     `?L1411`:   lda     #32
    \ 0002 18                   clc
    \ 0003 65..                 adc     zp:_Zp+26
    \ 0005 85..                 sta     zp:_Zp+4
    \ 0007 ab....               ldz     _Zp+25
    \ 000a c214                 cpz     #20
    \ 000c 60                   rts
    \ 0000                      .section code,text
    \ 0000 a920     `?L1412`:   lda     #32
    \ 0002 91..                 sta     (_Vsp),y
    \ 0004 60                   rts
    \ 0000                      .section code,text
    \ 0000 a928     `?L1413`:   lda     #40
    \ 0002 85..                 sta     zp:_Zp+10
    \ 0004 a900                 lda     #0
    \ 0006 85..                 sta     zp:_Zp+11
    \ 0008 4c....               jmp     _UDivMod16
    \ 0000                      .section code,text
    \ 0000 a9ff     `?L1414`:   lda     #-1
    \ 0002 20....               jsr     _DecVsp
    \ 0005 a901                 lda     #1
    \ 0007 a000                 ldy     #0
    \ 0009 91..                 sta     (_Vsp),y
    \ 000b 60                   rts
    \ 0000                      .section code,text
    \ 0000 a900     `?L1416`:   lda     #0
    \ 0002 85..                 sta     zp:_Zp+4
    \ 0004 60                   rts
    \ 0000                      .section code,text
    \ 0000 a00a     `?L1417`:   ldy     #10
    \ 0002 a5..                 lda     zp:_Zp+2
    \ 0004 91..                 sta     (_Vsp),y
    \ 0006 c8                   iny
    \ 0007 a5..                 lda     zp:_Zp+3
    \ 0009 91..                 sta     (_Vsp),y
    \ 000b 60                   rts
    \ 0000                      .section code,text
    \ 0000 a9fc     `?L1418`:   lda     #-4
    \ 0002 20....               jsr     _DecVsp
    \ 0005 a003                 ldy     #3
    \ 0007 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1420`:
    \ 0000 a5..                 lda     zp:_Zp+1
    \ 0002 097f                 ora     #127
    \ 0004 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1421`:
    \ 0000 a5..                 lda     zp:_Zp+4
    \ 0002 85..                 sta     zp:_Zp
    \ 0004 a5..                 lda     zp:_Zp+5
    \ 0006 85..                 sta     zp:_Zp+1
    \ 0008 a5..                 lda     zp:_Zp
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1422`:
    \ 0000 a5..                 lda     zp:_Zp+4
    \ 0002 8d80d0               sta     0xd080
    \ 0005 a6..                 ldx     zp:_Zp+4
    \ 0007 ec....               cpx     lastdrive
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1423`:
    \ 0000 ad....               lda     BAMsector
    \ 0003 85..                 sta     zp:_Zp+24
    \ 0005 ad....               lda     BAMsector+1
    \ 0008 85..                 sta     zp:_Zp+25
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000 a980     `?L1424`:   lda     #-128
    \ 0002 1c89d6               trb     0xd689
    \ 0005 a5..                 lda     zp:_Zp+4
    \ 0007 8d....               sta     lastdrive
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1425`:
    \ 0000 85..                 sta     zp:_Zp+3
    \ 0002 e3..                 inw     zp:_Zp+2
    \ 0004 e3..                 inw     zp:_Zp+2
    \ 0006 e3..                 inw     zp:_Zp+2
    \ 0008 e3..                 inw     zp:_Zp+2
    \ 000a 60                   rts
    \ 0000                      .section code,text
    \ 0000 18       `?L1426`:   clc
    \ 0001 a9c0                 lda     #192
    \ 0003 6d....               adc     readdir_dirent
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1427`:
    \ 0000 20....               jsr     _AllocStackSave
    \ 0003 85..                 sta     zp:_Zp+32
    \ 0005 a5..                 lda     zp:_Zp
    \ 0007 85..                 sta     zp:_Zp+31
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1429`:
    \ 0000 20....               jsr     readblockchain
    \ 0003 a000                 ldy     #0
    \ 0005 4c....               jmp     _IncVsp
    \ 0000                      .section code,text
    \ 0000          `?L1431`:
    \ 0000 a5..                 lda     zp:_Zp+4
    \ 0002 91..                 sta     (_Vsp),y
    \ 0004 c8                   iny
    \ 0005 a5..                 lda     zp:_Zp+5
    \ 0007 91..                 sta     (_Vsp),y
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1432`:
    \ 0000 a5..                 lda     zp:_Zp+6
    \ 0002 91..                 sta     (_Vsp),y
    \ 0004 c8                   iny
    \ 0005 a5..                 lda     zp:_Zp+7
    \ 0007 91..                 sta     (_Vsp),y
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000 a901     `?L1433`:   lda     #1
    \ 0002 2c....               bit     option
    \ 0005 60                   rts
    \ 0000                      .section code,text
    \ 0000 a006     `?L1434`:   ldy     #6
    \ 0002 20....               jsr     _AllocStackSave
    \ 0005 85..                 sta     zp:_Zp+30
    \ 0007 a5..                 lda     zp:_Zp
    \ 0009 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1436`:
    \ 0000 a5..                 lda     zp:_Zp
    \ 0002 85..                 sta     zp:_Zp+2
    \ 0004 a5..                 lda     zp:_Zp+1
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1437`:
    \ 0000 85..                 sta     zp:_Zp+3
    \ 0002 a007                 ldy     #7
    \ 0004 b1..                 lda     (_Vsp),y
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000 a00b     `?L1438`:   ldy     #11
    \ 0002          `?L1439`:
    \ 0002 b1..                 lda     (_Vsp),y
    \ 0004 85..                 sta     zp:_Zp
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000 4a       `?L1440`:   lsr     a
    \ 0001 4a                   lsr     a
    \ 0002 4a                   lsr     a
    \ 0003 85..                 sta     zp:_Zp+8
    \ 0005 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1441`:
    \ 0000 86..                 stx     zp:_Zp+8
    \ 0002 a900                 lda     #0
    \ 0004 85..                 sta     zp:_Zp+9
    \ 0006 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1442`:
    \ 0000 a5..                 lda     zp:_Vsp
    \ 0002 85..                 sta     zp:_Zp
    \ 0004 a5..                 lda     zp:_Vsp+1
    \ 0006 85..                 sta     zp:_Zp+1
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1443`:
    \ 0000 a5..                 lda     zp:_Zp+28
    \ 0002 85..                 sta     zp:_Zp
    \ 0004 a5..                 lda     zp:_Zp+29
    \ 0006 85..                 sta     zp:_Zp+1
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000          `?L1444`:
    \ 0000 a5..                 lda     zp:_Zp+30
    \ 0002 4c....               jmp     PutOneSector
    \ 0000                      .section code,text
    \ 0000          `?L1445`:
    \ 0000 a5..                 lda     zp:_Zp+32
    \ 0002 4c....               jmp     PutWholeSector
    \ 0000                      .section code,text
    \ 0000          `?L1446`:
    \ 0000 a5..                 lda     zp:_Zp+8
    \ 0002 c5..                 cmp     zp:_Zp+10
    \ 0004 a5..                 lda     zp:_Zp+9
    \ 0006 e5..                 sbc     zp:_Zp+11
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000 a901     `?L1447`:   lda     #1
    \ 0002 85..                 sta     zp:_Zp+5
    \ 0004 60                   rts
    \ 0000                      .section code,text
    \ 0000 a902     `?L1448`:   lda     #2
    \ 0002 85..                 sta     zp:_Zp+4
    \ 0004 a900                 lda     #0
    \ 0006 85..                 sta     zp:_Zp+5
    \ 0008 60                   rts
    \ 0000                      .section code,text
    \ 0000 a920     `?L1449`:   lda     #32
    \ 0002 4c....               jmp     cputc
    \ 0000                      .section code,text
    \ 0000          `?L1450`:
    \ 0000 85..                 sta     zp:_Zp+2
    \ 0002 85..                 sta     zp:_Zp+3
    \ 0004 4c....               jmp     lfill
    \ 0000                      .section code,text
    \ 0000          `?L1451`:
    \ 0000 a6..                 ldx     zp:_Zp+30
    \ 0002 86..                 stx     zp:_Zp+2
    \ 0004 a900     `?L1452`:   lda     #0
    \ 0006 85..                 sta     zp:_Zp+3
    \ 0008 60                   rts
    \ 0000                      .section zdata,bss
    \ 0000                      .public direntflags
    \ 0000          direntflags:
    \ 0000                      .space  0x1f0
    \ 0000                      .section zdata,bss
    \ 0000                      .public option
    \ 0000          option:     .space  1
    \ 0000                      .section switch,rodata
    \ 0000 ....     `?L623`:    .word   `?L466`
    \ 0002 ....                 .word   `?L465`
    \ 0004 ....                 .word   `?L464`
    \ 0006 ....                 .word   `?L463`
    \ 0008 ....                 .word   `?L462`
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_ `
    \ 0000          `_StringLiteral_ `:
    \ 0000 2000                 .byte   32,0
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_ $d082U=`
    \ 0000          `_StringLiteral_ $d082U=`:
    \ 0000 20246430             .byte   32,36,100,48,56,50,85,61,0
    \ 0004 3832553d
    \ 0008 00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_ D`
    \ 0000          `_StringLiteral_ D`:
    \ 0000 204400               .byte   32,68,0
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_ Sector=`
    \ 0000          `_StringLiteral_ Sector=`:
    \ 0000 20536563             .byte   32,83,101,99,116,111,114,61,0
    \ 0004 746f723d
    \ 0008 00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_BAM/header`
    \ 0000          `_StringLiteral_BAM/header`:
    \ 0000 42414d2f             .byte   66,65,77,47,104,101,97,100,101,114,0
    \ 0004 68656164
    \ 0008 657200
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_PutOneSector before lower buffer. Track=`
    \ 0000          `_StringLiteral_PutOneSector before lower buffer. Track=`:
    \ 0000 5075744f             .byte   80,117,116,79,110,101,83,101,99,116,111,114,32,98,101,102,111,114,101,32,108,111,119,101,114,32,98,117,102,102,101,114,46,32,84,114,97,99,107,61,0
    \ 0004 6e655365
    \ 0008 63746f72
    \ 000c 20626566
    \ 0010 6f726520
    \ 0014 6c6f7765
    \ 0018 72206275
    \ 001c 66666572
    \ 0020 2e205472
    \ 0024 61636b3d
    \ 0028 00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_PutOneSector before upper buffer. Track=`
    \ 0000          `_StringLiteral_PutOneSector before upper buffer. Track=`:
    \ 0000 5075744f             .byte   80,117,116,79,110,101,83,101,99,116,111,114,32,98,101,102,111,114,101,32,117,112,112,101,114,32,98,117,102,102,101,114,46,32,84,114,97,99,107,61,0
    \ 0004 6e655365
    \ 0008 63746f72
    \ 000c 20626566
    \ 0010 6f726520
    \ 0014 75707065
    \ 0018 72206275
    \ 001c 66666572
    \ 0020 2e205472
    \ 0024 61636b3d
    \ 0028 00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_PutOneSector done. Returning while WriteSector.`
    \ 0000          `_StringLiteral_PutOneSector done. Returning while WriteSector.`:
    \ 0000 5075744f             .byte   80,117,116,79,110,101,83,101,99,116,111,114,32,100,111,110,101,46,32,82,101,116,117,114,110,105,110,103,32,119,104,105,108,101,32,87,114,105,116,101,83,101,99,116,111,114,46,0
    \ 0004 6e655365
    \ 0008 63746f72
    \ 000c 20646f6e
    \ 0010 652e2052
    \ 0014 65747572
    \ 0018 6e696e67
    \ 001c 20776869
    \ 0020 6c652057
    \ 0024 72697465
    \ 0028 53656374
    \ 002c 6f722e00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_PutWholeSector before lower buffer. Track=`
    \ 0000          `_StringLiteral_PutWholeSector before lower buffer. Track=`:
    \ 0000 50757457             .byte   80,117,116,87,104,111,108,101,83,101,99,116,111,114,32,98,101,102,111,114,101,32,108,111,119,101,114,32,98,117,102,102,101,114,46,32,84,114,97,99,107,61,0
    \ 0004 686f6c65
    \ 0008 53656374
    \ 000c 6f722062
    \ 0010 65666f72
    \ 0014 65206c6f
    \ 0018 77657220
    \ 001c 62756666
    \ 0020 65722e20
    \ 0024 54726163
    \ 0028 6b3d00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_PutWholeSector before upper buffer. Track=`
    \ 0000          `_StringLiteral_PutWholeSector before upper buffer. Track=`:
    \ 0000 50757457             .byte   80,117,116,87,104,111,108,101,83,101,99,116,111,114,32,98,101,102,111,114,101,32,117,112,112,101,114,32,98,117,102,102,101,114,46,32,84,114,97,99,107,61,0
    \ 0004 686f6c65
    \ 0008 53656374
    \ 000c 6f722062
    \ 0010 65666f72
    \ 0014 65207570
    \ 0018 70657220
    \ 001c 62756666
    \ 0020 65722e20
    \ 0024 54726163
    \ 0028 6b3d00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_PutWholeSector done. Returning while WriteSector.`
    \ 0000          `_StringLiteral_PutWholeSector done. Returning while WriteSector.`:
    \ 0000 50757457             .byte   80,117,116,87,104,111,108,101,83,101,99,116,111,114,32,100,111,110,101,46,32,82,101,116,117,114,110,105,110,103,32,119,104,105,108,101,32,87,114,105,116,101,83,101,99,116,111,114,46,0
    \ 0004 686f6c65
    \ 0008 53656374
    \ 000c 6f722064
    \ 0010 6f6e652e
    \ 0014 20526574
    \ 0018 75726e69
    \ 001c 6e672077
    \ 0020 68696c65
    \ 0024 20577269
    \ 0028 74655365
    \ 002c 63746f72
    \ 0030 2e00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_ReadSector. Track=`
    \ 0000          `_StringLiteral_ReadSector. Track=`:
    \ 0000 52656164             .byte   82,101,97,100,83,101,99,116,111,114,46,32,84,114,97,99,107,61,0
    \ 0004 53656374
    \ 0008 6f722e20
    \ 000c 54726163
    \ 0010 6b3d00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_Reading...`
    \ 0000          `_StringLiteral_Reading...`:
    \ 0000 52656164             .byte   82,101,97,100,105,110,103,46,46,46,0
    \ 0004 696e672e
    \ 0008 2e2e00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_Renaming subpartition,`
    \ 0000          `_StringLiteral_Renaming subpartition,`:
    \ 0000 52656e61             .byte   82,101,110,97,109,105,110,103,32,115,117,98,112,97,114,116,105,116,105,111,110,44,0
    \ 0004 6d696e67
    \ 0008 20737562
    \ 000c 70617274
    \ 0010 6974696f
    \ 0014 6e2c00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_Updating directory,`
    \ 0000          `_StringLiteral_Updating directory,`:
    \ 0000 55706461             .byte   85,112,100,97,116,105,110,103,32,100,105,114,101,99,116,111,114,121,44,0
    \ 0004 74696e67
    \ 0008 20646972
    \ 000c 6563746f
    \ 0010 72792c00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_WriteSector. Track=`
    \ 0000          `_StringLiteral_WriteSector. Track=`:
    \ 0000 57726974             .byte   87,114,105,116,101,83,101,99,116,111,114,46,32,84,114,97,99,107,61,0
    \ 0004 65536563
    \ 0008 746f722e
    \ 000c 20547261
    \ 0010 636b3d00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_Writing file,`
    \ 0000          `_StringLiteral_Writing file,`:
    \ 0000 57726974             .byte   87,114,105,116,105,110,103,32,102,105,108,101,44,0
    \ 0004 696e6720
    \ 0008 66696c65
    \ 000c 2c00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_Writing...`
    \ 0000          `_StringLiteral_Writing...`:
    \ 0000 57726974             .byte   87,114,105,116,105,110,103,46,46,46,0
    \ 0004 696e672e
    \ 0008 2e2e00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral__miniinit SECTBUF 32addr is: `
    \ 0000          `_StringLiteral__miniinit SECTBUF 32addr is: `:
    \ 0000 5f6d696e             .byte   95,109,105,110,105,105,110,105,116,32,83,69,67,84,66,85,70,32,51,50,97,100,100,114,32,105,115,58,32,0
    \ 0004 69696e69
    \ 0008 74205345
    \ 000c 43544255
    \ 0010 46203332
    \ 0014 61646472
    \ 0018 2069733a
    \ 001c 2000
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_directory/BAM`
    \ 0000          `_StringLiteral_directory/BAM`:
    \ 0000 64697265             .byte   100,105,114,101,99,116,111,114,121,47,66,65,77,0
    \ 0004 63746f72
    \ 0008 792f4241
    \ 000c 4d00
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_fatal error`
    \ 0000          `_StringLiteral_fatal error`:
    \ 0000 66617461             .byte   102,97,116,97,108,32,101,114,114,111,114,0
    \ 0004 6c206572
    \ 0008 726f7200
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak _StringLiteral_max
    \ 0000          _StringLiteral_max:
    \ 0000 6d617800             .byte   109,97,120,0
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_number of sectors too big`
    \ 0000          `_StringLiteral_number of sectors too big`:
    \ 0000 6e756d62             .byte   110,117,109,98,101,114,32,111,102,32,115,101,99,116,111,114,115,32,116,111,111,32,98,105,103,0
    \ 0004 6572206f
    \ 0008 66207365
    \ 000c 63746f72
    \ 0010 7320746f
    \ 0014 6f206269
    \ 0018 6700
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_read error`
    \ 0000          `_StringLiteral_read error`:
    \ 0000 72656164             .byte   114,101,97,100,32,101,114,114,111,114,0
    \ 0004 20657272
    \ 0008 6f7200
    \ 0000                      .section cdata,rodata
    \ 0000                      .pubweak `_StringLiteral_write error`
    \ 0000          `_StringLiteral_write error`:
    \ 0000 77726974             .byte   119,114,105,116,101,32,101,114,114,111,114,0
    \ 0004 65206572
    \ 0008 726f7200

##########################
#                        #
# Memory sizes (decimal) #
#                        #
##########################

Executable        (Text): 9976 bytes
Zero initialized   (BSS):  519 bytes
Data                    :   12 bytes
Constant                :  617 bytes
